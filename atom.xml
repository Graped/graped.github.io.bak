<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>DInG_BloG</title>
  <subtitle>静以志远</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2017-05-08T11:52:31.817Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>DInG</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Galera：多主同步MySQL集群原理解析</title>
    <link href="http://yoursite.com/2017/05/08/17050801/"/>
    <id>http://yoursite.com/2017/05/08/17050801/</id>
    <published>2017-05-08T11:50:09.000Z</published>
    <updated>2017-05-08T11:52:31.817Z</updated>
    
    <content type="html"><![CDATA[<h5 id="Galera-Cluster-实现mysql群集"><a href="#Galera-Cluster-实现mysql群集" class="headerlink" title="Galera Cluster 实现mysql群集"></a>Galera Cluster 实现mysql群集</h5><p>参考：<br><a href="http://blog.itpub.net/14431099/viewspace-1316643/" target="_blank" rel="external">http://blog.itpub.net/14431099/viewspace-1316643/ </a><br><a href="http://lovestoned.blog.51cto.com/2904444/1617817" target="_blank" rel="external">http://lovestoned.blog.51cto.com/2904444/1617817</a><br><a href="http://www.itbaofeng.com/?p=59" target="_blank" rel="external">http://www.itbaofeng.com/?p=59</a><br><a href="http://lansgg.blog.51cto.com/5675165/1180305" target="_blank" rel="external">http://lansgg.blog.51cto.com/5675165/1180305</a> </p>
<h6 id="1-MySQL-Galera介绍"><a href="#1-MySQL-Galera介绍" class="headerlink" title="1. MySQL Galera介绍"></a>1. MySQL Galera介绍</h6><ul>
<li>MySQL/Galera是MySQL/InnoDB的多主集群,有以下特性: </li>
<li>同步复制</li>
<li>Active-active的多主拓扑结构</li>
<li>集群任意节点可以读和写</li>
<li>自动身份控制,失败节点自动脱离集群</li>
<li>自动节点接入</li>
<li>真正的基于”行”级别和ID检查的并行复制</li>
<li>客户端连接跟操作单台MySQL数据库的体验一致</li>
</ul>
<p>总结下来，官网上给出了大概以上等数条优势，总结下来就是两个比较突出的点：多主和同步。<br><strong>多主：</strong><br>Galera Cluster没有MySQL主从集群只有一个主能提供写服务的限制，集群中每个节点都可读可写，无需读写分离。在一个Galera Cluster前直接部署HAProxy做读写负责均衡是比较常用的做法。<br><strong>同步：</strong><br>Galera replication具有实时性，能够保障不同节点的数据视图在较小的时间范围内是一致的。MySQL原生replication方案slave中的SQL线程和IO线程是分离的，即便使用半同步甚至同步复制，也可能因为SQL线程的速度跟不上IO线程而导致slave数据落后很多，当然5.7引入并行复制后会好很多，而Galera中除了具有并行复制的功能外，还具有flow control的功能来控制节点间数据同步的速度。</p>
<p>Galera本质是一个wsrep提供者（provider），运行依赖于wsrep的API接口。Wsrep API定义了一系列应用回调和复制调用库，来实现事务数据库同步写集(writeset)复制以及相似应用。目的在于从应用细节上实现抽象的，隔离的复制。虽然这个接口的主要目标是基于认证的多主复制，但同样适用于异步和同步的主从复制。</p>
<h6 id="2-MySQL-Galera安装"><a href="#2-MySQL-Galera安装" class="headerlink" title="2. MySQL Galera安装"></a>2. MySQL Galera安装</h6><p>安装前准备</p>
<ol>
<li>机器准备(虚拟机)</li>
</ol>
<ul>
<li>master    192.168.137.128</li>
<li>backup    192.168.137.129</li>
<li>joiner   192.168.137.130</li>
</ul>
<ol>
<li>安装依赖</li>
</ol>
<ul>
<li>确认安装有gcc和gcc-c++的版本最少为4.4</li>
</ul>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">yum</span> <span class="comment">install</span> <span class="literal">-</span><span class="comment">y</span> <span class="comment">gcc</span> <span class="comment">gcc</span><span class="literal">-</span><span class="comment">c</span><span class="literal">+</span><span class="literal">+</span></div></pre></td></tr></table></figure>
<ul>
<li>确认安装有boost-devel的版本至少为1.4.1</li>
</ul>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y boost-devel</div></pre></td></tr></table></figure>
<ul>
<li>安装scons check-devel openssl-devel</li>
</ul>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y scons<span class="built_in"> check-devel </span>openssl-devel</div></pre></td></tr></table></figure>
<h6 id="MySQL-Galera安装（从网上拷贝了一份安装文档，里面的版本为5-5-29，所以这里暂时用5-5-29版本）"><a href="#MySQL-Galera安装（从网上拷贝了一份安装文档，里面的版本为5-5-29，所以这里暂时用5-5-29版本）" class="headerlink" title="MySQL Galera安装（从网上拷贝了一份安装文档，里面的版本为5.5.29，所以这里暂时用5.5.29版本）"></a>MySQL Galera安装（从网上拷贝了一份安装文档，里面的版本为5.5.29，所以这里暂时用5.5.29版本）</h6><ol>
<li><p>安装含wsrep Patch的MySQL 5.5.29</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">yum install libaio</div><div class="line">wget <span class="string">https:</span><span class="comment">//launchpad.net/codership-mysql/5.5/5.5.29-23.7.3/+download/mysql-5.5.29_wsrep_23.7.3-linux-x86_64.tar.gz</span></div><div class="line">tar zxvf mysql<span class="number">-5.5</span><span class="number">.29</span>_wsrep_23<span class="number">.7</span><span class="number">.3</span>-linux-x86_64.tar.gz </div><div class="line">mv mysql<span class="number">-5.5</span><span class="number">.29</span>_wsrep_23<span class="number">.7</span><span class="number">.3</span>-linux-x86_64 <span class="regexp">/usr/</span>local/mysql</div><div class="line">cd <span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span></div><div class="line">groupadd mysql</div><div class="line">useradd -r -g mysql mysql</div><div class="line">chown -R <span class="string">mysql:</span>mysql .</div><div class="line">.<span class="regexp">/scripts/</span>mysql_install_db --no-defaults --datadir=<span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span>data --user=mysql</div><div class="line">chown -R root .</div><div class="line">chown -R mysql data</div></pre></td></tr></table></figure>
</li>
<li><p>安装Galera复制插件</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">wget <span class="symbol">https:</span>/<span class="regexp">/launchpad.net/galera</span><span class="regexp">/2.x/</span><span class="number">23.2</span>.<span class="number">4</span>/+download/galera-<span class="number">23.2</span>.<span class="number">4</span>-src.tar.gz</div><div class="line">tar zxvf galera-<span class="number">23.2</span>.<span class="number">4</span>-src.tar.gz</div><div class="line">cd galera-<span class="number">23.2</span>.<span class="number">4</span>-src</div><div class="line">scons</div><div class="line">cp garb/garbd /usr/local/mysql/bin/</div><div class="line">cp libgalera_smm.so /usr/local/mysql/<span class="class"><span class="keyword">lib</span>/<span class="title">plugin</span>/</span></div></pre></td></tr></table></figure>
</li>
</ol>
<h6 id="MySQL-Galera配置"><a href="#MySQL-Galera配置" class="headerlink" title="MySQL Galera配置"></a>MySQL Galera配置</h6><ol>
<li>MySQL Galera配置例子:</li>
</ol>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"> cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</div><div class="line"> mkdir -p /var/<span class="class"><span class="keyword">lib</span>/<span class="title">mysql</span></span></div><div class="line"> chown <span class="symbol">mysql:</span>mysql /var/<span class="class"><span class="keyword">lib</span>/<span class="title">mysql</span></span></div><div class="line"> vi /etc/my.cnf</div><div class="line"> cat /etc/my.cnf</div><div class="line"> </div><div class="line"> [client]</div><div class="line">port = <span class="number">3306</span></div><div class="line">socket = <span class="regexp">/var/lib</span><span class="regexp">/mysql/mysql</span>.sock</div><div class="line"></div><div class="line">[mysqld_safe]</div><div class="line">log-error = <span class="regexp">/var/lib</span><span class="regexp">/mysql/mysql</span>.log</div><div class="line">pid-file = <span class="regexp">/var/lib</span><span class="regexp">/mysql/mysql</span>.pid</div><div class="line"></div><div class="line">[mysqld]</div><div class="line">wsrep_node_name = node1</div><div class="line">wsrep_provider = <span class="regexp">/usr/local</span><span class="regexp">/mysql/lib</span><span class="regexp">/plugin/libgalera</span>_smm.so</div><div class="line"><span class="comment">#wsrep_provider_options ='gcache.size=1G;socket.ssl_key=my_key;socket.ssl_cert=my_cert'</span></div><div class="line"><span class="comment">#wsrep_slave_threads=16</span></div><div class="line">wsrep_sst_method = rsync</div><div class="line"><span class="comment">#wsrep_sst_auth=root:</span></div><div class="line"></div><div class="line">port = <span class="number">3306</span></div><div class="line">socket = <span class="regexp">/var/lib</span><span class="regexp">/mysql/mysql</span>.sock</div><div class="line">user = mysql</div><div class="line">basedir = <span class="regexp">/usr/local</span><span class="regexp">/mysql</span></div><div class="line">datadir = /usr<span class="regexp">/local/mysql</span><span class="regexp">/data</span></div><div class="line"></div><div class="line">default_storage_engine=InnoDB</div><div class="line">#innodb_buffer_pool_size=1G</div><div class="line">#innodb_log_file_size=256M</div><div class="line">innodb_autoinc_lock_mode=2</div><div class="line">innodb_locks_unsafe_for_binlog=1</div><div class="line">innodb_flush_log_at_trx_commit=0</div><div class="line">innodb_doublewrite=0</div><div class="line">innodb_file_per_table=1</div><div class="line"></div><div class="line">binlog_format=ROW</div><div class="line">log-bin=mysql-bin</div><div class="line">server-id=101</div><div class="line">relay-log=mysql-relay-bin</div><div class="line">#read_only=1</div><div class="line">log-slave-updates=1</div></pre></td></tr></table></figure>
<p>注：以上配置，参考与Mysql wsrep 参数</p>
<h6 id="Mysql-Galera启动与关闭"><a href="#Mysql-Galera启动与关闭" class="headerlink" title="Mysql  Galera启动与关闭"></a>Mysql  Galera启动与关闭</h6><ol>
<li>初次启动</li>
</ol>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/mysql/</span>bin/mysqld_safe --wsrep_cluster_address=gcomm:<span class="comment">// &gt;/dev/null &amp;</span></div><div class="line"></div><div class="line"><span class="meta"># 或</span></div><div class="line">service mysql start --wsrep_cluster_address=gcomm:<span class="comment">//</span></div><div class="line"></div><div class="line"><span class="meta"># ”gcomm:<span class="comment">//”是特殊的地址,仅仅是galera cluster初始化启动时候使用,再次启动的时候需要使用具体的IP地址.</span></span></div></pre></td></tr></table></figure>
<ol>
<li>启动完成后发现mysqld的监听端口有两个<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master ~]# netstat -plantu | grep mysqld</div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">4567</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*          LISTEN      <span class="number">3656</span>/mysqld         </div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">3306</span>       <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*          LISTEN      <span class="number">3656</span>/mysqld</div></pre></td></tr></table></figure>
</li>
</ol>
<p>这里4567端口是wsrep 使用的默认端口。</p>
<h6 id="MySQL-Galera新节点"><a href="#MySQL-Galera新节点" class="headerlink" title="MySQL Galera新节点"></a>MySQL Galera新节点</h6><ol>
<li>节点接入<br>添加新节点的时候,新接入的节点叫Joiner,给joiner提供复制的节点叫Donor.新的节点接入需要:</li>
</ol>
<ul>
<li>安装带wsrep patch的MySQL版本</li>
<li>安装Galera复制插件</li>
<li>配置好新节点的MySQL(参考Donnor的my.cnf)</li>
<li>配置或启动的gcomm://的地址是需要使用donnor的IP.</li>
</ul>
<p>接入节点backup：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span>bin<span class="regexp">/mysqld_safe --wsrep_cluster_address="gcomm:/</span><span class="regexp">/192.168.137.128:4567,192.168.137.130:4567"    &gt;/</span>dev/<span class="literal">null</span> &amp;</div></pre></td></tr></table></figure></p>
<p>接入节点joiner:<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service mysql start --wsrep_cluster_address="gcomm://<span class="number">192.168.137.128</span>:<span class="number">4567,192.168</span>.<span class="number">137.129:4567</span>"</div></pre></td></tr></table></figure></p>
<ol>
<li>修改节点的wsrep_cluster_address<br>修改wsrep_cluster_address有两种方式:</li>
</ol>
<p>i. 使用新的wsrep_cluster_address重启节点:<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service mysql restart --wsrep_cluster_address="gcomm://<span class="number">192.168.137.129</span>:<span class="number">4567,192.168</span>.<span class="number">137.130:4567</span>"</div></pre></td></tr></table></figure></p>
<p>ii. 直接修改MySQL全局变量</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="section">mysql&gt; SHOW VARIABLES LIKE 'wsrep_cluster_address';</span></div><div class="line">+-----------------------+----------------------------+</div><div class="line"><span class="section">| Variable_name         | Value                      |</span></div><div class="line">+-----------------------+----------------------------+</div><div class="line"><span class="section">| wsrep_cluster_address | gcomm://192.168.137.129:4567 |</span></div><div class="line">+-----------------------+----------------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; set global wsrep<span class="emphasis">_cluster_</span>address="gcomm://192.168.137.129:4567,192.168.137.130:4567"; Query OK, 0 rows affected (2.20 sec)</div><div class="line"></div><div class="line"><span class="section">mysql&gt; SHOW VARIABLES LIKE 'wsrep_cluster_address';</span></div><div class="line">+-----------------------+-------------------------------------------------------+</div><div class="line"><span class="section">| Variable_name         | Value                                                 |</span></div><div class="line">+-----------------------+-------------------------------------------------------+</div><div class="line"><span class="section">| wsrep_cluster_address | gcomm://192.168.137.129:4567,192.168.137.130:4567 |</span></div><div class="line">+-----------------------+-------------------------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<h6 id="MySQL-Galera监控"><a href="#MySQL-Galera监控" class="headerlink" title="MySQL Galera监控"></a>MySQL Galera监控</h6><ol>
<li>查看相关变量</li>
</ol>
<ul>
<li><p>查看MySQL版本:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="section">mysql&gt; SHOW GLOBAL VARIABLES LIKE 'version';</span></div><div class="line">+---------------+------------+</div><div class="line"><span class="section">| Variable_name | Value      |</span></div><div class="line">+---------------+------------+</div><div class="line"><span class="section">| version       | 5.5.29-log |</span></div><div class="line">+---------------+------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
</li>
<li><p>查看wsrep版本:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="section">mysql&gt; SHOW GLOBAL STATUS LIKE 'wsrep_provider_version';</span></div><div class="line">+------------------------+------------+</div><div class="line"><span class="section">| Variable_name          | Value      |</span></div><div class="line">+------------------------+------------+</div><div class="line"><span class="section">| wsrep_provider_version | 2.4(rXXXX) |</span></div><div class="line">+------------------------+------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
</li>
</ul>
<p>查看wsrep有关的所有变量:<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW VARIABLES LIKE 'wsrep%' \G</div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>OSU_method</div><div class="line"><span class="code">        Value: TOI</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 2. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>auto<span class="emphasis">_increment_</span>control</div><div class="line"><span class="code">        Value: ON</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 3. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>causal_reads</div><div class="line"><span class="code">        Value: OFF</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 4. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>certify_nonPK</div><div class="line"><span class="code">        Value: ON</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 5. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>cluster_address</div><div class="line"><span class="code">        Value: gcomm://192.168.1.222:4567,192.168.1.223:4567</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 6. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>cluster_name</div><div class="line"><span class="code">        Value: my_wsrep_cluster</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 7. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>convert<span class="emphasis">_LOCK_</span>to_trx</div><div class="line"><span class="code">        Value: OFF</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 8. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>data<span class="emphasis">_home_</span>dir</div><div class="line"><span class="code">        Value: /usr/local/mysql/data/</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 9. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>dbug_option</div><div class="line"><span class="code">        Value: </span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 10. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>debug</div><div class="line"><span class="code">        Value: OFF</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 11. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>drupal<span class="emphasis">_282555_</span>workaround</div><div class="line"><span class="code">        Value: OFF</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 12. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>forced<span class="emphasis">_binlog_</span>format</div><div class="line"><span class="code">        Value: NONE</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 13. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>log_conflicts</div><div class="line"><span class="code">        Value: OFF</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 14. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>max<span class="emphasis">_ws_</span>rows</div><div class="line"><span class="code">        Value: 131072</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 15. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>max<span class="emphasis">_ws_</span>size</div><div class="line"><span class="code">        Value: 1073741824</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 16. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>mysql<span class="emphasis">_replication_</span>bundle</div><div class="line"><span class="code">        Value: 0</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 17. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>node_address</div><div class="line"><span class="code">        Value: </span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 18. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>node<span class="emphasis">_incoming_</span>address</div><div class="line"><span class="code">        Value: AUTO</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 19. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>node_name</div><div class="line"><span class="code">        Value: node1</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 20. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>notify_cmd</div><div class="line"><span class="code">        Value: </span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 21. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>on</div><div class="line"><span class="code">        Value: ON</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 22. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>provider</div><div class="line"><span class="code">        Value: /usr/local/mysql/lib/plugin/libgalera_smm.so</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 23. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>provider_options</div><div class="line"><span class="code">        Value: base_host = 192.168.1.221; base_port = 4567; cert.log_conflicts = no; evs.causal_keepalive_period = PT1S; evs.debug_log_mask = 0x1; evs.inactive_check_period = PT0.5S; evs.inactive_timeout = PT15S; evs.info_log_mask = 0; evs.install_timeout = PT15S; evs.join_retrans_period = PT1S; evs.keepalive_period = PT1S; evs.max_install_timeouts = 1; evs.send_window = 4; evs.stats_report_period = PT1M; evs.suspect_timeout = PT5S; evs.use_aggregate = true; evs.user_send_window = 2; evs.version = 0; evs.view_forget_timeout = PT5M; gcache.dir = /usr/local/mysql/data/; gcache.keep_pages_size = 0; gcache.mem_size = 0; gcache.name = /usr/local/mysql/data//galera.cache; gcache.page_size = 128M; gcache.size = 128M; gcs.fc_debug = 0; gcs.fc_factor = 1; gcs.fc_limit = 16; gcs.fc_master_slave = NO; gcs.max_packet_size = 64500; gcs.max_throttle = 0.25; gcs.recv_q_hard_limit = 9223372036854775807; gcs.recv_q_soft_limit = 0.25; gcs.sync_donor = NO; gmcast.listen_addr = tcp://0.0.0.0:4567; gmcast.mcast_addr = ; gmcast.mcast_ttl = 1; gmcast.peer_timeout = PT3S; gmcast.time_wait = PT5S; gmcast.version = 0; ist.recv_addr = 192.168.1.221; pc.checksum = true; pc.ignore_quorum = false; pc.ignore_sb = false; pc.linger = PT20S; pc.npvo = false; pc.version = 0; pc.weight = 1; protonet.backend = asio; protonet.version = 0; replicator.causal_read_timeout = PT30S; replicator.commit_order = 3</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 24. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>recover</div><div class="line"><span class="code">        Value: OFF</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 25. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>replicate_myisam</div><div class="line"><span class="code">        Value: OFF</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 26. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>retry_autocommit</div><div class="line"><span class="code">        Value: 1</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 27. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>slave_threads</div><div class="line"><span class="code">        Value: 2</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 28. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>sst_auth</div><div class="line"><span class="code">        Value: </span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 29. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>sst_donor</div><div class="line"><span class="code">        Value: </span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 30. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>sst<span class="emphasis">_donor_</span>rejects_queries</div><div class="line"><span class="code">        Value: OFF</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 31. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>sst_method</div><div class="line"><span class="code">        Value: rsync</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 32. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>sst<span class="emphasis">_receive_</span>address</div><div class="line"><span class="code">        Value: AUTO</span></div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 33. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line">Variable<span class="emphasis">_name: wsrep_</span>start_position</div><div class="line"><span class="code">        Value: 80cdd13d-8cf2-11e2-0800-e0817023b754:0</span></div><div class="line">33 rows in set (0.00 sec)</div></pre></td></tr></table></figure></p>
<ol>
<li><p>状态监控<br>查看Galera集群状态:</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show status like 'wsrep%';</div><div class="line">+----------------------------+----------------------------------------------------------+</div><div class="line">|<span class="string"> Variable_name              </span>|<span class="string"> Value                                                    </span>|</div><div class="line">+----------------------------+----------------------------------------------------------+</div><div class="line">|<span class="string"> wsrep_local_state_uuid     </span>|<span class="string"> 80cdd13d-8cf2-11e2-0800-e0817023b754                     </span>|</div><div class="line">|<span class="string"> wsrep_protocol_version     </span>|<span class="string"> 4                                                        </span>|</div><div class="line">|<span class="string"> wsrep_last_committed       </span>|<span class="string"> 3 </span>|</div><div class="line">|<span class="string"> wsrep_replicated           </span>|<span class="string"> 3                                                        </span>|</div><div class="line">|<span class="string"> wsrep_replicated_bytes     </span>|<span class="string"> 522                                                      </span>|</div><div class="line">|<span class="string"> wsrep_received             </span>|<span class="string"> 6  </span>|</div><div class="line">|<span class="string"> wsrep_received_bytes       </span>|<span class="string"> 1134  </span>|</div><div class="line">|<span class="string"> wsrep_local_commits        </span>|<span class="string"> 1                                                        </span>|</div><div class="line">|<span class="string"> wsrep_local_cert_failures  </span>|<span class="string"> 0                                                        </span>|</div><div class="line">|<span class="string"> wsrep_local_bf_aborts      </span>|<span class="string"> 0                                                        </span>|</div><div class="line">|<span class="string"> wsrep_local_replays        </span>|<span class="string"> 0                                                        </span>|</div><div class="line">|<span class="string"> wsrep_local_send_queue     </span>|<span class="string"> 0                                                        </span>|</div><div class="line">|<span class="string"> wsrep_local_send_queue_avg </span>|<span class="string"> 0.000000                                                 </span>|</div><div class="line">|<span class="string"> wsrep_local_recv_queue     </span>|<span class="string"> 0                                                        </span>|</div><div class="line">|<span class="string"> wsrep_local_recv_queue_avg </span>|<span class="string"> 0.000000                                                 </span>|</div><div class="line">|<span class="string"> wsrep_flow_control_paused  </span>|<span class="string"> 0.000000                                                 </span>|</div><div class="line">|<span class="string"> wsrep_flow_control_sent    </span>|<span class="string"> 0                                                        </span>|</div><div class="line">|<span class="string"> wsrep_flow_control_recv    </span>|<span class="string"> 0                                                        </span>|</div><div class="line">|<span class="string"> wsrep_cert_deps_distance   </span>|<span class="string"> 1.000000                                                 </span>|</div><div class="line">|<span class="string"> wsrep_apply_oooe           </span>|<span class="string"> 0.000000                                                 </span>|</div><div class="line">|<span class="string"> wsrep_apply_oool           </span>|<span class="string"> 0.000000                                                 </span>|</div><div class="line">|<span class="string"> wsrep_apply_window         </span>|<span class="string"> 1.000000                                                 </span>|</div><div class="line">|<span class="string"> wsrep_commit_oooe          </span>|<span class="string"> 0.000000                                                 </span>|</div><div class="line">|<span class="string"> wsrep_commit_oool          </span>|<span class="string"> 0.000000                                                 </span>|</div><div class="line">|<span class="string"> wsrep_commit_window        </span>|<span class="string"> 1.000000                                                 </span>|</div><div class="line">|<span class="string"> wsrep_local_state          </span>|<span class="string"> 4                                                        </span>|</div><div class="line">|<span class="string"> wsrep_local_state_comment  </span>|<span class="string"> Synced                                                   </span>|</div><div class="line">|<span class="string"> wsrep_cert_index_size      </span>|<span class="string"> 5                                                        </span>|</div><div class="line">|<span class="string"> wsrep_causal_reads         </span>|<span class="string"> 0                                                        </span>|</div><div class="line">|<span class="string"> wsrep_incoming_addresses   </span>|<span class="string"> 192.168.1.221:3306,192.168.1.222:3306,192.168.1.223:3306 </span>|</div><div class="line">|<span class="string"> wsrep_cluster_conf_id      </span>|<span class="string"> 13                                                       </span>|</div><div class="line">|<span class="string"> wsrep_cluster_size         </span>|<span class="string"> 3                                                        </span>|</div><div class="line">|<span class="string"> wsrep_cluster_state_uuid   </span>|<span class="string"> 80cdd13d-8cf2-11e2-0800-e0817023b754                     </span>|</div><div class="line">|<span class="string"> wsrep_cluster_status       </span>|<span class="string"> Primary                                                  </span>|</div><div class="line">|<span class="string"> wsrep_connected            </span>|<span class="string"> ON                                                       </span>|</div><div class="line">|<span class="string"> wsrep_local_index          </span>|<span class="string"> 0                                                        </span>|</div><div class="line">|<span class="string"> wsrep_provider_name        </span>|<span class="string"> Galera                                                   </span>|</div><div class="line">|<span class="string"> wsrep_provider_vendor      </span>|<span class="string"> Codership Oy                         </span>|</div><div class="line">|<span class="string"> wsrep_provider_version     </span>|<span class="string"> 2.4(rXXXX)                                               </span>|</div><div class="line">|<span class="string"> wsrep_ready                </span>|<span class="string"> ON </span>|</div><div class="line">+----------------------------+----------------------------------------------------------+</div><div class="line">40 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
</li>
<li><p>监控状态说明</p>
</li>
<li></li>
</ol>
<ul>
<li><p>集群完整性检查:</p>
<pre><code>wsrep_cluster_state_uuid:在集群所有节点的值应该是相同的,有不同值的节点,说明其没有连接入集群.
wsrep_cluster_conf_id:正常情况下所有节点上该值是一样的.如果值不同,说明该节点被临时”分区”了.当节点之间网络连接恢复的时候应该会恢复一样的值.
wsrep_cluster_size:如果这个值跟预期的节点数一致,则所有的集群节点已经连接.
wsrep_cluster_status:集群组成的状态.如果不为”Primary”,说明出现”分区”或是”split-brain”状况.
</code></pre></li>
<li><p>节点状态检查:</p>
<pre><code>wsrep_ready: 该值为ON,则说明可以接受SQL负载.如果为Off,则需要检查wsrep_connected.
wsrep_connected: 如果该值为Off,且wsrep_ready的值也为Off,则说明该节点没有连接到集群.(可能是wsrep_cluster_address或wsrep_cluster_name等配置错造成的.具体错误需要查看错误日志)
wsrep_local_state_comment:如果wsrep_connected为On,但wsrep_ready为OFF,则可以从该项查看原因.
</code></pre></li>
<li><p>复制健康检查:</p>
<pre><code>wsrep_flow_control_paused:表示复制停止了多长时间.即表明集群因为Slave延迟而慢的程度.值为0~1,越靠近0越好,值为1表示复制完全停止.可优化wsrep_slave_threads的值来改善.
wsrep_cert_deps_distance:有多少事务可以并行应用处理.wsrep_slave_threads设置的值不应该高出该值太多.
wsrep_flow_control_sent:表示该节点已经停止复制了多少次.
wsrep_local_recv_queue_avg:表示slave事务队列的平均长度.slave瓶颈的预兆.
最慢的节点的wsrep_flow_control_sent和wsrep_local_recv_queue_avg这两个值最高.这两个值较低的话,相对更好.
</code></pre></li>
<li><p>检测慢网络问题:</p>
<pre><code>wsrep_local_send_queue_avg:网络瓶颈的预兆.如果这个值比较高的话,可能存在网络瓶
</code></pre></li>
<li><p>冲突或死锁的数目:</p>
<pre><code>wsrep_last_committed:最后提交的事务数目
wsrep_local_cert_failures和wsrep_local_bf_aborts:回滚,检测到的冲突数目
</code></pre></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;Galera-Cluster-实现mysql群集&quot;&gt;&lt;a href=&quot;#Galera-Cluster-实现mysql群集&quot; class=&quot;headerlink&quot; title=&quot;Galera Cluster 实现mysql群集&quot;&gt;&lt;/a&gt;Galera Cluster
    
    </summary>
    
      <category term="mysql" scheme="http://yoursite.com/categories/mysql/"/>
    
    
      <category term="mysql" scheme="http://yoursite.com/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>docker详解</title>
    <link href="http://yoursite.com/2017/04/14/17041401/"/>
    <id>http://yoursite.com/2017/04/14/17041401/</id>
    <published>2017-04-13T16:23:46.000Z</published>
    <updated>2017-04-13T16:25:39.890Z</updated>
    
    <content type="html"><![CDATA[<h5 id="容器虚拟化–docker"><a href="#容器虚拟化–docker" class="headerlink" title="容器虚拟化–docker"></a>容器虚拟化–docker</h5><h6 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h6><ol>
<li><p>镜像<br>是一个只读的模板，类似于安装系统用到的那个iso文件，我们通过镜像来完成各种应用的部署。</p>
</li>
<li><p>docker容器<br>镜像类似于操作系统，而容器类似于虚拟机本身。它可以被启动、开始、停止、删除等操作，每个容器都是相互隔离的。</p>
</li>
<li><p>docker仓库<br>存放镜像的一个场所，仓库分为公开仓库和私有仓库。 最大的公开仓库是<a href="hub.docker.com">hub.docker.com</a>，国内公开仓库<a href="http://dockerpool.com/" target="_blank" rel="external">http://dockerpool.com/ </a></p>
</li>
</ol>
<h6 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h6><p>centos6(6.5之前版本需要升级一下 yum update )<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y epel-<span class="keyword">release</span></div><div class="line">yum <span class="keyword">install</span> -y docker-io</div></pre></td></tr></table></figure></p>
<p>centos7<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y docker</div></pre></td></tr></table></figure></p>
<p>启动docker<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/etc/i</span>nit.d<span class="regexp">/docker start</span></div></pre></td></tr></table></figure></p>
<h6 id="镜像管理"><a href="#镜像管理" class="headerlink" title="镜像管理"></a>镜像管理</h6><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">docker pull  centos   <span class="comment">//从docker.com获取centos镜像，如果太慢，直接做个加速http://www.apelearn.com/bbs/thread-15126-1-1.html</span></div><div class="line">docker images  <span class="comment">//查看本地都有哪些镜像</span></div><div class="line">docker tag centos graped123  <span class="comment">//为centos镜像设置标签为graped123，再使用docker images查看会多出来一行，改行的image id和centos的一样</span></div><div class="line">docker search (image-name)   <span class="comment">//从docker仓库搜索docker镜像，后面是关键词</span></div><div class="line">docker run -t -<span class="selector-tag">i</span> centos  /bin/bash  <span class="comment">//用下载到的镜像开启容器，-i表示让容器的标准输入打开，-t表示分配一个伪终端，要把-i -t 放到镜像名字前面</span></div><div class="line">当该镜像发生修改后，我们可以把该镜像提交重新生成一个新版本进行在本地。</div><div class="line">docker ps  <span class="comment">//查看运行的容器</span></div><div class="line">docker rmi centos  <span class="comment">//用来删除指定镜像， 其中后面的参数可以是tag，如果是tag时，实际上是删除该tag，只要该镜像还有其他tag，就不会删除该镜像。当后面的参数为镜像ID时，则会彻底删除整个镜像，连通所有标签一同删除</span></div><div class="line">docker ps -<span class="selector-tag">a</span> <span class="comment">//查看所有容器，包括已经退出的。</span></div></pre></td></tr></table></figure>
<p>创建镜像-基于已有镜像的容器创建<br>运行docker run后，进入到该容器中<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker exec -<span class="keyword">it</span> f68 /bin/bash</div></pre></td></tr></table></figure></p>
<p>我们做一些变更，比如安装一些东西，然后针对这个容器进行创建新的镜像<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker commit -m <span class="string">"change somth"</span>  -<span class="selector-tag">a</span> <span class="string">"somebody info"</span>  image_id </div><div class="line">#例如：</div><div class="line">ocker commit -m <span class="string">"install httpd"</span> -<span class="selector-tag">a</span> <span class="string">"Graped"</span> <span class="number">2</span>c74d574293f graped/centos</div></pre></td></tr></table></figure></p>
<p>这个命令有点像svn的提交，-m 加一些改动信息，-a 指定作者相关信息 2c74d这一串为容器id，再后面为新镜像的名字。</p>
<p>创建镜像-基于本地模板导入<br>模块获取，可以直接在网上下载一个模块  <a href="http://openvz.org/Download/templates/precreated" target="_blank" rel="external">http://openvz.org/Download/templates/precreated</a> 可惜速度并不快，假如我们下载了一个centos的模板 centos-5-x86.tar.gz 那么导入该镜像的命令为：<br><figure class="highlight elm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="title">cat</span> centos<span class="number">-6</span>-x86_64-minimal.tar.gz |docker <span class="keyword">import</span> - centos-6-x86_64</div></pre></td></tr></table></figure></p>
<p>把现有镜像，导出为一个文件：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker save -o centos_with_net<span class="selector-class">.tar</span> graped/centos</div></pre></td></tr></table></figure></p>
<p>我们还可以用该文件恢复本地镜像：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker load --<span class="selector-tag">input</span> centos_net<span class="selector-class">.tar</span>  #或者</div><div class="line">docker load &lt; centos_net.tar</div></pre></td></tr></table></figure></p>
<p>上传镜像<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">docker</span> <span class="keyword">push </span>image_name</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;容器虚拟化–docker&quot;&gt;&lt;a href=&quot;#容器虚拟化–docker&quot; class=&quot;headerlink&quot; title=&quot;容器虚拟化–docker&quot;&gt;&lt;/a&gt;容器虚拟化–docker&lt;/h5&gt;&lt;h6 id=&quot;核心概念&quot;&gt;&lt;a href=&quot;#核心概念&quot; cla
    
    </summary>
    
      <category term="docker" scheme="http://yoursite.com/categories/docker/"/>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>MySQL调优</title>
    <link href="http://yoursite.com/2017/04/07/17040701/"/>
    <id>http://yoursite.com/2017/04/07/17040701/</id>
    <published>2017-04-07T12:15:18.000Z</published>
    <updated>2017-04-07T15:08:31.548Z</updated>
    
    <content type="html"><![CDATA[<p>MySQL调优可以从几个方面来做：</p>
<p><strong>架构层：</strong><br>做从库，实现读写分离；</p>
<p><strong>系统层次：</strong><br>增加内存；<br>给磁盘做raid0或者raid5以增加磁盘的读写速度；<a href="http://ask.apelearn.com/question/7134" target="_blank" rel="external">RAID相关</a><br>可以重新挂载磁盘，并加上noatime参数，这样可以减少磁盘的i/o;</p>
<p><strong>MySQL本身调优：</strong><br>(1) 如果未配置主从同步，可以把bin-log功能关闭，减少磁盘i/o<br>(2) 在my.cnf中加上skip-name-resolve,这样可以避免由于解析主机名延迟造成mysql执行慢<br>(3) 调整几个关键的buffer和cache。调整的依据，主要根据数据库的状态来调试。如何调优可以参考5.</p>
<p><strong>应用层次：</strong><br>查看慢查询日志，根据慢查询日志优化程序中的SQL语句，比如增加索引</p>
<p><strong>调整几个关键的buffer和cache</strong></p>
<p>1) key_buffer_size  首先可以根据系统的内存大小设定它，大概的一个参考值：1G以下内存设定128M；2G/256M; 4G/384M;8G/1024M；16G/2048M.这个值可以通过检查状态值Key_read_requests和 Key_reads,可以知道key_buffer_size设置是否合理。比例key_reads / key_read_requests应该尽可能的低，至少是1:100，1:1000更好(上述状态值可以使用SHOW STATUS LIKE ‘key_read%’获得)。注意：该参数值设置的过大反而会是服务器整体效率降低!</p>
<p>2) table_open_cache 打开一个表的时候，会临时把表里面的数据放到这部分内存中，一般设置成1024就够了，它的大小我们可以通过这样的方法来衡量： 如果你发现 open_tables等于table_cache，并且opened_tables在不断增长，那么你就需要增加table_cache的值了(上述状态值可以使用SHOW STATUS LIKE ‘Open%tables’获得)。注意，不能盲目地把table_cache设置成很大的值。如果设置得太高，可能会造成文件描述符不足，从而造成性能不稳定或者连接失败。</p>
<p>3) sort_buffer_size 查询排序时所能使用的缓冲区大小,该参数对应的分配内存是每连接独占!如果有100个连接，那么实际分配的总共排序缓冲区大小为100 × 4 = 400MB。所以，对于内存在4GB左右的服务器推荐设置为4-8M。</p>
<p>4) read_buffer_size 读查询操作所能使用的缓冲区大小。和sort_buffer_size一样，该参数对应的分配内存也是每连接独享!</p>
<p>5) join_buffer_size 联合查询操作所能使用的缓冲区大小，和sort_buffer_size一样，该参数对应的分配内存也是每连接独享!</p>
<p>6) myisam_sort_buffer_size 这个缓冲区主要用于修复表过程中排序索引使用的内存或者是建立索引时排序索引用到的内存大小，一般4G内存给64M即可。</p>
<p>7) query_cache_size MySQL查询操作缓冲区的大小，通过以下做法调整：SHOW STATUS LIKE ‘Qcache%’; 如果Qcache_lowmem_prunes该参数记录有多少条查询因为内存不足而被移除出查询缓存。通过这个值，用户可以适当的调整缓存大小。如果该值非常大，则表明经常出现缓冲不够的情况，需要增加缓存大小;Qcache_free_memory:查询缓存的内存大小，通过这个参数可以很清晰的知道当前系统的查询内存是否够用，是多了，还是不够用，我们可以根据实际情况做出调整。一般情况下4G内存设置64M足够了。</p>
<p>8) thread_cache_size 表示可以重新利用保存在缓存中线程的数，参考如下值：1G  —&gt; 8 2G  —&gt; 16 3G  —&gt; 32  &gt;3G  —&gt; 64<br>除此之外，还有几个比较关键的参数：</p>
<p>9) thread_concurrency 这个值设置为cpu核数的2倍即可</p>
<p>10) wait_timeout 表示空闲的连接超时时间，默认是28800s，这个参数是和interactive_timeout一起使用的，也就是说要想让wait_timeout 生效，必须同时设置interactive_timeout，建议他们两个都设置为10</p>
<p>11) max_connect_errors 是一个MySQL中与安全有关的计数器值，它负责阻止过多尝试失败的客户端以防止暴力破解密码的情况。与性能并无太大关系。为了避免一些错误我们一般都设置比较大，比如说10000 </p>
<p>12) max_connections 最大的连接数，根据业务请求量适当调整，设置500足够</p>
<p>13) max_user_connections 是指同一个账号能够同时连接到mysql服务的最大连接数。设置为0表示不限制。通常我们设置为100足够 </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;MySQL调优可以从几个方面来做：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;架构层：&lt;/strong&gt;&lt;br&gt;做从库，实现读写分离；&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;系统层次：&lt;/strong&gt;&lt;br&gt;增加内存；&lt;br&gt;给磁盘做raid0或者raid5以增加磁盘的读写速度；&lt;a hre
    
    </summary>
    
      <category term="mysql" scheme="http://yoursite.com/categories/mysql/"/>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>Hadoop伪分布式安装</title>
    <link href="http://yoursite.com/2017/04/05/17040502/"/>
    <id>http://yoursite.com/2017/04/05/17040502/</id>
    <published>2017-04-05T15:46:19.000Z</published>
    <updated>2017-04-05T16:40:22.602Z</updated>
    
    <content type="html"><![CDATA[<p>Hadoop内容<br>官网：<a href="http://hadoop.apache.org/#What+Is+Apache+Hadoop%3F" target="_blank" rel="external">http://hadoop.apache.org/#What+Is+Apache+Hadoop%3F</a></p>
<p>Hadoop内容较复杂，安装根据不同的需求有三种模式<br>独立模式（standalong/local model ）：无需任何守护进程，所有程序都单个的JVM上执行。本模式适用于开发阶段下的测试和调式MapReduce。<br>伪分布（pesudo-distributed model）：Hadoop守护进程都运行在本地服务器上，模拟一个小规模的集群<br>全分布(full distributed model)：Hadoop 守护进程运行在一个集群上。</p>
<p>先安装伪分布式进行结合测试</p>
<h4 id="1-安装前准备："><a href="#1-安装前准备：" class="headerlink" title="1. 安装前准备："></a>1. 安装前准备：</h4><ol>
<li>JDK1.6.X</li>
<li>SSH</li>
<li>RSYNC</li>
</ol>
<h4 id="2-下载hadoop文件之后解压到目录-直接解压后设定为Hadoop目录即可"><a href="#2-下载hadoop文件之后解压到目录-直接解压后设定为Hadoop目录即可" class="headerlink" title="2. 下载hadoop文件之后解压到目录,直接解压后设定为Hadoop目录即可"></a>2. 下载hadoop文件之后解压到目录,直接解压后设定为Hadoop目录即可</h4><p>在环境变量中添加JAVA目录与Hadoop目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/bin</div><div class="line"><span class="comment">#export PATH</span></div><div class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/java/jdk1.6.0_30</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:/usr/<span class="built_in">local</span>/mysql/bin:<span class="variable">$PATH</span></div><div class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</div><div class="line"><span class="built_in">unset</span> USERNAME</div><div class="line"><span class="built_in">export</span> HADOOP_INSTALL=/usr/<span class="built_in">local</span>/hadoop</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HADOOP_INSTALL</span>/bin</div></pre></td></tr></table></figure></p>
<p>执行hadoop version 查看hadoop版本，且查看是否运行<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@<span class="keyword">test</span> /] hadoop <span class="keyword">version</span></div><div class="line">Hadoop 1.2.1</div><div class="line">Subversion https:<span class="comment">//svn.apache.org/repos/asf/hadoop/common/branches/branch-1.2 -r 1503152</span></div><div class="line">Compiled <span class="keyword">by</span> mattf <span class="keyword">on</span> Mon Jul 22 15:23:09 PDT 2013</div><div class="line">From source with <span class="keyword">checksum</span> 6923c86528809c4e7e6f493b6b413a9a</div><div class="line">This command was <span class="keyword">run</span> using /usr/<span class="keyword">local</span>/hadoop/hadoop-core-1.2.1.jar</div></pre></td></tr></table></figure></p>
<h4 id="3-配置SSH"><a href="#3-配置SSH" class="headerlink" title="3. 配置SSH"></a>3. 配置SSH</h4><p>首先要能ssh登录到本机</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">ssh localhost</span></div></pre></td></tr></table></figure>
<p>如果无法登录，执行<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root<span class="variable">@zabbix</span> hadoop] ssh-keygen  -t dsa -P <span class="string">''</span> -f ~<span class="regexp">/.ssh/id</span>_sea</div><div class="line">[root<span class="variable">@zabbix</span> hadoop] cat ~<span class="regexp">/.ssh/id</span>_dsa.pub &amp;gt;&amp;gt;~<span class="regexp">/.ssh/authorized</span>_keys</div></pre></td></tr></table></figure></p>
<h4 id="4-格式化HDFS文件系统"><a href="#4-格式化HDFS文件系统" class="headerlink" title="4. 格式化HDFS文件系统"></a>4. 格式化HDFS文件系统</h4><p>使用Hadoop前，必须格式化一个全新的HDFS系统 ，创建一个空的文件系统。<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">hadoop namenode -frmat</span></div></pre></td></tr></table></figure></p>
<h4 id="5-Hadoop配置文件"><a href="#5-Hadoop配置文件" class="headerlink" title="5. Hadoop配置文件"></a>5. Hadoop配置文件</h4><p>conf目录中<br>core-site.xml 配置Common组件<br>hdfs-site.xml 配置HDFS属性<br>mapred-site.xml 配置MapReduce属性<br>默认情况下，三种模式的默认配置如图<br><img src="http://ask.apelearn.com/uploads/questions/20130929/145421x1hhs0fkgx00u11g.png" alt="image"></p>
<p>修改配置文件<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/core-site<span class="selector-class">.xml</span></div><div class="line">fs<span class="selector-class">.default</span><span class="selector-class">.namehdfs</span>:<span class="comment">//localhost/</span></div><div class="line"><span class="comment">//hdfs-site.xml</span></div><div class="line">dfs<span class="selector-class">.replication1</span></div><div class="line"><span class="comment">//mapred-site.xml</span></div><div class="line">mapred<span class="selector-class">.job</span><span class="selector-class">.trackerlocalhost</span>:<span class="number">8021</span></div></pre></td></tr></table></figure></p>
<h4 id="6-启动HDFS和MapReduce守护进程"><a href="#6-启动HDFS和MapReduce守护进程" class="headerlink" title="6. 启动HDFS和MapReduce守护进程"></a>6. 启动HDFS和MapReduce守护进程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@test conf] <span class="keyword">start</span>-dfs.sh</div><div class="line"><span class="keyword">starting</span> namenode, <span class="keyword">logging</span> <span class="keyword">to</span> /usr/<span class="keyword">local</span>/hadoop/libexec/../<span class="keyword">logs</span>/hadoop-root-namenode-zabbix.out</div><div class="line">localhost: <span class="keyword">starting</span> datanode, <span class="keyword">logging</span> <span class="keyword">to</span> /usr/<span class="keyword">local</span>/hadoop/libexec/../<span class="keyword">logs</span>/hadoop-root-datanode-zabbix.out</div><div class="line">localhost: <span class="keyword">starting</span> secondarynamenode, <span class="keyword">logging</span> <span class="keyword">to</span> /usr/<span class="keyword">local</span>/hadoop/libexec/../<span class="keyword">logs</span>/hadoop-root-secondarynamenode-zabbix.out</div><div class="line">[root@<span class="keyword">test</span> conf]  <span class="keyword">start</span>-mapred.sh</div><div class="line"><span class="keyword">starting</span> jobtracker, <span class="keyword">logging</span> <span class="keyword">to</span> /usr/<span class="keyword">local</span>/hadoop/libexec/../<span class="keyword">logs</span>/hadoop-root-jobtracker-zabbix.out</div><div class="line">localhost: <span class="keyword">starting</span> tasktracker, <span class="keyword">logging</span> <span class="keyword">to</span> /usr/<span class="keyword">local</span>/hadoop/libexec/../<span class="keyword">logs</span>/hadoop-root-tasktracker-zabbix.out</div></pre></td></tr></table></figure>
<h4 id="7-查看进程是否启动"><a href="#7-查看进程是否启动" class="headerlink" title="7. 查看进程是否启动"></a>7. 查看进程是否启动</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">http</span>:<span class="comment">//namenode:50030/jobtracker.jsp</span></div><div class="line"><span class="attribute">http</span>:<span class="comment">//namenode:50070/dfshealth.jsp</span></div><div class="line">[root<span class="variable">@test</span> conf]# netstat -lnp |grep <span class="number">50030</span></div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> :::<span class="number">50030</span>                    :::*                        LISTEN      <span class="number">3071</span>/java           </div><div class="line">[root<span class="variable">@test</span> conf]# netstat -lnp |grep <span class="number">50070</span></div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> :::<span class="number">50070</span>               :::*                        LISTEN      <span class="number">2676</span>/java</div></pre></td></tr></table></figure>
<p>JAVA的jps查看<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">jps</div><div class="line"><span class="number">3220</span> TaskTracker</div><div class="line"><span class="number">2676</span> NameNode</div><div class="line"><span class="number">3071</span> JobTracker</div><div class="line"><span class="number">2803</span> DataNode</div><div class="line"><span class="number">2962</span> SecondaryNameNode</div><div class="line"><span class="number">3503</span> Jps</div></pre></td></tr></table></figure></p>
<p><strong>Hadoop常用命令</strong><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//查看HDFS文件列表</span></div><div class="line">hadoop fs -ls <span class="regexp">/usr/</span>local<span class="regexp">/log/</span></div><div class="line"><span class="comment">//创建文件目录</span></div><div class="line">hadoop fs -mkdir <span class="regexp">/usr/</span>local<span class="regexp">/log/</span>test</div><div class="line"><span class="comment">//删除文件</span></div><div class="line"><span class="regexp">/hadoop fs -rm /</span>usr<span class="regexp">/local/</span>log/<span class="number">11</span></div><div class="line"><span class="comment">//上传一个本机文件到HDFS中/usr/local/log/目录下</span></div><div class="line">adoop fs -put <span class="regexp">/usr/</span>local<span class="regexp">/src/</span>infobright<span class="number">-4.0</span><span class="number">.6</span><span class="number">-0</span>-x86_64-ice.rpm  <span class="regexp">/usr/</span>local<span class="regexp">/log/</span></div><div class="line"><span class="comment">//下载</span></div><div class="line">hadoop fs –get <span class="regexp">/usr/</span>local<span class="regexp">/log/</span>infobright<span class="number">-4.0</span><span class="number">.6</span><span class="number">-0</span>-x86_64-ice.rpm   <span class="regexp">/usr/</span>local<span class="regexp">/src/</span></div><div class="line"><span class="comment">//查看文件</span></div><div class="line">hadoop fs -cat <span class="regexp">/usr/</span>local<span class="regexp">/log/</span><span class="number">20131008</span>_10/access.log.zabbix</div><div class="line"><span class="comment">//查看HDFS基本使用情况</span></div><div class="line">[root<span class="meta">@hh</span> ~] hadoop dfsadmin -report</div><div class="line">Configured <span class="string">Capacity:</span> <span class="number">10397683712</span> (<span class="number">9.68</span> GB)</div><div class="line">Present <span class="string">Capacity:</span> <span class="number">9388027904</span> (<span class="number">8.74</span> GB)</div><div class="line">DFS <span class="string">Remaining:</span> <span class="number">9324613632</span> (<span class="number">8.68</span> GB)</div><div class="line">DFS <span class="string">Used:</span> <span class="number">63414272</span> (<span class="number">60.48</span> MB)                                 </div><div class="line">DFS Used%: <span class="number">0.68</span>%</div><div class="line">Under replicated <span class="string">blocks:</span> <span class="number">1</span></div><div class="line">Blocks with corrupt <span class="string">replicas:</span> <span class="number">0</span></div><div class="line">Missing <span class="string">blocks:</span> <span class="number">1</span></div><div class="line">-------------------------------------------------</div><div class="line">Datanodes <span class="string">available:</span> <span class="number">1</span> (<span class="number">1</span> total, <span class="number">0</span> dead)</div><div class="line"><span class="string">Name:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">50010</span></div><div class="line">Decommission <span class="string">Status :</span> Normal</div><div class="line">Configured <span class="string">Capacity:</span> <span class="number">10397683712</span> (<span class="number">9.68</span> GB)</div><div class="line">DFS <span class="string">Used:</span> <span class="number">63414272</span> (<span class="number">60.48</span> MB)</div><div class="line">Non DFS <span class="string">Used:</span> <span class="number">1009655808</span> (<span class="number">962.88</span> MB)</div><div class="line">DFS <span class="string">Remaining:</span> <span class="number">9324613632</span>(<span class="number">8.68</span> GB)</div><div class="line">DFS Used%: <span class="number">0.61</span>%</div><div class="line">DFS Remaining%: <span class="number">89.68</span>%</div><div class="line">Last <span class="string">contact:</span> Tue Oct <span class="number">08</span> <span class="number">13</span>:<span class="number">41</span>:<span class="number">05</span> CST <span class="number">2013</span></div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Hadoop内容&lt;br&gt;官网：&lt;a href=&quot;http://hadoop.apache.org/#What+Is+Apache+Hadoop%3F&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://hadoop.apache.org/#What
    
    </summary>
    
      <category term="hadoop" scheme="http://yoursite.com/categories/hadoop/"/>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>rsync 自动安装脚本</title>
    <link href="http://yoursite.com/2017/04/05/17040501/"/>
    <id>http://yoursite.com/2017/04/05/17040501/</id>
    <published>2017-04-05T07:15:36.000Z</published>
    <updated>2017-04-05T16:41:25.441Z</updated>
    
    <content type="html"><![CDATA[<p>rsync 自动安装脚本</p>
<pre><code>#!/bin/bash
#home_page http://grapedlinux.cn

rpm -q rsync &amp;&gt;/dev/null;
rpm -q xinetd &amp;&gt;/dev/null || yum install rsync xinetd --nogpgcheck -y &amp;&gt;/dev/null
t=$(echo $?)
if [[ &quot;$t&quot; != 0 ]];then
    echo &quot;rsync is not install,try to install is faild,please check you yum configure or network! &quot;
    exit 5
fi
sed -i &apos;s/yes/no/&apos; /etc/xinetd.d/rsync 
cat &gt; /etc/rsyncd.conf &lt;&lt;EOF
uid = root
gid = root
user chroot = no
max connections = 0
[nginxconf]
path=/usr/local/nginx/conf/
ignore errors
read only = yes
list = no
hosts allow = 10.15.6.50
auth users = syncuser
secrets file = /etc/server.pass

[blogdata]
path=/data/blog_data_bak/
ignore errors
read only = yes
list = no
hosts allow = 10.23.16.8
auth users = syncuser
secrets file = /etc/server.pass
EOF
cat &gt; /etc/server.pass &lt;&lt;EOF
syncuser:password-not-found
EOF
chmod 600 /etc/server.pass
service xinetd restart &amp;&gt;/dev/null
res=$(netstat -nutlp | grep 873 | grep -v grep | wc -l)
if [[ $res -ne 1 ]];then
    echo &quot;Something wrong! please check.&quot;
fi
cat &lt;&lt;EOF
Rynsc configure is success!
config file is /etc/rsyncd.conf
pass file is /etc/server.pass
EOF
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;rsync 自动安装脚本&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#!/bin/bash
#home_page http://grapedlinux.cn

rpm -q rsync &amp;amp;&amp;gt;/dev/null;
rpm -q xinetd &amp;amp;&amp;gt;/dev/nu
    
    </summary>
    
      <category term="shellscripts" scheme="http://yoursite.com/categories/shellscripts/"/>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>Redis详解</title>
    <link href="http://yoursite.com/2017/04/04/17040403/"/>
    <id>http://yoursite.com/2017/04/04/17040403/</id>
    <published>2017-04-04T15:35:45.000Z</published>
    <updated>2017-04-04T16:29:20.087Z</updated>
    
    <content type="html"><![CDATA[<p><strong>一、Redis介绍</strong></p>
<ul>
<li>redis是一个key-value存储系统，官方站点<a href="http://redis.io" target="_blank" rel="external">http://redis.io</a></li>
<li>和memcached类似，但支持数据持久化</li>
<li>支持更多value类型，除了和string外，还支持hash、lists(链表）、sets(集合）和sorted sets（有序集合）集中数据类型</li>
<li>redis使用了两种文件格式：全量数据(RDB)和增量请求(aof)。全量数据格式是把内存中的数据写入磁盘，便于下次读取文件进行加载。增量请求文件则是把内存中的数据序列化为操作请求，用于读取文件进行replay得到数据</li>
<li>redis的存储分为内存存储、磁盘存储和log文件三部分</li>
</ul>
<p><strong>二、Redis下载安装</strong><br>下载解压：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cd /usr/local/src</div><div class="line">wget   https:<span class="comment">//codeload.github.com/antirez/redis/tar.gz/2.8.21</span></div><div class="line">mv <span class="number">2.8</span>.<span class="number">21</span> redis-<span class="number">2.8</span>.<span class="number">21</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></div><div class="line">tar xf redis-<span class="number">2.8</span>.<span class="number">21</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></div></pre></td></tr></table></figure></p>
<p>安装：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> redis-<span class="number">2.8</span>.<span class="number">21</span></div><div class="line">yum install -<span class="keyword">y</span> gcc gcc-<span class="keyword">c</span>++</div><div class="line"><span class="keyword">make</span></div><div class="line"></div><div class="line"><span class="keyword">cd</span> src &amp;&amp; <span class="keyword">make</span> PREFIX=/usr/local/redis install</div></pre></td></tr></table></figure></p>
<p><strong>三、Redis配置</strong></p>
<p>配置Redis的配置文件<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir <span class="regexp">/usr/</span>local<span class="regexp">/redis/</span>etc</div><div class="line">vim  <span class="regexp">/usr/</span>local<span class="regexp">/redis/</span>etc<span class="regexp">/redis.conf</span></div></pre></td></tr></table></figure></p>
<p>加入如下内容：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">daemonize yes</div><div class="line">pidfile /usr/<span class="keyword">local</span>/redis/<span class="keyword">var</span>/redis.pid</div><div class="line">port 6379</div><div class="line">timeout 300</div><div class="line">loglevel debug</div><div class="line">logfile /usr/<span class="keyword">local</span>/redis/<span class="keyword">var</span>/redis.<span class="built_in">log</span></div><div class="line">databases 16</div><div class="line"><span class="keyword">save</span> 900 1</div><div class="line"><span class="keyword">save</span> 300 10</div><div class="line"><span class="keyword">save</span> 60 10000</div><div class="line">rdbcompression yes</div><div class="line">dbfilename dump.rdb</div><div class="line"><span class="keyword">dir</span> /usr/<span class="keyword">local</span>/redis/<span class="keyword">var</span>/</div><div class="line">appendonly <span class="keyword">no</span></div><div class="line">appendfsync always</div></pre></td></tr></table></figure></p>
<p>下面是redis.conf的主 要配置参数的意义：<br>daemonize：是否以后台daemon方式运行<br>pidfile：pid文件位置<br>port：监听的端口号<br>timeout：请求超时时间<br>loglevel：log信息级别<br>logfile：log文件位置<br>databases：开启数据库的数量<br>save x x ：保存快照的频率，第一个x表示多长时间，第三个x表示执行多少次写操作。在一定时间内执行一定数量的写操作时，自动保存快照。可设置多个条件。<br>rdbcompression：是否使用压缩<br>dbfilename：数据快照文件名（只是文件名，不包括目录）<br>dir：数据快照的保存目录（这个是目录）<br>appendonly：是否开启appendonlylog，开启的话每次写操作会记一条log，这会提高数据抗风险能力，但影响效率。<br>appendfsync：appendonlylog如何同步到磁盘（三个选项，分别是每次写都强制调用fsync、每秒启用一次fsync、不调用fsync等待系统自己同步）</p>
<p>编写一个redis启动脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">vi /etc/init.d/redis   //加入如下内容：</div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># redis        init file for starting up the redis daemon</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># chkconfig:   - 20 80</span></div><div class="line"><span class="comment"># description: Starts and stops the redis daemon.</span></div><div class="line"></div><div class="line"><span class="comment"># Source function library.</span></div><div class="line">. /etc/rc.d/init.d/<span class="built_in">functions</span></div><div class="line"></div><div class="line">name=<span class="string">"redis-server"</span></div><div class="line">basedir=<span class="string">"/usr/local/redis"</span></div><div class="line"><span class="built_in">exec</span>=<span class="string">"<span class="variable">$basedir</span>/bin/<span class="variable">$name</span>"</span></div><div class="line">pidfile=<span class="string">"<span class="variable">$basedir</span>/var/redis.pid"</span></div><div class="line">REDIS_CONFIG=<span class="string">"<span class="variable">$basedir</span>/etc/redis.conf"</span></div><div class="line"></div><div class="line">[ <span class="_">-e</span> /etc/sysconfig/redis ] &amp;&amp; . /etc/sysconfig/redis</div><div class="line"></div><div class="line">lockfile=/var/lock/subsys/redis</div><div class="line"></div><div class="line"><span class="function"><span class="title">start</span></span>() &#123;</div><div class="line">    [ <span class="_">-f</span> <span class="variable">$REDIS_CONFIG</span> ] || <span class="built_in">exit</span> 6</div><div class="line">    [ -x <span class="variable">$exec</span> ] || <span class="built_in">exit</span> 5</div><div class="line">    <span class="built_in">echo</span> -n $<span class="string">"Starting <span class="variable">$name</span>: "</span></div><div class="line">    daemon --user <span class="variable">$&#123;REDIS_USER-redis&#125;</span> <span class="string">"<span class="variable">$exec</span> <span class="variable">$REDIS_CONFIG</span>"</span></div><div class="line">    retval=$?</div><div class="line">    <span class="built_in">echo</span></div><div class="line">    [ <span class="variable">$retval</span> <span class="_">-eq</span> 0 ] &amp;&amp; touch <span class="variable">$lockfile</span></div><div class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">stop</span></span>() &#123;</div><div class="line">    <span class="built_in">echo</span> -n $<span class="string">"Stopping <span class="variable">$name</span>: "</span></div><div class="line">    killproc -p <span class="variable">$pidfile</span> <span class="variable">$name</span></div><div class="line">    retval=$?</div><div class="line">    <span class="built_in">echo</span></div><div class="line">    [ <span class="variable">$retval</span> <span class="_">-eq</span> 0 ] &amp;&amp; rm <span class="_">-f</span> <span class="variable">$lockfile</span></div><div class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">restart</span></span>() &#123;</div><div class="line">    stop</div><div class="line">    start</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">reload</span></span>() &#123;</div><div class="line">    <span class="literal">false</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">rh_status</span></span>() &#123;</div><div class="line">    status -p <span class="variable">$pidfile</span> <span class="variable">$name</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">rh_status_q</span></span>() &#123;</div><div class="line">    rh_status &gt;/dev/null 2&gt;&amp;1</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></div><div class="line">    start)</div><div class="line">        rh_status_q &amp;&amp; <span class="built_in">exit</span> 0</div><div class="line">        <span class="variable">$1</span></div><div class="line">        ;;</div><div class="line">    stop)</div><div class="line">        rh_status_q || <span class="built_in">exit</span> 0</div><div class="line">        <span class="variable">$1</span></div><div class="line">        ;;</div><div class="line">    restart)</div><div class="line">        <span class="variable">$1</span></div><div class="line">        ;;</div><div class="line">    reload)</div><div class="line">        rh_status_q || <span class="built_in">exit</span> 7</div><div class="line">        <span class="variable">$1</span></div><div class="line">        ;;</div><div class="line">    force-reload)</div><div class="line">        force_reload</div><div class="line">        ;;</div><div class="line">    status)</div><div class="line">        rh_status</div><div class="line">        ;;</div><div class="line">    condrestart|try-restart)</div><div class="line">        rh_status_q || <span class="built_in">exit</span> 0</div><div class="line">        restart</div><div class="line">        ;;</div><div class="line">    *)</div><div class="line">        <span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$0</span> &#123;start|stop|status|restart|condrestart|try-restart&#125;"</span></div><div class="line">        <span class="built_in">exit</span> 2</div><div class="line"><span class="keyword">esac</span></div><div class="line"><span class="built_in">exit</span> $?</div></pre></td></tr></table></figure></p>
<p>因为脚本启动时以redis用户启动的，所以需要增加redis用户<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">useradd -s <span class="meta-keyword">/sbin/</span>nologin redis</div><div class="line">mkdir <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/redis/</span>var</div><div class="line">chmod <span class="number">777</span> <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/redis/</span>var</div><div class="line">chmod <span class="number">755</span> <span class="meta-keyword">/etc/</span>init.d/redis</div><div class="line">chkconfig  --add redis</div><div class="line">chkconfig redis on</div><div class="line">service redis start</div></pre></td></tr></table></figure></p>
<p><strong>四、Redis数据类型</strong></p>
<p><strong>string</strong>：是最简单的类型，你可以理解成Memcached一样的类型，一个key对应一个value，支持的操作与Memcached的操作类似，它的功能更丰富。设置可以存二进制的对象。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/usr/local/redis/bin/redis-<span class="keyword">cli</span> </div><div class="line"></div><div class="line"><span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">6379</span>&gt; mset key1 szk key2 love key3 yc</div><div class="line">OK</div><div class="line"><span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">6379</span>&gt; mget key1 key2 key3</div><div class="line"><span class="number">1</span>) <span class="string">"szk"</span></div><div class="line"><span class="number">2</span>) <span class="string">"love"</span></div><div class="line"><span class="number">3</span>) <span class="string">"yc"</span></div></pre></td></tr></table></figure></p>
<p> <strong>list</strong>:是一个链表结构，主要功能是push、pop、获取一个范围的所有值等等。操作中key理解为链接的名字。使用List结构，我们可以轻松的实现最新消息排行等功能。使用List结构，我们可以轻松地实现最新消息排行等功能。List的另一个应用就是消息队列，可以利用list的push操作，将任务存在list中，然后工作线程再用pop操作将任务取出进行执行。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">lpush</span> <span class="selector-tag">list1</span> 123</div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">lpush</span> <span class="selector-tag">list1</span> <span class="selector-tag">aaa</span></div><div class="line">(<span class="selector-tag">integer</span>) 2</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">lpush</span> <span class="selector-tag">list1</span> "123 456"</div><div class="line">(<span class="selector-tag">integer</span>) 3</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">rpop</span> <span class="selector-tag">list1</span></div><div class="line">"123"</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">rpop</span> <span class="selector-tag">list1</span></div><div class="line">"<span class="selector-tag">aaa</span>"</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">rpop</span> <span class="selector-tag">list1</span></div></pre></td></tr></table></figure></p>
<p><strong>set</strong>:是集合，和我们数学中的集合概念类似，对集合的操作有添加删除元素，有对多个集合求交并差等操作。操作中key理解为集合的名字。比如在微博应用中，可以将一个用户所有的关注人存在一个集合中，将其所有粉丝存在一个集合。因为Redis非常人性化的为几个提供了求交集、并集、差集等操作，那么就可以非常方便的实现如共同关注、共同喜好、二度好友等功能，对上面的所有集合 操作，你还可以使用不同的命令选择将结果返回给客户端还是存集到一个新的集合中。QQ有一个社交功能叫做”好友标签”，这时就可以使用redis的集合来实现，把每一个用户的标签都存储在一个集合之中。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">sadd</span> <span class="selector-tag">set1</span> <span class="selector-tag">zbc</span></div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">sadd</span> <span class="selector-tag">set1</span> <span class="selector-tag">szk</span></div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">smembers</span> <span class="selector-tag">set1</span></div><div class="line">1) "<span class="selector-tag">zbc</span>"</div></pre></td></tr></table></figure></p>
<p><strong>sorted set</strong>:是有序集合，它比set多了一个权重参数score，使得集合中的元素能够按score进行有序排列，比如一个存储全班同学成绩的Sorted Sets，其集合value可以是同学的学号，而score就可以是其考试得分，这样在数据插入集合的时候，就已经进行了天然的排序。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">zadd</span> <span class="selector-tag">mset2</span> 2 "<span class="selector-tag">cde</span> 123"</div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">zadd</span> <span class="selector-tag">mset2</span> 4 "<span class="selector-tag">a123a</span>"</div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">zadd</span> <span class="selector-tag">mset2</span> 24 "123<span class="selector-tag">-aaa</span>"</div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">zrange</span> <span class="selector-tag">mset2</span> 0 <span class="selector-tag">-1</span></div><div class="line">1) "<span class="selector-tag">cde</span> 123"</div><div class="line">2) "<span class="selector-tag">a123a</span>"</div><div class="line">3) "123<span class="selector-tag">-aaa</span>"</div></pre></td></tr></table></figure></p>
<p><strong> hash</strong>：在memcached中，经常将一些结构化的信息打包成hashmap，在客户端序列化后存储为一个字符串的值（一般是JSON格式），比如用户的昵称、年龄、性别、积分等。</p>
<p><strong>六、Redis通用配置</strong></p>
<ul>
<li>daemonize no #默认情况下，redis并不是以daemon形式来运行的。通过daemonize配置项可以控制redis的运行形式。</li>
<li>pidfile /path/to/redis.pid #当以daemon形式运行时，redis会生成一个pid文件，默认会生成在/var/run/redis.pid</li>
<li>bind 192.168.1.200 #指定绑定的IP，可以有多个</li>
<li>port 6379 #指定监听端口</li>
<li>unixsocket /tmp/redis.sock #也可以监听socket</li>
<li>unixsocketperm 755 #当监听socket时可以指定权限为755</li>
<li>timeout 0 #当一个redis-client一直没有请求发向server端，那么server端有权主动关闭这个连接，可以通过timeout来设置“空间超时时限”,0表示永不关闭</li>
<li>tcp-keepalive 0 #TCP连接保活策略，可以通过tcp-keepalive配置项来进行设置，单位为秒，假如设置为60秒，则server端会每60秒向连接空闲的客户端发起一次ACk请求，以检查客户端是否已经挂掉，对于无响应的客户端则会关闭其连接。如果设置为0，则不会进行保活检测</li>
<li>loglevel notice #日志级别，有四种debug，verbose，notice，warning</li>
<li>logfile “” #定义日志路径</li>
<li>syslog-ident redis #如果希望日志打印到sysllog中，通过syslog-enabled来控制</li>
<li>syslog-facility local0 #指定syslog的设备，可以是USER或者local0-local7</li>
<li>databases 16 #设置数据库的总数量，select n 选择数据库，0 - 15</li>
</ul>
<p><strong>七、Redis快照配置（rdb持久化）</strong></p>
<ul>
<li>save 900 1 #表示每15分钟且至少有1个key改变，就触发一次持久化</li>
<li>save 300 10 #表示每5分钟至少有10个key改变，就触发一次持久化</li>
<li>save 60 1000 #表示每60秒至少有10000个key改变，就触发一次持久</li>
<li>save “” #这样可以禁用rdb持久化</li>
<li>stop-write-on-bgsave-error yes #rdb持久化写入磁盘避免不了会出现失败的情况，默认一旦出现失败，redis会马上停止写操作。如果你觉得无所谓，那就可以使用选项关闭这个功能</li>
<li>rdbcompression yes #是否要压缩</li>
<li>rdbchecksum yes #是否进行数据校验</li>
<li>dir ./ #定义快照文件储存路径</li>
</ul>
<p><strong>八、Redis安全相关配置</strong></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">vim <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/redis/</span>etc/redis.conf  <span class="meta">#设置redis-server的密码</span></div><div class="line"><span class="meta">#增加下面配置</span></div><div class="line"></div><div class="line">requirepass szk</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/redis/bin/redis-cli <span class="_">-a</span> szk  <span class="comment">#-a指定密码登录</span></div></pre></td></tr></table></figure>
<ul>
<li>rename-command CONFIG szk.config   #将CONFIG命令更名为szk.config，这样可以避免误操作，但 如果使用了AOF持久化，建议不要启用该功能</li>
<li>rename-command CONFIG “”  #也可以后面定义为空，这样就禁掉了该CONFIG命令</li>
</ul>
<p><strong>九、Redis限制相关配置</strong></p>
<ul>
<li>maxclients 10000 #限制最大客户端连接数</li>
<li>maxmemory  #设定最大内存使用数，单位是byte</li>
<li>maxmemory-policy volatile-lru #指定内存移除规则</li>
<li>maxmemory-samples 3 #LRU算大和最小TTL算法都并非是精确的算法，而是估算值。所以你可以设置样本的大小。假如redis默认会检查三个key，并选择其中LRU的那个，那么你可以改变这个key样本的数量。</li>
</ul>
<p><strong>十、Redis AOF持久化相关配置</strong></p>
<ul>
<li>appendonly no #如果是yes，则开启aof持久化</li>
<li>appendfilename “appendonly.aof” #指定aof文件名字，保存在dir参数指定的命令</li>
<li>appendfsync everysec #指定fsync()调用模式，有三种no(不调用fsync)，always（每次写都会调用fsync)，exerysec(每秒钟调用一次fsync)。第一种最快，第二种数据最安全，但性能会差一些，默认为第三种方案，性能和安全兼顾。</li>
<li>no-appendfsync-on-rewrite no #使用no可避免当写入量非常大时的磁盘IO阻塞</li>
<li>auto-aof-rewrite-percentage 10 #规定什么情况下触发aof重写。该值为一个比例，10表示当aof文件增幅达到10%时则会触发重写机制</li>
<li>auto-aof-rewrite-min-size 64mb #重写会有一个条件，就是不能低于64MB</li>
</ul>
<p><strong>十一、Redis慢日志相关配置</strong></p>
<ul>
<li>针对慢日志，你可以设置两个参数，一个是执行时长，单位是微秒，另一个是慢日志的长度。当一个新的命令被写入日志时，最老的一条会从命令日志队列中被移除。</li>
<li>slowlog-log-slower-than 10000 #慢于10000ms则记录日志</li>
<li>slowlog-max-len 128 #日志长度</li>
</ul>
<p><strong>十二、Redis主从配置</strong></p>
<ol>
<li>分别按照之前介绍的步骤安装好redis并启动</li>
<li>master 配置文件不用动</li>
<li>slave配置文件上加一行:slaveof 192.168.1.200 6379</li>
<li>masterauth szk  #如果主上设置了密码，要加这行</li>
<li>分别启动master和slave<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">tail /usr/local/redis/var/redis.log </div><div class="line"></div><div class="line"><span class="number">3966</span>] <span class="number">18</span> Feb <span class="number">15</span>:<span class="number">02</span>:<span class="number">58.330</span> * <span class="keyword">MASTER</span> <span class="title">&lt;-&gt; SLAVE</span> sync: receiving <span class="number">192</span> bytes from <span class="keyword">master</span></div><div class="line"><span class="title">[3966</span>] <span class="number">18</span> Feb <span class="number">15</span>:<span class="number">02</span>:<span class="number">58.330</span> * <span class="keyword">MASTER</span> <span class="title">&lt;-&gt; SLAVE</span> sync: Flushing old data</div><div class="line">[<span class="number">3966</span>] <span class="number">18</span> Feb <span class="number">15</span>:<span class="number">02</span>:<span class="number">58.330</span> * <span class="keyword">MASTER</span> <span class="title">&lt;-&gt; SLAVE</span> sync: Loading DB <span class="keyword">in</span> memory</div><div class="line">[<span class="number">3966</span>] <span class="number">18</span> Feb <span class="number">15</span>:<span class="number">02</span>:<span class="number">58.330</span> * <span class="keyword">MASTER</span> <span class="title">&lt;-&gt; SLAVE</span> sync: Finished with success</div><div class="line">[<span class="number">3966</span>] <span class="number">18</span> Feb <span class="number">15</span>:<span class="number">03</span>:<span class="number">03.344</span> - DB <span class="number">0</span>: <span class="number">7</span> keys (<span class="number">0</span> volatile) <span class="keyword">in</span> <span class="number">8</span> slots HT.</div><div class="line">[<span class="number">3966</span>] <span class="number">18</span> Feb <span class="number">15</span>:<span class="number">03</span>:<span class="number">03.344</span> - <span class="number">1</span> clients connected (<span class="number">0</span> slaves), <span class="number">466840</span> bytes <span class="keyword">in</span> use</div><div class="line">[<span class="number">3966</span>] <span class="number">18</span> Feb <span class="number">15</span>:<span class="number">03</span>:<span class="number">08.396</span> - DB <span class="number">0</span>: <span class="number">7</span> keys (<span class="number">0</span> volatile) <span class="keyword">in</span> <span class="number">8</span> slots HT.</div><div class="line">[<span class="number">3966</span>] <span class="number">18</span> Feb <span class="number">15</span>:<span class="number">03</span>:<span class="number">08.397</span> - <span class="number">1</span> clients connected (<span class="number">0</span> slaves), <span class="number">466848</span> bytes <span class="keyword">in</span> use</div></pre></td></tr></table></figure>
</li>
</ol>
<p>测试：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/usr/local/redis/bin/redis-cli -a szk      <span class="comment">#主</span></div><div class="line"></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> set key1 szk</div><div class="line">OK</div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> get key1            </div><div class="line"><span class="string">"szk"</span></div></pre></td></tr></table></figure></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="keyword">local</span>/redis/bin/redis-cli             <span class="comment">#从</span></div><div class="line"></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">get</span> key1</div><div class="line"><span class="string">"szk"</span></div><div class="line"></div><div class="line">OK</div></pre></td></tr></table></figure>
<p><strong>十三、Redis主从其他相关配置</strong></p>
<ul>
<li>slave-read-only yes #让从只读</li>
<li>repl-ping-slave-period 10  #设置slave向master发起ping的频率，每10s发起一次</li>
<li>repl-timeout 60  #设置slave ping不同master多少s后就超时</li>
<li>repl-disable-tcp-nodelay no  #是否开启tcp_nodeay，开启后将会使用更少的带宽，但会有延迟，所以建议关闭</li>
<li>repl-backlog-size 1mb  #同步队列的长度，backuplog是master的一个缓冲区，主从断开后，master会先把数据写到缓冲区，slave再次连接会从缓冲区中同步数据</li>
<li>repl-backlog-ttl 3600  #主从断开后，缓冲区的有效期，默认1小时</li>
<li>slave-priority 100  #多个slave是可以设置优先级的，数值越小优先级越高，应用于集群中，支持slave切换为mster，优先级最高的才会切换</li>
<li>min-slave-to-write 3 #和下面的一起使用，它的意思是master发现有超过3个slave的延迟高于10s，那么master就会暂时停止写操作。这两个数值任何一个为0，则关闭该功能，默认第一数值是0</li>
<li>min-slaves-max-log 10 </li>
</ul>
<p><strong>十四、string常用操作</strong><br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">key1</span> <span class="selector-tag">szk</span>  #给<span class="selector-tag">key1</span>赋值为<span class="selector-tag">szk</span></div><div class="line"><span class="selector-tag">OK</span> </div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">key1</span>    #获取这个值<span class="selector-tag">value</span></div><div class="line">"<span class="selector-tag">szk</span>"</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">key1</span> <span class="selector-tag">yc</span>  #一个<span class="selector-tag">key</span>对应一个<span class="selector-tag">value</span>，多次赋值，会覆盖前面的<span class="selector-tag">value</span></div><div class="line"><span class="selector-tag">OK</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">key1</span>  </div><div class="line">"<span class="selector-tag">yc</span>"</div><div class="line"></div><div class="line"></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">setex</span> <span class="selector-tag">key3</span> 10 1   #用来给<span class="selector-tag">key</span>设定过期时间,<span class="selector-tag">ttl</span> <span class="selector-tag">key3</span>查看时间</div><div class="line"><span class="selector-tag">OK</span></div><div class="line"></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">mset</span> <span class="selector-tag">key1</span> 1 <span class="selector-tag">key2</span> 2 <span class="selector-tag">key3</span> 3    #同时设置多个<span class="selector-tag">key</span></div><div class="line"><span class="selector-tag">OK</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">mget</span> <span class="selector-tag">key1</span> <span class="selector-tag">key2</span> <span class="selector-tag">key3</span>    </div><div class="line">1) "1"</div><div class="line">2) "2"</div><div class="line">3) "3"</div></pre></td></tr></table></figure></p>
<p><strong>十五、Hash常用操作</strong><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hset hash1 name szk</div><div class="line">(integer) <span class="number">1</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hset hash1  age <span class="number">23</span></div><div class="line">(integer) <span class="number">1</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hset hash1  job it</div><div class="line">(integer) <span class="number">1</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hgetall hash1 </div><div class="line"><span class="number">1</span>) <span class="string">"name"</span></div><div class="line"><span class="number">2</span>) <span class="string">"szk"</span></div><div class="line"><span class="number">3</span>) <span class="string">"age"</span></div><div class="line"><span class="number">4</span>) <span class="string">"23"</span></div><div class="line"><span class="number">5</span>) <span class="string">"job"</span></div><div class="line"><span class="number">6</span>) <span class="string">"it"</span></div><div class="line"></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hmset hash2 name yc age <span class="number">24</span> job teacher    <span class="comment">#批量创建</span></div><div class="line">OK</div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hgetall hash2</div><div class="line"><span class="number">1</span>) <span class="string">"name"</span></div><div class="line"><span class="number">2</span>) <span class="string">"yc"</span></div><div class="line"><span class="number">3</span>) <span class="string">"age"</span></div><div class="line"><span class="number">4</span>) <span class="string">"24"</span></div><div class="line"><span class="number">5</span>) <span class="string">"job"</span></div><div class="line"><span class="number">6</span>) <span class="string">"teacher"</span></div><div class="line"></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hdel hash2 job     <span class="comment">#删除某个值</span></div><div class="line">(integer) <span class="number">1</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hgetall hash2</div><div class="line"><span class="number">1</span>) <span class="string">"name"</span></div><div class="line"><span class="number">2</span>) <span class="string">"yc"</span></div><div class="line"><span class="number">3</span>) <span class="string">"age"</span></div><div class="line"><span class="number">4</span>) <span class="string">"24"</span></div><div class="line"></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hkeys hash2   <span class="comment">#查看所有的key</span></div><div class="line"><span class="number">1</span>) <span class="string">"name"</span></div><div class="line"><span class="number">2</span>) <span class="string">"age"</span></div><div class="line"></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hvals hash2   <span class="comment">#查看所有的values</span></div><div class="line"><span class="number">1</span>) <span class="string">"yc"</span></div><div class="line"><span class="number">2</span>) <span class="string">"24"</span></div><div class="line"></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> hlen hash2    <span class="comment">#查看hash有几个filed</span></div><div class="line">(integer) <span class="number">2</span></div></pre></td></tr></table></figure></p>
<p><strong>十六、list常用操作</strong><br><figure class="highlight tcl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush list1 a    #从左边插入</div><div class="line"></div><div class="line">(integer) <span class="number">3</span></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush list1 b     #从左边插入</div><div class="line">(integer) <span class="number">4</span></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpush list1 c      #从左边插入</div><div class="line">(integer) <span class="number">5</span></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list1 <span class="number">0</span> <span class="number">-1</span>       #从左边往右罗列，最先插入在最后边</div><div class="line"><span class="number">1</span>) <span class="string">"c"</span></div><div class="line"><span class="number">2</span>) <span class="string">"b"</span></div><div class="line"><span class="number">3</span>) <span class="string">"a"</span></div><div class="line"></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; lpop list1          #从最左边取出</div><div class="line"><span class="string">"c"</span></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list1 <span class="number">0</span> <span class="number">-1</span>    #从左边往右罗列</div><div class="line"><span class="number">1</span>) <span class="string">"b"</span></div><div class="line"><span class="number">2</span>) <span class="string">"a"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpush list1 <span class="number">1</span>          #从右边插入</div><div class="line">(integer) <span class="number">5</span></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpush list1 <span class="number">2</span>           #从右边插入</div><div class="line">(integer) <span class="number">6</span></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; rpush list1 <span class="number">3</span>           #从右边插入</div><div class="line">(integer) <span class="number">7</span></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list1 <span class="number">0</span> <span class="number">-1</span>       #从右往左罗列，最后插入在最后边</div><div class="line"><span class="number">1</span>) <span class="string">"b"</span></div><div class="line"><span class="number">2</span>) <span class="string">"a"</span></div><div class="line"><span class="number">3</span>) <span class="string">"1"</span></div><div class="line"><span class="number">4</span>) <span class="string">"2"</span></div><div class="line"><span class="number">5</span>) <span class="string">"3"</span></div><div class="line"></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">linsert</span> list1  before <span class="number">3</span>  <span class="number">5</span>        #在<span class="number">3</span>前面插入一个<span class="number">5</span></div><div class="line">(integer) <span class="number">8</span></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list1 <span class="number">0</span> <span class="number">-1</span></div><div class="line"><span class="number">1</span>) <span class="string">"b"</span></div><div class="line"><span class="number">2</span>) <span class="string">"a"</span></div><div class="line"><span class="number">3</span>) <span class="string">"1"</span></div><div class="line"><span class="number">4</span>) <span class="string">"2"</span></div><div class="line"><span class="number">5</span>) <span class="string">"5"</span></div><div class="line"><span class="number">6</span>) <span class="string">"3"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lset</span> list1 <span class="number">7</span> <span class="number">6</span>             #将<span class="number">0</span>开始的第<span class="number">7</span>个元素换成<span class="number">6</span></div><div class="line">OK</div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lrange</span> list1 <span class="number">0</span> <span class="number">-1</span></div><div class="line"><span class="number">1</span>) <span class="string">"b"</span></div><div class="line"><span class="number">2</span>) <span class="string">"a"</span></div><div class="line"><span class="number">3</span>) <span class="string">"456"</span></div><div class="line"><span class="number">4</span>) <span class="string">"123"</span></div><div class="line"><span class="number">5</span>) <span class="string">"1"</span></div><div class="line"><span class="number">6</span>) <span class="string">"2"</span></div><div class="line"><span class="number">7</span>) <span class="string">"5"</span></div><div class="line"><span class="number">8</span>) <span class="string">"6"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; <span class="keyword">lindex</span> list1 <span class="number">7</span>     #查看从<span class="number">0</span>开始的第<span class="number">7</span>个元素</div><div class="line"><span class="string">"6"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; llen list1          #查看列表中有几个元素</div><div class="line">(integer) <span class="number">8</span></div></pre></td></tr></table></figure></p>
<p><strong>十七、set数据常用操作 </strong><br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">sadd</span> <span class="selector-tag">set1</span> 1        #向集合<span class="selector-tag">set1</span>中放入元素</div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">sadd</span> <span class="selector-tag">set1</span> 2</div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">sadd</span> <span class="selector-tag">set1</span> 3</div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">sadd</span> <span class="selector-tag">set1</span> 4</div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">smembers</span> <span class="selector-tag">set1</span>    #查看集合中所有元素</div><div class="line">1) "<span class="selector-tag">zbc</span>"</div><div class="line">2) "1"</div><div class="line">3) "<span class="selector-tag">szk</span>"</div><div class="line">4) "2"</div><div class="line">5) "3"</div><div class="line">6) "4"</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">spop</span> <span class="selector-tag">set1</span>     #随机取出一个元素，删除</div><div class="line">"<span class="selector-tag">szk</span>"</div><div class="line"></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">sdiff</span> <span class="selector-tag">set1</span> <span class="selector-tag">seta</span>       #比较差集，以<span class="selector-tag">set1</span>为主来比较</div><div class="line">1) "<span class="selector-tag">zbc</span>"</div><div class="line">2) "4"</div><div class="line"></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">sdiffstore</span> <span class="selector-tag">set3</span>  <span class="selector-tag">seta</span> <span class="selector-tag">set1</span>   #比较差集，将结果存入<span class="selector-tag">set3</span>中</div><div class="line">(<span class="selector-tag">integer</span>) 2</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">SMEMBERS</span> <span class="selector-tag">set3</span>    <span class="selector-id">#tab</span>自动补全，但显示为大写</div><div class="line">1) "2"</div><div class="line">2) "<span class="selector-tag">szk</span>"</div></pre></td></tr></table></figure></p>
<p><strong>十八、zset常用操作</strong><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zadd zset1 <span class="number">1</span> abc     <span class="comment">#创建有序集合</span></div><div class="line">(integer) <span class="number">1</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zadd zset1 <span class="number">10</span> aabc   <span class="comment">#创建有序集合</span></div><div class="line">(integer) <span class="number">1</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zadd zset1 <span class="number">5</span> aaa    <span class="comment">#创建有序集合</span></div><div class="line">(integer) <span class="number">1</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zadd zset1 <span class="number">88</span> bbb   <span class="comment">#创建有序集合</span></div><div class="line">(integer) <span class="number">1</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zadd zset1 <span class="number">888</span> szk   <span class="comment">#创建有序集合</span></div><div class="line">(integer) <span class="number">1</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> ZRANGE zset1 <span class="number">0</span> -<span class="number">1</span>   <span class="comment">#显示所有元素，按顺序显示</span></div><div class="line"><span class="number">1</span>) <span class="string">"abc"</span></div><div class="line"><span class="number">2</span>) <span class="string">"aaa"</span></div><div class="line"><span class="number">3</span>) <span class="string">"aabc"</span></div><div class="line"><span class="number">4</span>) <span class="string">"bbb"</span></div><div class="line"><span class="number">5</span>) <span class="string">"szk"</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> ZRANGE zset1 <span class="number">0</span> -<span class="number">1</span> withscores    <span class="comment">#可以带上分值</span></div><div class="line"><span class="number">1</span>) <span class="string">"abc"</span></div><div class="line"><span class="number">2</span>) <span class="string">"1"</span></div><div class="line"><span class="number">3</span>) <span class="string">"aaa"</span></div><div class="line"><span class="number">4</span>) <span class="string">"5"</span></div><div class="line"><span class="number">5</span>) <span class="string">"aabc"</span></div><div class="line"><span class="number">6</span>) <span class="string">"10"</span></div><div class="line"><span class="number">7</span>) <span class="string">"bbb"</span></div><div class="line"><span class="number">8</span>) <span class="string">"88"</span></div><div class="line"><span class="number">9</span>) <span class="string">"szk"</span></div><div class="line"><span class="number">10</span>) <span class="string">"888"</span></div><div class="line"></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> ZREM zset1 abc       <span class="comment">#删除指定元素</span></div><div class="line">(integer) <span class="number">1</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> ZRANGE zset1 <span class="number">0</span> -<span class="number">1</span> withscores</div><div class="line"><span class="number">1</span>) <span class="string">"aaa"</span></div><div class="line"><span class="number">2</span>) <span class="string">"5"</span></div><div class="line"><span class="number">3</span>) <span class="string">"aabc"</span></div><div class="line"><span class="number">4</span>) <span class="string">"10"</span></div><div class="line"><span class="number">5</span>) <span class="string">"bbb"</span></div><div class="line"><span class="number">6</span>) <span class="string">"88"</span></div><div class="line"><span class="number">7</span>) <span class="string">"szk"</span></div><div class="line"><span class="number">8</span>) <span class="string">"888"</span></div><div class="line"></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zrevrank zset1 szk  <span class="comment">#返回元素的索引值，索引值从0开始，按score正向排序</span></div><div class="line">(integer) <span class="number">0</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zrank zset1 szk     <span class="comment">#同上，不同的是，按score反序排序</span></div><div class="line">(integer) <span class="number">3</span></div><div class="line"></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> ZCARD  zset1   <span class="comment">#查看集合元素的个数</span></div><div class="line">(integer) <span class="number">4</span> </div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zcount zset1 <span class="number">1</span> <span class="number">20</span>   <span class="comment">#查看分值区间内的元素个数</span></div><div class="line">(integer) <span class="number">2</span></div><div class="line"></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zrangebyscore zset1 <span class="number">1</span> <span class="number">100</span> withscores   <span class="comment">#返回分支范围在1-100的元素</span></div><div class="line"><span class="number">1</span>) <span class="string">"aaa"</span></div><div class="line"><span class="number">2</span>) <span class="string">"5"</span></div><div class="line"><span class="number">3</span>) <span class="string">"aabc"</span></div><div class="line"><span class="number">4</span>) <span class="string">"10"</span></div><div class="line"><span class="number">5</span>) <span class="string">"bbb"</span></div><div class="line"><span class="number">6</span>) <span class="string">"88"</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zrangebyscore zset1 <span class="number">0</span> <span class="number">10</span>    <span class="comment">#删除分支范围在0-10的元素，按score排序</span></div><div class="line"><span class="number">1</span>) <span class="string">"aaa"</span></div><div class="line"><span class="number">2</span>) <span class="string">"aabc"</span></div></pre></td></tr></table></figure></p>
<p><strong>十九、键值和服务器命令</strong><br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">keys</span> *            #列出所有键值</div><div class="line">1) "<span class="selector-tag">key3</span>"</div><div class="line">2) "<span class="selector-tag">seta</span>"</div><div class="line">3) "<span class="selector-tag">hash1</span>"</div><div class="line">4) "<span class="selector-tag">list1</span>"</div><div class="line">5) "<span class="selector-tag">key2</span>"</div><div class="line">6) "<span class="selector-tag">zset1</span>"</div><div class="line">7) "<span class="selector-tag">mset2</span>"</div><div class="line">8) "<span class="selector-tag">set2</span>"</div><div class="line">9) "<span class="selector-tag">set1</span>"</div><div class="line">10) "<span class="selector-tag">key1</span>"</div><div class="line">11) "<span class="selector-tag">hash2</span>"</div><div class="line">12) "<span class="selector-tag">set3</span>"</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">keys</span> <span class="selector-tag">key</span>*</div><div class="line">1) "<span class="selector-tag">key3</span>"</div><div class="line">2) "<span class="selector-tag">key2</span>"</div><div class="line">3) "<span class="selector-tag">key1</span>"</div><div class="line"></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">EXISTS</span> <span class="selector-tag">list1</span>      #查看是否有<span class="selector-tag">list1</span></div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">del</span> <span class="selector-tag">key1</span>      #删除<span class="selector-tag">key1</span></div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">EXISTS</span> <span class="selector-tag">key1</span></div><div class="line">(<span class="selector-tag">integer</span>) 0</div><div class="line"></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">EXPIRE</span> <span class="selector-tag">key3</span> 10     #设置过期时间</div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">key3</span></div><div class="line">"3"</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">ttl</span> <span class="selector-tag">key3</span>    #查看<span class="selector-tag">key</span>的过期时间，<span class="selector-tag">-1</span>不存在过期  <span class="selector-tag">-2</span>不存储键值</div><div class="line">(<span class="selector-tag">integer</span>) <span class="selector-tag">-2</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">EXists</span> <span class="selector-tag">key3</span> </div><div class="line">(<span class="selector-tag">integer</span>) 0</div><div class="line"></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">select</span> 0     #切换库，默认16个库</div><div class="line"><span class="selector-tag">OK</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">select</span> 1</div><div class="line"><span class="selector-tag">OK</span></div><div class="line"></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[1]</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">key1</span> 111   #新建一个键值</div><div class="line"><span class="selector-tag">OK</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[1]</span>&gt; <span class="selector-tag">keys</span> *</div><div class="line">1) "<span class="selector-tag">key1</span>"</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[1]</span>&gt; <span class="selector-tag">move</span> <span class="selector-tag">set1</span> 2    #移动到库2</div><div class="line">(<span class="selector-tag">integer</span>) 0</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[1]</span>&gt; <span class="selector-tag">select</span> 2     #切换库2</div><div class="line"><span class="selector-tag">OK</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[2]</span>&gt; <span class="selector-tag">keys</span> *    </div><div class="line">1) "<span class="selector-tag">key1</span>"</div><div class="line"></div><div class="line"></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[2]</span>&gt; <span class="selector-tag">EXPIRE</span> <span class="selector-tag">key1</span> 200    #设置过期时间</div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[2]</span>&gt; <span class="selector-tag">ttl</span> <span class="selector-tag">key1</span></div><div class="line">(<span class="selector-tag">integer</span>) 193</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[2]</span>&gt; <span class="selector-tag">PERSIST</span> <span class="selector-tag">key1</span>     #取消过期时间</div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[2]</span>&gt; <span class="selector-tag">ttl</span> <span class="selector-tag">key1</span></div><div class="line">(<span class="selector-tag">integer</span>) <span class="selector-tag">-1</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[2]</span>&gt; <span class="selector-tag">RANDOMKEY</span>    #随机返回一个<span class="selector-tag">key</span></div><div class="line">"<span class="selector-tag">key1</span>"</div><div class="line"></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[2]</span>&gt; <span class="selector-tag">RENAME</span> <span class="selector-tag">key1</span> <span class="selector-tag">szk</span>   #更改一个<span class="selector-tag">key</span>的名字</div><div class="line"><span class="selector-tag">OK</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[2]</span>&gt; <span class="selector-tag">keys</span> *</div><div class="line">1) "<span class="selector-tag">szk</span>"</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[2]</span>&gt; <span class="selector-tag">type</span> <span class="selector-tag">szk</span>         #查看一个键值的类型</div><div class="line"><span class="selector-tag">string</span></div></pre></td></tr></table></figure></p>
<p><strong>二十、服务相关的操作</strong><br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[2]</span>&gt; <span class="selector-tag">DBSIZE</span>    #查看一个库的键值数</div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[2]</span>&gt; <span class="selector-tag">select</span> 0</div><div class="line"><span class="selector-tag">OK</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">DBSIZE</span> </div><div class="line">(<span class="selector-tag">integer</span>) 10</div><div class="line"></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">info</span>   #查看<span class="selector-tag">redis</span>服务信息</div><div class="line"># <span class="selector-tag">Server</span></div><div class="line"><span class="selector-tag">redis_version</span><span class="selector-pseudo">:2.8.21</span></div><div class="line"><span class="selector-tag">redis_git_sha1</span><span class="selector-pseudo">:00000000</span></div><div class="line">略</div><div class="line"></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">flushdb</span>    #清空当前数据库中所有的键</div><div class="line"><span class="selector-tag">OK</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">keys</span> *</div><div class="line">(<span class="selector-tag">empty</span> <span class="selector-tag">list</span> <span class="selector-tag">or</span> <span class="selector-tag">set</span>)</div><div class="line"></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">flushall</span>   #清空所有数据库中的所有的<span class="selector-tag">key</span></div><div class="line"><span class="selector-tag">OK</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">SELECT</span> 1</div><div class="line"><span class="selector-tag">OK</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span><span class="selector-attr">[1]</span>&gt; <span class="selector-tag">keys</span> *</div><div class="line">(<span class="selector-tag">empty</span> <span class="selector-tag">list</span> <span class="selector-tag">or</span> <span class="selector-tag">set</span>)</div></pre></td></tr></table></figure></p>
<p><strong>二十一、PHP中应用Redis</strong><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">cd <span class="regexp">/usr/</span>local/src</div><div class="line">wget  <span class="string">http:</span><span class="comment">//pecl.php.net/get/redis-2.2.5.tgz</span></div><div class="line">tar xf redis<span class="number">-2.2</span><span class="number">.5</span>.tgz</div><div class="line">cd redis<span class="number">-2.2</span><span class="number">.5</span></div><div class="line"><span class="regexp">/usr/</span>local<span class="regexp">/php/</span>bin/phpize</div><div class="line">.<span class="regexp">/configure --with-php-config=/</span>usr<span class="regexp">/local/</span>php<span class="regexp">/bin/</span>php-confi</div><div class="line">make ; make install</div><div class="line">mv <span class="regexp">/usr/</span>local<span class="regexp">/php/</span>lib<span class="regexp">/php/</span>extensions<span class="regexp">/no-debug-zts-20100525/</span>redis.so <span class="regexp">/usr/</span>lib64/</div><div class="line"></div><div class="line">vim <span class="regexp">/usr/</span>local<span class="regexp">/php/</span>php.ini</div><div class="line"></div><div class="line">extension_dir = <span class="regexp">/usr/</span>lib64/</div><div class="line">extension = redis.so</div><div class="line"></div><div class="line">usr<span class="regexp">/local/</span>php<span class="regexp">/bin/</span>php -m | grep redis</div><div class="line">redis</div></pre></td></tr></table></figure></p>
<p>加载成功，可以重启 nginx 看看 phpinfo 页</p>
<p><strong>二十二、Redis实现session共享</strong><br>php.ini中加入<br>session.save_handler = “redis”<br>session.save_path = “tcp://127.0.0.1:6379”<br>或者apache虚拟主机加入<br>php_value session.save_handler “redis”<br>php_value session.save_path “tcp://127.0.0.1:6379”<br>或者php-fpm.conf对应的pool中加入<br>php_value[session.save_handler] = redis<br>php_value[session.save_path] = “ tcp://127.0.0.1:6379 “</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;一、Redis介绍&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;redis是一个key-value存储系统，官方站点&lt;a href=&quot;http://redis.io&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://redis.i
    
    </summary>
    
      <category term="redis" scheme="http://yoursite.com/categories/redis/"/>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>nginx+tomcat 配置负载均衡集群</title>
    <link href="http://yoursite.com/2017/04/04/17040401/"/>
    <id>http://yoursite.com/2017/04/04/17040401/</id>
    <published>2017-04-04T02:38:51.000Z</published>
    <updated>2017-04-04T03:40:09.996Z</updated>
    
    <content type="html"><![CDATA[<h5 id="一、Hello-world"><a href="#一、Hello-world" class="headerlink" title="一、Hello world"></a>一、Hello world</h5><h6 id="1、前期环境准备"><a href="#1、前期环境准备" class="headerlink" title="1、前期环境准备"></a>1、前期环境准备</h6><ol>
<li>准备两个解压版tomcat，如何同时启动两个tomcat，方法如下：<br>首先去<a href="http://tomcat.apache.org/download-70.cgi" target="_blank" rel="external">apache tomcat官网</a>下载一个tomcat解压版。<img src="https://static.oschina.net/uploads/space/2017/0328/160127_sJXZ_3203872.png" alt="image"><br>解压该压缩包，生成n份tomcat 分别命名为 tomcat1，tomcat2，<br><img src="https://static.oschina.net/uploads/space/2017/0328/160419_P4o4_3203872.png" alt="image"><br>然后修改server.xml配置文件，分别进入tomcat/conf/目录，修改server.xml，一共三处。<br><img src="https://static.oschina.net/uploads/space/2017/0328/160549_uR0Y_3203872.png" alt="image"><br>第一处：<br><img src="https://static.oschina.net/uploads/space/2017/0329/094952_RXZx_3203872.png" alt="image"><br>第二处、tomcat访问端口号：<br><img src="https://static.oschina.net/uploads/space/2017/0329/095118_fqsy_3203872.png" alt="image"><br>第三处：<br><img src="https://static.oschina.net/uploads/space/2017/0329/095239_9NmQ_3203872.png" alt="image"><br>之后修改bin下的启动文件<br>分别进入tomcat/bin目录，修改 startup.bat<br>在文件第一行添加如下配置（添加时删除#注释，在startup.bat文件中rem代表注释）：在文件第一行添加如下配置（添加时删除#注释，在startup.bat文件中rem代表注释）：<figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># tomcat名称</span></div><div class="line"><span class="keyword">set</span> TITLE=<span class="string">"tomcat1"</span></div><div class="line"><span class="meta"># tomcat启动路径</span></div><div class="line"><span class="keyword">set</span> CATALINA_BASE=<span class="string">"D:\tools\tomcat1"</span></div><div class="line"><span class="keyword">set</span> CATALINA_HOME=<span class="string">"D:\tools\tomcat1"</span></div><div class="line"><span class="meta"># JDK所在路径，如果环境变量已经配置，则可忽略，前提是你所有tomcat要共用一个jdk。另外如果设置，此处路径不能有空格</span></div><div class="line">SET JAVA_HOME=<span class="string">"D:\Java\jdk1.7.0_45"</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>如图：<br><img src="https://static.oschina.net/uploads/space/2017/0329/170630_Ttmb_3203872.png" alt="image"><br><img src="https://static.oschina.net/uploads/space/2017/0329/171827_v9qA_3203872.png" alt="image"><br>启动tomcat<br>平常直接双击startup.bat即可，但是为了查看配置信息，可以在cmd中启动，如下图：<br><img src="https://static.oschina.net/uploads/space/2017/0329/171214_rx4B_3203872.png" alt="image"><br>访问tomcat<br>在浏览器地址栏输入：<a href="http://localhost:8081" target="_blank" rel="external">http://localhost:8081</a> 和 <a href="http://localhost:8082" target="_blank" rel="external">http://localhost:8082</a><br><img src="https://static.oschina.net/uploads/space/2017/0329/171320_bKZP_3203872.png" alt="image"></p>
<ol>
<li><a href="http://nginx.org/en/download.html" target="_blank" rel="external">nginx官网</a>下载解压版nginx。</li>
<li>创建一个简单的web项目。为了直观的区分访问的哪个tomcat，在页面写上标记8081、8082。<img src="https://static.oschina.net/uploads/space/2017/0330/102251_yVyP_3203872.png" alt="image"></li>
<li>分别部署到对应的tomcat下。如图：<img src="https://static.oschina.net/uploads/space/2017/0330/104335_4Scb_3203872.png" alt="image"><h6 id="2、配置nginx"><a href="#2、配置nginx" class="headerlink" title="2、配置nginx"></a>2、配置nginx</h6>进入nginx-1.10.1\conf路径，修改配置文件nginx.conf。</li>
<li><p>配置服务器组，在http{}节点之间添加upstream配置。（注意不要写localhost，不然访问速度会很慢）</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">upstream</span> nginxDemo &#123;</div><div class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span>;   <span class="comment">#服务器地址1</span></div><div class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8082</span>;   <span class="comment">#服务器地址2</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>修改nginx监听的端口号80，改为8080。</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen       <span class="number">8080</span>;</div><div class="line">    ......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在location{}中，利用proxy_pass配置反向代理地址；此处“<a href="http://”不能少，后面的地址要和第一步upstream定义的名称保持一致。" target="_blank" rel="external">http://”不能少，后面的地址要和第一步upstream定义的名称保持一致。</a></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">location</span> / &#123;</div><div class="line">        <span class="attribute">root</span>   html;</div><div class="line">        <span class="attribute">index</span>  index.html index.htm;</div><div class="line">        <span class="attribute">proxy_pass</span> http://nginxDemo; <span class="comment">#配置方向代理地址</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>如下图：<br><img src="https://static.oschina.net/uploads/space/2017/0330/113528_YZCP_3203872.png" alt="image"></p>
<h6 id="3、启动nginx和tomcat，访问"><a href="#3、启动nginx和tomcat，访问" class="headerlink" title="3、启动nginx和tomcat，访问"></a>3、启动nginx和tomcat，访问</h6><p>我是Windows系统，所以直接在nginx-1.10.1目录下双击nginx.exe即可。可在任务管理器中查看：<br><img src="https://static.oschina.net/uploads/space/2017/0330/113005_QuQG_3203872.png" alt="image"><br>最后在浏览器输入地址：<a href="http://localhost:8080/nginxDemo/index.jsp，每次访问就会轮流访问tomcat了（如果F5刷新不管用，建议试试鼠标指针放到地址栏，点击Enter键）。" target="_blank" rel="external">http://localhost:8080/nginxDemo/index.jsp，每次访问就会轮流访问tomcat了（如果F5刷新不管用，建议试试鼠标指针放到地址栏，点击Enter键）。</a><br><img src="https://static.oschina.net/uploads/space/2017/0330/112827_dFRT_3203872.png" alt="image"><br><img src="https://static.oschina.net/uploads/space/2017/0330/112757_RGPA_3203872.png" alt="image"><br>到这里，一个非常简单的负载均衡就配置完成了。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;一、Hello-world&quot;&gt;&lt;a href=&quot;#一、Hello-world&quot; class=&quot;headerlink&quot; title=&quot;一、Hello world&quot;&gt;&lt;/a&gt;一、Hello world&lt;/h5&gt;&lt;h6 id=&quot;1、前期环境准备&quot;&gt;&lt;a href=&quot;#1
    
    </summary>
    
      <category term="负载均衡" scheme="http://yoursite.com/categories/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    
    
      <category term="nginx,java" scheme="http://yoursite.com/tags/nginx-java/"/>
    
  </entry>
  
  <entry>
    <title>Nginx主要应用场景</title>
    <link href="http://yoursite.com/2017/04/03/17040301/"/>
    <id>http://yoursite.com/2017/04/03/17040301/</id>
    <published>2017-04-03T03:23:42.000Z</published>
    <updated>2017-04-03T03:26:42.397Z</updated>
    
    <content type="html"><![CDATA[<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>本文只针对Nginx在不加载第三方模块的情况能处理哪些事情，由于第三方模块太多所以也介绍不完，当然本文本身也可能介绍的不完整，毕竟只是我个人使用过和了解到过得。所以还请见谅，同时欢迎留言交流。</p>
<h4 id="Nginx能做什么"><a href="#Nginx能做什么" class="headerlink" title="Nginx能做什么"></a>Nginx能做什么</h4><h5 id="1-反向代理"><a href="#1-反向代理" class="headerlink" title="1. 反向代理"></a>1. 反向代理</h5><h5 id="2-负载均衡"><a href="#2-负载均衡" class="headerlink" title="2. 负载均衡"></a>2. 负载均衡</h5><h5 id="3-HTTP服务器（包含动静分离）"><a href="#3-HTTP服务器（包含动静分离）" class="headerlink" title="3. HTTP服务器（包含动静分离）"></a>3. HTTP服务器（包含动静分离）</h5><h5 id="4-正向代理"><a href="#4-正向代理" class="headerlink" title="4. 正向代理"></a>4. 正向代理</h5><p>以上就是我了解到的Nginx在不依赖第三方模块能处理的事情，下面详细说明每种功能怎么做。</p>
<h5 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h5><p>反向代理应该是Nginx做的最多的一件事了，什么是反向代理呢，以下是百度百科的说法：反向代理（Reverse Proxy）方式是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。简单来说就是真实的服务器不能直接被外部网络访问，所以需要一台代理服务器，而代理服务器能被外部网络访问的同时又跟真实服务器在同一个网络环境，当然也可能是同一台服务器，端口不同而已。 下面贴上一段简单的实现反向代理的代码。<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="section">server</span> &#123;  </div><div class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;                                                         </div><div class="line">        <span class="attribute">server_name</span>  localhost;                                               </div><div class="line">        <span class="attribute">client_max_body_size</span> <span class="number">1024M</span>;</div><div class="line"></div><div class="line">        <span class="attribute">location</span> / &#123;</div><div class="line">            <span class="attribute">proxy_pass</span> http://localhost:8080;</div><div class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>保存配置文件后启动Nginx，这样当我们访问localhost的时候，就相当于访问localhost:8080了。</p>
<h5 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h5><p>负载均衡也是Nginx常用的一个功能，负载均衡其意思就是分摊到多个操作单元上进行执行，例如Web服务器、FTP服务器、企业关键应用服务器和其它关键任务服务器等，从而共同完成工作任务。简单而言就是当有2台或以上服务器时，根据规则随机的将请求分发到指定的服务器上处理，负载均衡配置一般都需要同时配置反向代理，通过反向代理跳转到负载均衡。而Nginx目前支持自带3种负载均衡策略，还有2种常用的第三方策略。</p>
<h6 id="1、RR（默认）"><a href="#1、RR（默认）" class="headerlink" title="1、RR（默认）"></a>1、RR（默认）</h6><p>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。<br>简单配置<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">upstream</span> test &#123;</div><div class="line">     <span class="attribute">server</span> localhost:<span class="number">8080</span>;</div><div class="line">     <span class="attribute">server</span> localhost:<span class="number">8081</span>;</div><div class="line"> &#125;</div><div class="line"> <span class="section">server</span> &#123;</div><div class="line">     <span class="attribute">listen</span>       <span class="number">81</span>;                                                         </div><div class="line">     <span class="attribute">server_name</span>  localhost;                                               </div><div class="line">     <span class="attribute">client_max_body_size</span> <span class="number">1024M</span>;</div><div class="line"></div><div class="line">     <span class="attribute">location</span> / &#123;</div><div class="line">         <span class="attribute">proxy_pass</span> http://test;</div><div class="line">         <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>负载均衡的核心代码为<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">upstream</span> test &#123;</div><div class="line">    <span class="attribute">server</span> localhost:<span class="number">8080</span>;</div><div class="line">    <span class="attribute">server</span> localhost:<span class="number">8081</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我配置了2台服务器，当然实际上是一台，只是端口不一样而已，而8081的服务器是不存啊在的,也就是说访问不到，但是我们访问<a href="http://localhost" target="_blank" rel="external">http://localhost</a> 的时候,也不会有问题，会默认跳转到<a href="http://localhost:8080" target="_blank" rel="external">http://localhost:8080</a> 具体是因为Nginx会自动判断服务器的状态，如果服务器处于不能访问（服务器挂了），就不会跳转到这台服务器，所以也避免了一台服务器挂了影响使用的情况，由于Nginx默认是RR策略，所以我们不需要其他更多的设置。</p>
<h6 id="2、权重"><a href="#2、权重" class="headerlink" title="2、权重"></a>2、权重</h6><p>指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。 例如<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">upstream</span> test &#123;</div><div class="line">    <span class="attribute">server</span> localhost:<span class="number">8080</span> weight=<span class="number">9</span>;</div><div class="line">    <span class="attribute">server</span> localhost:<span class="number">8081</span> weight=<span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那么10次一般只会有1次会访问到8081，而有9次会访问到8080</p>
<h6 id="3、ip-hash"><a href="#3、ip-hash" class="headerlink" title="3、ip_hash"></a>3、ip_hash</h6><p>上面的2种方式都有一个问题，那就是下一个请求来的时候请求可能分发到另外一个服务器，当我们的程序不是无状态的时候（采用了session保存数据），这时候就有一个很大的很问题了，比如把登录信息保存到了session中，那么跳转到另外一台服务器的时候就需要重新登录了，所以很多时候我们需要一个客户只访问一个服务器，那么就需要用iphash了，iphash的每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream test &#123;</div><div class="line">    ip_hash<span class="comment">;</span></div><div class="line">    server localhost:<span class="number">8080</span><span class="comment">;</span></div><div class="line">    server localhost:<span class="number">8081</span><span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h6 id="4、fair（第三方）"><a href="#4、fair（第三方）" class="headerlink" title="4、fair（第三方）"></a>4、fair（第三方）</h6><p>按后端服务器的响应时间来分配请求，响应时间短的优先分配。<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream <span class="keyword">backend </span>&#123; </div><div class="line">    fair<span class="comment">; </span></div><div class="line">    server localhost:<span class="number">8080</span><span class="comment">;</span></div><div class="line">    server localhost:<span class="number">8081</span><span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h6 id="5、url-hash（第三方）"><a href="#5、url-hash（第三方）" class="headerlink" title="5、url_hash（第三方）"></a>5、url_hash（第三方）</h6><p>按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。 在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">upstream</span> backend &#123; </div><div class="line">    <span class="attribute">hash</span> <span class="variable">$request_uri</span>; </div><div class="line">    <span class="attribute">hash_method</span> crc32; </div><div class="line">    <span class="attribute">server</span> localhost:<span class="number">8080</span>;</div><div class="line">    <span class="attribute">server</span> localhost:<span class="number">8081</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以上5种负载均衡各自适用不同情况下使用，所以可以根据实际情况选择使用哪种策略模式,不过fair和url_hash需要安装第三方模块才能使用，由于本文主要介绍Nginx能做的事情，所以Nginx安装第三方模块不会再本文介绍</p>
<h5 id="HTTP服务器"><a href="#HTTP服务器" class="headerlink" title="HTTP服务器"></a>HTTP服务器</h5><p>Nginx本身也是一个静态资源的服务器，当只有静态资源的时候，就可以使用Nginx来做服务器，同时现在也很流行动静分离，就可以通过Nginx来实现，首先看看Nginx做静态资源服务器<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="section">server</span> &#123;</div><div class="line">       <span class="attribute">listen</span>       <span class="number">80</span>;                                                         </div><div class="line">       <span class="attribute">server_name</span>  localhost;                                               </div><div class="line">       <span class="attribute">client_max_body_size</span> <span class="number">1024M</span>;</div><div class="line"></div><div class="line"></div><div class="line">       <span class="attribute">location</span> / &#123;</div><div class="line">              <span class="attribute">root</span>   e:\wwwroot;</div><div class="line">              <span class="attribute">index</span>  index.html;</div><div class="line">          &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这样如果访问<a href="http://localhost" target="_blank" rel="external">http://localhost</a> 就会默认访问到E盘wwwroot目录下面的index.html，如果一个网站只是静态页面的话，那么就可以通过这种方式来实现部署。</p>
<h5 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h5><p>动静分离是让动态网站里的动态网页根据一定规则把不变的资源和经常变的资源区分开来，动静资源做好了拆分以后，我们就可以根据静态资源的特点将其做缓存操作，这就是网站静态化处理的核心思路<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">upstream</span> test&#123;  </div><div class="line">       <span class="attribute">server</span> localhost:<span class="number">8080</span>;  </div><div class="line">       <span class="attribute">server</span> localhost:<span class="number">8081</span>;  </div><div class="line">    &#125;   </div><div class="line"></div><div class="line">    <span class="section">server</span> &#123;  </div><div class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;  </div><div class="line">        <span class="attribute">server_name</span>  localhost;  </div><div class="line"></div><div class="line">        <span class="attribute">location</span> / &#123;  </div><div class="line">            <span class="attribute">root</span>   e:\wwwroot;  </div><div class="line">            <span class="attribute">index</span>  index.html;  </div><div class="line">        &#125;  </div><div class="line"></div><div class="line">        <span class="comment"># 所有静态请求都由nginx处理，存放目录为html  </span></div><div class="line">        <span class="attribute">location</span> <span class="regexp">~ \.(gif|jpg|jpeg|png|bmp|swf|css|js)$</span> &#123;  </div><div class="line">            <span class="attribute">root</span>    e:\wwwroot;  </div><div class="line">        &#125;  </div><div class="line"></div><div class="line">        <span class="comment"># 所有动态请求都转发给tomcat处理  </span></div><div class="line">        <span class="attribute">location</span> <span class="regexp">~ \.(jsp|do)$</span> &#123;  </div><div class="line">            <span class="attribute">proxy_pass</span>  http://test;  </div><div class="line">        &#125;  </div><div class="line"></div><div class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;  </div><div class="line">        <span class="attribute">location</span> = /50x.html &#123;  </div><div class="line">            <span class="attribute">root</span>   e:\wwwroot;  </div><div class="line">        &#125;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这样我们就可以吧HTML以及图片和css以及js放到wwwroot目录下，而tomcat只负责处理jsp和请求，例如当我们后缀为gif的时候，Nginx默认会从wwwroot获取到当前请求的动态图文件返回，当然这里的静态文件跟Nginx是同一台服务器，我们也可以在另外一台服务器，然后通过反向代理和负载均衡配置过去就好了，只要搞清楚了最基本的流程，很多配置就很简单了，另外localtion后面其实是一个正则表达式，所以非常灵活</p>
<h5 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h5><p>正向代理，意思是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端才能使用正向代理。当你需要把你的服务器作为代理服务器的时候，可以用Nginx来实现正向代理，但是目前Nginx有一个问题，那么就是不支持HTTPS，虽然我百度到过配置HTTPS的正向代理，但是到最后发现还是代理不了，当然可能是我配置的不对，所以也希望有知道正确方法的同志们留言说明一下。<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">resolver</span> <span class="number">114.114.114.114</span> <span class="number">8.8.8.8</span>;</div><div class="line"><span class="section">server</span> &#123;</div><div class="line"></div><div class="line">    <span class="attribute">resolver_timeout</span> <span class="number">5s</span>;</div><div class="line"></div><div class="line">    <span class="attribute">listen</span> <span class="number">81</span>;</div><div class="line"></div><div class="line">    <span class="attribute">access_log</span>  e:\wwwroot\proxy.access.log;</div><div class="line">    <span class="attribute">error_log</span>   e:\wwwroot\proxy.<span class="literal">error</span>.log;</div><div class="line"></div><div class="line">    <span class="attribute">location</span> / &#123;</div><div class="line">        <span class="attribute">proxy_pass</span> http://<span class="variable">$host</span><span class="variable">$request_uri</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>resolver是配置正向代理的DNS服务器，listen 是正向代理的端口，配置好了就可以在ie上面或者其他代理插件上面使用服务器ip+端口号进行代理了。</p>
<h5 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h5><p>Nginx是支持热启动的，也就是说当我们修改配置文件后，不用关闭Nginx，就可以实现让配置生效，当然我并不知道多少人知道这个，反正我一开始并不知道，导致经常杀死了Nginx线程再来启动。。。Nginx从新读取配置的命令是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nginx <span class="_">-s</span> reload</div></pre></td></tr></table></figure>
<p>windows下面就是</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nginx<span class="selector-class">.exe</span> -s reload</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h4&gt;&lt;p&gt;本文只针对Nginx在不加载第三方模块的情况能处理哪些事情，由于第三方模块太多所以也介绍不完，当然本文本身也可能介绍的不完整，毕竟只是我个人
    
    </summary>
    
      <category term="nginx" scheme="http://yoursite.com/categories/nginx/"/>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>Zabbix安装配置</title>
    <link href="http://yoursite.com/2017/04/02/17040202/"/>
    <id>http://yoursite.com/2017/04/02/17040202/</id>
    <published>2017-04-02T14:31:38.000Z</published>
    <updated>2017-04-03T01:43:56.117Z</updated>
    
    <content type="html"><![CDATA[<h6 id="zabbix安装配置"><a href="#zabbix安装配置" class="headerlink" title="zabbix安装配置"></a>zabbix安装配置</h6><p>安装zabbix<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y epel-<span class="keyword">release</span></div></pre></td></tr></table></figure></p>
<p>安装rpm包的lamp环境<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install </span>-y  httpd mysql mysql-libs php php-mysql mysql-server php-<span class="keyword">bcmath </span>php-gd php-mbstring</div></pre></td></tr></table></figure></p>
<p>安装zabbix服务端<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span>  zabbix20 zabbix20-<span class="keyword">agent</span> zabbix20-<span class="keyword">server</span>  zabbix20-<span class="keyword">server</span>-mysql zabbix20-web zabbix20-web-mysql net-snmp-devel</div></pre></td></tr></table></figure></p>
<p>启动服务<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/zabbix-server <span class="keyword">start</span>; /etc/init.d/zabbix-agent <span class="keyword">start</span>; /etc/init.d/httpd <span class="keyword">start</span>;</div></pre></td></tr></table></figure></p>
<p>修改一下mysql配置文件<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">vim /etc/my.cnf    <span class="comment">//修改或增加如下内容</span></div><div class="line"></div><div class="line">[mysql]</div><div class="line"><span class="keyword">default</span>-character-<span class="keyword">set</span> = utf8</div><div class="line"></div><div class="line">[mysqld]</div><div class="line">character_set_server = utf8</div></pre></td></tr></table></figure></p>
<p>启动mysql服务<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/etc/i</span>nit.d<span class="regexp">/mysqld start</span></div></pre></td></tr></table></figure></p>
<p>建库，导入数据<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -<span class="selector-tag">p</span> -e  <span class="string">"create database zabbix"</span></div><div class="line">mysql -uroot -<span class="selector-tag">p</span> --default-character-set=utf8 zabbix &lt; /usr/share/zabbix-mysql/schema<span class="selector-class">.sql</span></div><div class="line">mysql -uroot -<span class="selector-tag">p</span> --default-character-set=utf8 zabbix &lt; /usr/share/zabbix-mysql/images<span class="selector-class">.sql</span></div><div class="line">mysql -uroot -<span class="selector-tag">p</span> --default-character-set=utf8  zabbix &lt; /usr/share/zabbix-mysql/data.sql</div></pre></td></tr></table></figure></p>
<p>网页安装zabbix<br>浏览器访问 <a href="http://ip/zabbix" target="_blank" rel="external">http://ip/zabbix</a>, 默认会有“It is not safe to rely on the system‘s timezone settings ”这样的警告信息，需要vim /etc/php.ini 设置 date.timezone=“Asia/Shanghai”点next<br>解决相关的报错信息，点retry  (vim /etc/php.ini)<br>输入mysql相关信息, 首先要测试一下，如果不通过，则需要调试，测试通过后，点next<br>Name 写127.0.0.1，（可以自定义）点next，再点next，最后点finish<br>默认管理员账号密码为 admin:zabbix<br>这时会遇到“zabbix server is not running”这样的错误，需要编辑一下 /etc/zabbix/zabbix_server.conf ，配置DBUser, DBPassword<br>接入要监控的主机<br>在客户端上<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> zabbix20-<span class="keyword">agent</span></div><div class="line">vim /etc/zabbix_agentd.conf </div><div class="line">//更改<span class="keyword">Server</span>=服务端ip; </div><div class="line"></div><div class="line">ServerActive=0.0.0.0:10050</div><div class="line">Hostname=xxx</div></pre></td></tr></table></figure></p>
<p>启动客户端<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">etc<span class="regexp">/init.d/</span>zabbix-agent start</div></pre></td></tr></table></figure></p>
<p>服务端上命令行测试：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">zabbix_get</span> -s 客户端<span class="built_in">ip</span> -p10050 -k <span class="string">"system.hostname"</span></div></pre></td></tr></table></figure></p>
<p>在web界面下，点”configuration” –&gt; “host” –&gt; 右上角点”Create Host”  其中host name,  visible name自定义，可以选择groups，这里默认即可，ip address 写入客户端ip<br>配置监控项目模板：点“templates”, 点add, 在弹出的小窗口中选择Template OS Linux, 然后点select, 最后点save<br>自定义templates<br>Zabbix自带了很多模板，模板中有很多监控项目，比如CPU、网卡、内存、进程等等。使用系统自带模板有点太多了，所以我们可以自定义模板。点configuration 选择 templates，点右上角的create template<br>Template name和Visible name  自定义，Groups 选择templates, 点save<br>然后我们去挑选一些项目拷贝到该模板下：比如我们找到Template OS Linux 点一下items,选择我们想要的项目，然后在下面选择copy selected to … 然后点go<br>Group 选择templates, 找到刚才我们自定义的templates,点copy<br>点configuration 选择 templates可以看到新建的templates中已经有刚刚我们copy的items了<br>我们可以使用和上面相同的方法自定义拷贝Triggers（触发器 ）,它用来设置告警的阀值，当然我们也可以自定义编辑它。<br>例如：<a href="http://ask.apelearn.com/question/8091" target="_blank" rel="external">监控客户端网卡流量</a><br>配置发邮件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">yum install -y sendmail </div><div class="line">mkdir -p /home/zabbix/bin</div><div class="line">vim /home/zabbix/bin/baojing.sh //加入内容：</div><div class="line"></div><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$3</span>"</span> |/bin/mail <span class="_">-s</span> <span class="string">"<span class="variable">$2</span>"</span> <span class="variable">$1</span></div><div class="line">//保存退出后给予执行权限</div><div class="line">chmod +x /home/zabbix/bin/baojing.sh</div></pre></td></tr></table></figure></p>
<p>在zabbix_server.conf配置文件中，有参数AlertScriptsPath和ExternalScripts<br>AlertScriptsPath=/home/zabbix/bin/ —用户自定义的media types脚本<br>ExternalScripts=/home/zabbix/bin/ —用户自定义的检查的脚本（item）<br>这样才能找到你的脚本，因为你在frontend中只是输入脚本的名称，没有路径。<br>创建mediea types: “Administration” –&gt;”Media types”，点击右上角“Create Media Type”其中Description填”baojing” 或其它自定义名称，Type选择”Script”，Script填”baojing.sh”然后点”Save”.<br>创建user: “Adimistration” –&gt; “Users”在右上角，选择”Users”，点击”Create User”, alias: test1,自定义name和lastname password:123456;group 选择guest，回到上面点一下media,type 选择baojing，send to 写要发送邮件的邮箱，点add, 最后点save<br>创建action: “configuration” –&gt; actions,右上角“Create Actions”, Name自定义，我这里写”baojing”,其他默认，然后点右侧的“Operations”下的“New”按钮，“Operation Type”选择“Send message”，“Send Message to”选择一个或多个要发送消息的用户组，Send to Users选择我们之前新增的test1, “Send only to”选择baojing , 点一下add<br>最后点save。</p>
<p>扩展：<br><a href="http://zhujiangtao.blog.51cto.com/6387416/1313630" target="_blank" rel="external">zabbix历史记录乱码问题</a><br><a href="http://ask.apelearn.com/question/8090" target="_blank" rel="external">zabbix图形中乱码问题</a><br><a href="http://xianglinhu.blog.51cto.com/5787032/d-6" target="_blank" rel="external">Zabbix自定义监控脚本配置</a><br><a href="http://xianglinhu.blog.51cto.com/5787032/d-6" target="_blank" rel="external">Zabbix汇总</a></p>
<hr>
]]></content>
    
    <summary type="html">
    
      &lt;h6 id=&quot;zabbix安装配置&quot;&gt;&lt;a href=&quot;#zabbix安装配置&quot; class=&quot;headerlink&quot; title=&quot;zabbix安装配置&quot;&gt;&lt;/a&gt;zabbix安装配置&lt;/h6&gt;&lt;p&gt;安装zabbix&lt;br&gt;&lt;figure class=&quot;highlight s
    
    </summary>
    
      <category term="monitor" scheme="http://yoursite.com/categories/monitor/"/>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>Nagios 安装和配置</title>
    <link href="http://yoursite.com/2017/04/02/17040201/"/>
    <id>http://yoursite.com/2017/04/02/17040201/</id>
    <published>2017-04-01T16:35:21.000Z</published>
    <updated>2017-04-01T16:36:47.284Z</updated>
    
    <content type="html"><![CDATA[<h5 id="Nagios-安装和配置"><a href="#Nagios-安装和配置" class="headerlink" title="Nagios 安装和配置"></a>Nagios 安装和配置</h5><p>Nagios官网:<a href="http://www.nagios.org" target="_blank" rel="external">http://www.nagios.org</a><br>实验环境：一台服务端（IP：192.168.0.200）；一台客户端（IP：192.168.0.201）。</p>
<h6 id="1-Nagios安装-服务端（192-168-0-200）"><a href="#1-Nagios安装-服务端（192-168-0-200）" class="headerlink" title="1. Nagios安装 - 服务端（192.168.0.200）"></a>1. Nagios安装 - 服务端（192.168.0.200）</h6><p>Centos6默认的yum源里没有nagios相关的rpm包，但是我们可以安装一个epel的扩展源：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y epel-<span class="keyword">release</span></div></pre></td></tr></table></figure></p>
<p>然后安装nagios相关的包<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y httpd nagios nagios-plugins nagios-plugins-<span class="keyword">all</span> nrpe nagios-plugins-nrpe</div></pre></td></tr></table></figure></p>
<p>设置登录nagios后台的用户和密码：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">htpasswd -c <span class="regexp">/etc/</span>nagios<span class="regexp">/passwd nagiosadmin</span></div></pre></td></tr></table></figure></p>
<p>检测配置文件<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nagios -v <span class="regexp">/etc/</span>nagios<span class="regexp">/nagios.cfg</span></div></pre></td></tr></table></figure></p>
<p>启动服务：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service httpd <span class="keyword">start</span>; service nagios <span class="keyword">start</span></div></pre></td></tr></table></figure></p>
<p>浏览器访问： http:/192.168.0.200ip/nagios/</p>
<h6 id="2-Nagios安装-客户端（192-168-0-201）"><a href="#2-Nagios安装-客户端（192-168-0-201）" class="headerlink" title="2. Nagios安装 - 客户端（192.168.0.201）"></a>2. Nagios安装 - 客户端（192.168.0.201）</h6><p>在客户端机器上:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">yum install -y epel-release</div><div class="line">yum install -y nagios-plugins nagios-plugins-all nrpe nagios-plugins-nrpe </div><div class="line"></div><div class="line">vim /etc/nagios/nrpe.cfg</div><div class="line">找到“allowed_hosts=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>” 改为 “allowed_hosts=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>,<span class="number">192.168</span><span class="number">.0</span><span class="number">.200</span>”</div><div class="line">找到” dont_blame_nrpe=<span class="number">0</span>” 改为  “dont_blame_nrpe=<span class="number">1</span>”</div></pre></td></tr></table></figure></p>
<p>启动客户端<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/etc/i</span>nit.d<span class="regexp">/nrpe start</span></div></pre></td></tr></table></figure></p>
<h6 id="3-监控中心（192-168-0-200）添加被监控主机（192-168-0-201）"><a href="#3-监控中心（192-168-0-200）添加被监控主机（192-168-0-201）" class="headerlink" title="3. 监控中心（192.168.0.200）添加被监控主机（192.168.0.201）"></a>3. 监控中心（192.168.0.200）添加被监控主机（192.168.0.201）</h6><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">cd /etc/nagios/conf.d/</div><div class="line">vim <span class="number">192.168</span><span class="number">.0</span><span class="number">.201</span>.cfg                   <span class="comment">//加入：</span></div><div class="line">define host&#123;</div><div class="line">        use                     linux-server            </div><div class="line">        host_name           <span class="number">192.168</span><span class="number">.0</span><span class="number">.201201</span></div><div class="line">        alias                       <span class="number">0.201</span></div><div class="line">        address                 <span class="number">192.168</span><span class="number">.0</span><span class="number">.201</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">        use                     generic-service</div><div class="line">        host_name               <span class="number">192.168</span><span class="number">.0</span><span class="number">.201</span></div><div class="line">        service_description     check_ping</div><div class="line">        check_command           check_ping!<span class="number">100.0</span>,<span class="number">20</span>%!<span class="number">200.0</span>,<span class="number">50</span>%</div><div class="line">        max_check_attempts <span class="number">5</span></div><div class="line">        normal_check_interval <span class="number">1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">        use                     generic-service</div><div class="line">        host_name               <span class="number">192.168</span><span class="number">.0</span><span class="number">.201</span></div><div class="line">        service_description     check_ssh</div><div class="line">        check_command           check_ssh</div><div class="line">        max_check_attempts <span class="number">5</span> ；当nagios检测到问题时，一共尝试检测<span class="number">5</span>次都有问题才会告警，如果该数值为<span class="number">1</span>，那么检测到问题立即告警</div><div class="line">        normal_check_interval <span class="number">1</span> ；重新检测的时间间隔，单位是分钟，默认是<span class="number">3</span>分钟</div><div class="line">        notification_interval <span class="number">60</span> ；在服务出现异常后，故障一直没有解决，nagios再次对使用者发出通知的时间。单位是分钟。如果你认为，所有的事件只需要一次通知就够了，可以把这里的选项设为<span class="number">0</span>。 </div><div class="line">&#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">        use                     generic-service</div><div class="line">        host_name               <span class="number">192.168</span><span class="number">.0</span><span class="number">.201</span></div><div class="line">        service_description     check_http</div><div class="line">        check_command           check_http</div><div class="line">        max_check_attempts      <span class="number">5</span></div><div class="line">        normal_check_interval <span class="number">1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上服务不依赖于客户端nrpe服务，我们可以想象，我们在自己电脑上可以使用ping或者telnet探测远程任何一台机器是否存活、是否开启某个端口或服务。 而当我们想要检测客户端上的某个具体服务的情况时，就需要借助于nrpe了，比如想知道客户端机器的负责或磁盘使用情况。</p>
<h6 id="4-继续添加服务"><a href="#4-继续添加服务" class="headerlink" title="4.  继续添加服务"></a>4.  继续添加服务</h6><p>服务端<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">vim /etc/nagios/objects/commands.cfg</div><div class="line"><span class="comment">//增加：</span></div><div class="line">    define command&#123;</div><div class="line">        command_name    check_nrpe</div><div class="line">        command_line    <span class="symbol">$</span>USER1<span class="symbol">$</span>/check_nrpe -H <span class="symbol">$</span>HOSTADDRESS<span class="symbol">$</span> -c <span class="symbol">$</span>ARG1<span class="symbol">$</span></div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>继续编辑<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">vim /etc/nagios/conf.d/<span class="number">192.168</span><span class="number">.0</span><span class="number">.12</span>.cfg</div><div class="line"><span class="comment">//增加如下内容：</span></div><div class="line"></div><div class="line">define service&#123;</div><div class="line">        use     generic-service</div><div class="line">        host_name       <span class="number">192.168</span><span class="number">.0</span><span class="number">.12</span></div><div class="line">        service_description     check_load</div><div class="line">        check_command           check_nrpe!check_load</div><div class="line">        max_check_attempts <span class="number">5</span></div><div class="line">        normal_check_interval <span class="number">1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">define service&#123;</div><div class="line">        use     generic-service</div><div class="line">        host_name       <span class="number">192.168</span><span class="number">.0</span><span class="number">.12</span></div><div class="line">        service_description     check_disk_hda1</div><div class="line">        check_command           check_nrpe!check_hda1</div><div class="line">        max_check_attempts <span class="number">5</span></div><div class="line">        normal_check_interval <span class="number">1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">define service&#123;</div><div class="line">        use     generic-service</div><div class="line">        host_name       <span class="number">192.168</span><span class="number">.0</span><span class="number">.12</span></div><div class="line">        service_description     check_disk_hda2</div><div class="line">        check_command           check_nrpe!check_hda2</div><div class="line">        max_check_attempts <span class="number">5</span></div><div class="line">        normal_check_interval <span class="number">1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>说明：<br>check_nrpe!check_load：这里的check_nrpe就是在commands.cfg刚刚定义的，check_load是远程主机上的一个检测脚本<br>在远程主机上vim /etc/nagios/nrpe.cfg 搜索check_load，这行就是在服务端上要执行的脚本了，我们可以手动执行这个脚本<br>把check_hda1更改一下：/dev/hda1 改为 /dev/sda1<br>再加一行command[check_hda2]=/usr/lib/nagios/plugins/check_disk -w 20% -c 10% -p /dev/sda2<br>客户端上重启一下nrpe服务:<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">service nrpe restart</span></div></pre></td></tr></table></figure></p>
<p>服务端也重启一下nagios服务:<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">service nagios restart</span></div></pre></td></tr></table></figure></p>
<h6 id="5-配置告警"><a href="#5-配置告警" class="headerlink" title="5.   配置告警"></a>5.   配置告警</h6><figure class="highlight llvm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">vim /etc/nagios/objects/contacts.cfg </div><div class="line">//增加：</div><div class="line"></div><div class="line"><span class="keyword">define</span> contact&#123;</div><div class="line">        contact_name               <span class="number">123</span></div><div class="line">        use                             generic-contact</div><div class="line">        <span class="keyword">alias</span>                           aming</div><div class="line">        email              lishiming<span class="number">2009</span><span class="title">@139</span>.com</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">define</span> contact&#123;</div><div class="line">        contact_name               <span class="number">456</span></div><div class="line">        use                             generic-contact</div><div class="line">        <span class="keyword">alias</span>                            aaa</div><div class="line">        email              aminglinux<span class="title">@139</span>.com</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">define</span> contactgroup&#123;</div><div class="line">        contactgroup_name           <span class="keyword">common</span></div><div class="line">        <span class="keyword">alias</span>                                  <span class="keyword">common</span></div><div class="line">        members                          <span class="number">123</span>,<span class="number">456</span></div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>然后在要需要告警的服务里面加上contactgroup</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">define</span> service&#123;</div><div class="line">        use     generic-service</div><div class="line">        host_name       <span class="number">192.168</span>.<span class="number">0.12</span></div><div class="line">        service_description     check_load</div><div class="line">        check_command           check_nrpe<span class="title">!check_load</span></div><div class="line">        max_check_attempts <span class="number">5</span></div><div class="line">        normal_check_interval <span class="number">1</span></div><div class="line">        contact_groups        <span class="keyword">common</span></div><div class="line">        notifications_enabled  <span class="number">1</span>    ；是否开启提醒功能。<span class="number">1</span>为开启，<span class="number">0</span>为禁用。一般，这个选项会在主配置文件（nagios.cfg）中定义，效果相同。</div><div class="line">        notification_period   <span class="number">24</span><span class="keyword">x</span><span class="number">7</span>   ；发送提醒的时间段。非常重要的主机（服务）我定义为<span class="number">7</span>×<span class="number">24</span>，一般的主机（服务）就定义为上班时间。如果不在定义的时间段内，无论什么问题发生，都不会发送提醒。        </div><div class="line">        notification_options:w,u,<span class="keyword">c</span>,r   ；这个是service的状态。w为waning， u为unknown, <span class="keyword">c</span>为critical, r为recover(恢复了），类似的还有一个  host对应的状态：d,u,r   d = 状态为DOWN, u = 状态为UNREACHABLE , r = 状态恢复为OK，需要加入到host的定义配置里。</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>扩展：<br><a href="http://www.aminglinux.com/bbs/thread-7380-1-1.html" target="_blank" rel="external">调用短信接口</a><br><a href="http://www.aminglinux.com/bbs/thread-7917-1-1.html" target="_blank" rel="external">整合微信</a></p>
<h6 id="6-配置图形显示-pnp4nagios"><a href="#6-配置图形显示-pnp4nagios" class="headerlink" title="6.   配置图形显示 pnp4nagios"></a>6.   配置图形显示 pnp4nagios</h6><p>安装<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> pnp4nagios rrdtool</div></pre></td></tr></table></figure></p>
<p>配置主配置文件<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">vim /etc/nagios/nagios.cfg  //修改如下配置</div><div class="line"></div><div class="line">process_performance_data=1   </div><div class="line">host_perfdata_command=process-host-perfdata</div><div class="line">service_perfdata_command=process-service-perfdata</div><div class="line">enable_environment_macros=1</div></pre></td></tr></table></figure></p>
<p>修改commands.cfg<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">vim <span class="meta-keyword">/etc/</span>nagios<span class="meta-keyword">/objects/</span>commands.cfg  <span class="comment">//注释掉原有对process-host-perfdata和process-service-perfdata，重新定义</span></div><div class="line"></div><div class="line">define <span class="class">command </span>&#123;  </div><div class="line">       command_name    process-service-perfdata  </div><div class="line">       command_line    <span class="meta-keyword">/usr/</span>bin/perl <span class="meta-keyword">/usr/</span>libexec<span class="meta-keyword">/pnp4nagios/</span>process_perfdata.pl  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">define <span class="class">command </span>&#123;  </div><div class="line">       command_name    process-host-perfdata  </div><div class="line">       command_line    <span class="meta-keyword">/usr/</span>bin/perl <span class="meta-keyword">/usr/</span>libexec<span class="meta-keyword">/pnp4nagios/</span>process_perfdata.pl -d HOSTPERFDATA  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>修改配置文件templates.cfg</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">vim /etc/nagios/objects/templates.cfg <span class="keyword">define</span> <span class="section">host</span> &#123;</div><div class="line">        name       hosts-pnp</div><div class="line">        register   0</div><div class="line">        action_url /pnp4nagios/index.php/graph?host=<span class="variable">$HOSTNAME</span>$&amp;srv=_HOST_</div><div class="line">        process_perf_data               1</div><div class="line">&#125;</div><div class="line"><span class="keyword">define</span> <span class="section">service</span> &#123;</div><div class="line">        name       srv-pnp</div><div class="line">        register   0</div><div class="line">        action_url /pnp4nagios/index.php/graph?host=<span class="variable">$HOSTNAME</span>$&amp;srv=<span class="variable">$SERVICEDESC</span>$</div><div class="line">        process_perf_data               1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>修改host和service配置</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">vim /etc/nagios/conf.d/<span class="number">192.168</span><span class="number">.0</span><span class="number">.12</span>.cfg </div><div class="line">把 “define host&#123;</div><div class="line">        use                     linux-server” </div><div class="line">改为：</div><div class="line">define host&#123;</div><div class="line">        use                     linux-server,hosts-pnp</div><div class="line"></div><div class="line">修改对应的service，比如</div><div class="line">把</div><div class="line">define service&#123;</div><div class="line">        use     generic-service</div><div class="line">        host_name       <span class="number">192.168</span><span class="number">.0</span><span class="number">.12</span></div><div class="line">        service_description     check_disk_hda1</div><div class="line">        check_command           check_nrpe!check_hda1</div><div class="line">        max_check_attempts <span class="number">5</span></div><div class="line">        normal_check_interval <span class="number">1</span></div><div class="line">&#125;</div><div class="line">改为：</div><div class="line">define service&#123;</div><div class="line">        use     generic-service,srv-pnp</div><div class="line">        host_name       <span class="number">192.168</span><span class="number">.0</span><span class="number">.12</span></div><div class="line">        service_description     check_disk_hda1</div><div class="line">        check_command           check_nrpe!check_hda1</div><div class="line">        max_check_attempts <span class="number">5</span></div><div class="line">        normal_check_interval <span class="number">1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重启和启动各个服务：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">service nagios <span class="built_in">restart</span></div><div class="line">service httpd <span class="built_in">restart</span></div><div class="line">service npcd start</div></pre></td></tr></table></figure></p>
<p>两种访问方法：</p>
<p>ip/nagios/<br>ip/pnp4nagios/</p>
]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;Nagios-安装和配置&quot;&gt;&lt;a href=&quot;#Nagios-安装和配置&quot; class=&quot;headerlink&quot; title=&quot;Nagios 安装和配置&quot;&gt;&lt;/a&gt;Nagios 安装和配置&lt;/h5&gt;&lt;p&gt;Nagios官网:&lt;a href=&quot;http://www.n
    
    </summary>
    
      <category term="monitor" scheme="http://yoursite.com/categories/monitor/"/>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>CentOS上搭建Git服务器</title>
    <link href="http://yoursite.com/2017/04/01/17040102/"/>
    <id>http://yoursite.com/2017/04/01/17040102/</id>
    <published>2017-04-01T08:43:10.000Z</published>
    <updated>2017-04-01T08:43:57.039Z</updated>
    
    <content type="html"><![CDATA[<p>Git是一个分布式版本控制软件，原来是linux内核开发者Linus Torvalds为了更好地管理linux内核开发而创立的。发展至今，Git已经成为了一个相当好用的版本管理工具。相比于SVN，如果想要保存一些微小的修改也必须得提交服务器保存才可以，这样使服务器的版本号过多，而Git解决了这个问题，一些小的修改只在本地提交即可，只需最后修改完成后再提交服务器。正是由于这样的便捷性，现在越来越多的社区项目都开始使用Git来取代SVN之类较为传统的版本管理工具进行开发。<br>使用CentOS搭建Git服务器是一件比较轻松的事儿，本次折腾主要涉及git, gitosis, gitweb的安装配置。其中，gitosis和gitweb是两种比较常用的方式，gitosis是以SSH方式访问和管理git， gitweb是通过http的方式访问和管理。利用这些工具即可满足Git服务器的基本功能。此外比较好的一点是，Git的管理工具几乎不会给服务器带来较大的性能压力。下面正式开始我们的Git安装配置记录。</p>
<h6 id="一、安装Git"><a href="#一、安装Git" class="headerlink" title="一、安装Git"></a>一、安装Git</h6><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> git</div></pre></td></tr></table></figure>
<p>然后进行配置：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">useradd --<span class="built_in">home</span> /<span class="built_in">home</span>/git git</div><div class="line">passwd git</div></pre></td></tr></table></figure></p>
<p>创建完用户后就可以切换到git用户下进行后面的设置，如用户名和邮箱：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">su git</div><div class="line">git config --global user<span class="selector-class">.name</span> <span class="string">"somebody"</span></div><div class="line">git config --global user<span class="selector-class">.email</span> <span class="string">"somebody@example.com"</span></div></pre></td></tr></table></figure></p>
<p>设置默认将会保存在~/.gitconfig文件中。<br>此时，Git的功能就已经可以使用了。为了方便后面的操作，可以先来创建一个空版本库。<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">mkdir</span> ~/repo</div></pre></td></tr></table></figure></p>
<p>然后建立项目目录<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">mkdir</span> ~/repo/huhamhire-hosts</div></pre></td></tr></table></figure></p>
<p>切换到项目目录，并进行初始化<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd ~<span class="regexp">/repo/</span>huhamhire-hosts</div><div class="line">git init -bare</div></pre></td></tr></table></figure></p>
<p>至此，一个初始的空项目版本库就配置完成了，后面安装了gitosis之后便可向库中推送我们的代码库内容。</p>
<h6 id="二、安装gitosis"><a href="#二、安装gitosis" class="headerlink" title="二、安装gitosis"></a>二、安装gitosis</h6><p>在安装之前，可以看一下gitosis的实现原理：<br><a href="http://geeklu.com/2012/10/gitosis/" target="_blank" rel="external">浅谈Gitosis实现原理</a><br>先切换回root权限。<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">su root</span></div></pre></td></tr></table></figure></p>
<p>并先安装python-setuptool<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> python-setuptools</div></pre></td></tr></table></figure></p>
<p>然后开始安装gitosis，值得注意的是gitosis的安装程序本身就是由git管理的，需要使用git来获取。这里在/tmp目录下进行相关的安装操作：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /tmp</div><div class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/res0nat0r/gitosis.git</div></pre></td></tr></table></figure></p>
<p>接下来进入下载的gitosis版本库进行安装:<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> gitosis</div><div class="line"><span class="keyword">python</span> setup.<span class="keyword">py</span> install</div></pre></td></tr></table></figure></p>
<p>安装完成后，便进入对gitosis的设置阶段。由于gitosis需要通过SSH进行管理，所以需要创建SSH密钥对，并将公钥放在服务器端，私钥放在客户端。一般的流程是客户端创建完密钥后，将公钥传到服务器上生效。不过，偷懒的话直接在服务器上操作问题也不大。</p>
<p>切换到git用户并建立文件夹.ssh：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">su git</div><div class="line"><span class="built_in">mkdir</span> /<span class="built_in">home</span>/git/.ssh</div></pre></td></tr></table></figure></p>
<p>一定记得，在客户机上生成公钥，上传到服务器，或者在服务器上生成，下载到客户机。<br>进入~/.ssh目录并使用ssh-keygen生成公钥：cd /home/git/.ssh<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">ssh-keygen -t rsa</span></div></pre></td></tr></table></figure></p>
<p>注意不能忘记私钥的密码。默认会生成~/.ssh/id_rsa.pub公钥文件。<br>有了密钥以后便可初始化gitosis，使gitosis获得对Git的管理权限：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gitosis-init &lt; <span class="regexp">/home/gi</span>t<span class="regexp">/.ssh/i</span>d_rsa.pub</div></pre></td></tr></table></figure></p>
<p>初始化之后，会在/home/git/repositories创建gitosis-admin.git项目，可以通过维护这个项目来对gitosis进行配置。<br>除此以外，还需要对gitosis-admin.git/hooks/post-update目录赋上特殊权限：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chmod u+x <span class="regexp">/home/gi</span>t<span class="regexp">/repositories/gi</span>tosis-admin.git<span class="regexp">/hooks/</span>post-update</div></pre></td></tr></table></figure></p>
<p>至此，服务器端的gitosys配置就完成了。</p>
<h6 id="三、设置并使用gitosys"><a href="#三、设置并使用gitosys" class="headerlink" title="三、设置并使用gitosys"></a>三、设置并使用gitosys</h6><p>在服务器端完成了gitosys的配置之后，便可在客户端进行接下来的设置，以便使用Git服务器。<br>较为正规的做法是在客户端通过gitosis-admin版本库做管理设置，之后提交到服务器使项目权限生效，当然也可以使用操作系统的ssh登录方式进行验证，不过这里仅介绍前面一种方法。<br>在进行以下操作时，需要确认一下，你的公钥是不是已经放在客户机~/.ssh/目录下。如果你也在用github的话，那么你需要设置一下多公钥共存的东西。.ssh/config，在这个文件中写入：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Host github<span class="selector-class">.com</span></div><div class="line">    HostName github<span class="selector-class">.com</span></div><div class="line">    User git</div><div class="line">    IdentityFile C:/Users/abc/.ssh/id_rsa</div><div class="line">Host git<span class="selector-class">.oschina</span><span class="selector-class">.net</span></div><div class="line">    HostName git<span class="selector-class">.oschina</span><span class="selector-class">.net</span></div><div class="line">    User git</div><div class="line">    IdentityFile C:/Users/abc/.ssh/id_rsa_a</div><div class="line">Host abc<span class="selector-class">.ueder</span><span class="selector-class">.info</span></div><div class="line">    HostName abc<span class="selector-class">.ueder</span><span class="selector-class">.info</span></div><div class="line">    User git</div><div class="line">    Port <span class="number">1000</span></div><div class="line">    IdentityFile C:/Users/abc/.ssh/id_rsa_new</div></pre></td></tr></table></figure></p>
<p>如我就使用了好几个git服务，每个都有自己的公钥，需要配置文件来区分开来，并且我自己的服务器ssh端口已经不是默认端口，需要在配置文件中声明，否则在每次clone的时候要声明端口。<br>在客户机上下载gitosis-admin版本库，这里以linux客户机为例：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git <span class="keyword">clone</span> <span class="title">git</span>@VPS的IP/Domain:/home/git/repositories/gitosis-admin.git</div></pre></td></tr></table></figure></p>
<p>获取完成后对gitosis-admin/gitosis.conf文件进行设置，以上面新建的项目为例，新增：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="section">[group huhamhire-hosts]</span></div><div class="line"><span class="attr">writable</span> = huhamhire-hosts</div><div class="line"><span class="attr">members</span> = hamhire@myhost</div></pre></td></tr></table></figure></p>
<p>随后要将客户端的公钥放到keydir目录下，并随后提交设置到服务器：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cp ~/.ssh/id_rsa<span class="selector-class">.pub</span> ~/gitosis-admin/keydir/hamhire@myhost<span class="selector-class">.pub</span></div><div class="line">    </div><div class="line">cd ~/gitosis-admin</div><div class="line">git add ./</div><div class="line">git commit -<span class="selector-tag">a</span> -m <span class="string">"add new repo"</span></div><div class="line">git push</div></pre></td></tr></table></figure></p>
<p>由于之前已经在/home/git/repo/目录下设置了huhamhire-hosts的版本库位置，所以可以直接进行推送操作。<br>在本例中可以通过hamhire@myhost:/home/git/repo/huhamhire-hosts的路径来提交项目。<br>至此，gitosys的配置全部完成。</p>
<h6 id="四、安装gitweb"><a href="#四、安装gitweb" class="headerlink" title="四、安装gitweb"></a>四、安装gitweb</h6><p>在配置完成了git服务器以后，如果需要方便在线查看，使用gitweb来提供一个简单网页版的版本显示界面是一个不错的选择。<br>在centos 下安装gitweb如下：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">yum install fcgi-devel</div><div class="line">    </div><div class="line"><span class="keyword">cd</span> /usr/local/src/</div><div class="line">git clone gi<span class="variable">t:</span>//github.<span class="keyword">com</span>/gnosek/fcgiwrap.git</div><div class="line"><span class="keyword">cd</span> fcgiwrap</div><div class="line">autoreconf -i</div><div class="line">./configure</div><div class="line"><span class="keyword">make</span></div><div class="line"><span class="keyword">make</span> install</div></pre></td></tr></table></figure></p>
<p>至此，fcgiwrap已经安装到 /usr/local/sbin/fcgiwrap<br>然后再安装spawn-fcgi<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> spawn-fcgi</div></pre></td></tr></table></figure></p>
<p>安装好后:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">vim /etc/sysconfig/spawn-fcgi</div><div class="line"><span class="comment"># 修改文件为：</span></div><div class="line"></div><div class="line"><span class="comment"># You must set some working options before the "spawn-fcgi" service will work.</span></div><div class="line"><span class="comment"># If SOCKET points to a file, then this file is cleaned up by the init script.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># See spawn-fcgi(1) for all possible options.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Example :</span></div><div class="line"><span class="comment">#SOCKET=/var/run/php-fcgi.sock</span></div><div class="line"><span class="comment">#OPTIONS="-u apache -g apache -s $SOCKET -S -M 0600 -C 32 -F 1 -P /var/run/spawn-fcgi.pid -- /usr/bin/php-cgi"</span></div><div class="line">FCGI_SOCKET=/var/run/fcgiwrap.socket</div><div class="line">FCGI_PROGRAM=/usr/<span class="built_in">local</span>/sbin/fcgiwrap</div><div class="line">FCGI_USER=nginx</div><div class="line">FCGI_GROUP=nginx</div><div class="line">FCGI_EXTRA_OPTIONS=<span class="string">"-M 0700"</span></div><div class="line">OPTIONS=<span class="string">"-u <span class="variable">$FCGI_USER</span> -g <span class="variable">$FCGI_GROUP</span> -s <span class="variable">$FCGI_SOCKET</span> -S <span class="variable">$FCGI_EXTRA_OPTIONS</span> -F 1 -P /var/run/spawn-fcgi.pid -- <span class="variable">$FCGI_PROGRAM</span>"</span></div></pre></td></tr></table></figure></p>
<p>然后设置开机运行：<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chkconfig <span class="comment">--levels 2345 spawn-fcgi on</span></div><div class="line">/etc/init.d/spawn-fcgi <span class="built_in">start</span></div></pre></td></tr></table></figure></p>
<p>这里已经完成了fcgi的安装运行。如果你用的nginx，还需要对nginx.conf进行配置，才能将.cgi的请求转发给fcgiwrap.socket<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">location</span> /cgi-bin/ &#123;</div><div class="line"> <span class="comment"># Disable gzip (it makes scripts feel slower since they have to complete</span></div><div class="line"> <span class="comment"># before getting gzipped)</span></div><div class="line"> <span class="attribute">gzip</span> <span class="literal">off</span>;</div><div class="line"> <span class="comment"># Set the root to /usr/lib (inside this location this means that we are</span></div><div class="line"> <span class="comment"># giving access to the files under /usr/lib/cgi-bin)</span></div><div class="line"> <span class="attribute">root</span> /var/www/www.example.com;</div><div class="line"> <span class="comment"># Fastcgi socket</span></div><div class="line"> <span class="attribute">fastcgi_pass</span> unix:/var/run/fcgiwrap.socket;</div><div class="line"> <span class="comment"># Fastcgi parameters, include the standard ones</span></div><div class="line"> <span class="attribute">include</span> /etc/nginx/fastcgi_params;</div><div class="line"> <span class="comment"># Adjust non standard parameters (SCRIPT_FILENAME)</span></div><div class="line"> <span class="attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>最后重启nginx就可以了。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Git是一个分布式版本控制软件，原来是linux内核开发者Linus Torvalds为了更好地管理linux内核开发而创立的。发展至今，Git已经成为了一个相当好用的版本管理工具。相比于SVN，如果想要保存一些微小的修改也必须得提交服务器保存才可以，这样使服务器的版本号过
    
    </summary>
    
      <category term="github" scheme="http://yoursite.com/categories/github/"/>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>linux监控之cacti</title>
    <link href="http://yoursite.com/2017/04/01/17040101/"/>
    <id>http://yoursite.com/2017/04/01/17040101/</id>
    <published>2017-04-01T05:56:18.000Z</published>
    <updated>2017-04-01T06:02:19.365Z</updated>
    
    <content type="html"><![CDATA[<p>cacti 重图形，有数据历史，需用到数据库支持，支持web配置，默认不支持告警，可以加插件。</p>
<h5 id="cacti安装配置"><a href="#cacti安装配置" class="headerlink" title="cacti安装配置"></a>cacti安装配置</h5><h6 id="1-首先要安装epel扩展源"><a href="#1-首先要安装epel扩展源" class="headerlink" title="1. 首先要安装epel扩展源"></a>1. 首先要安装epel扩展源</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span>  epel-<span class="keyword">release</span></div></pre></td></tr></table></figure>
<h6 id="2-（lamp）然后分别安装httpd、php、mysql"><a href="#2-（lamp）然后分别安装httpd、php、mysql" class="headerlink" title="2. （lamp）然后分别安装httpd、php、mysql"></a>2. （lamp）然后分别安装httpd、php、mysql</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y  httpd php php-mysql mysql mysql-<span class="keyword">server</span> mysql-devel php-gd  libjpeg libjpeg-devel libpng libpng-devel</div></pre></td></tr></table></figure>
<h6 id="3-安装cacti-net-snmp-rrdtool"><a href="#3-安装cacti-net-snmp-rrdtool" class="headerlink" title="3. 安装cacti  net-snmp  rrdtool"></a>3. 安装cacti  net-snmp  rrdtool</h6><figure class="highlight dos"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y cacti  <span class="built_in">net</span>-snmp  <span class="built_in">net</span>-snmp-utils  rrdtool</div></pre></td></tr></table></figure>
<h6 id="4-启动服务："><a href="#4-启动服务：" class="headerlink" title="4. 启动服务："></a>4. 启动服务：</h6><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/mysqld <span class="literal">start</span></div><div class="line">/etc/init.d/httpd  <span class="literal">start</span></div><div class="line">/etc/init.d/snmpd <span class="literal">start</span></div></pre></td></tr></table></figure>
<h6 id="5-编辑httpd配置文件"><a href="#5-编辑httpd配置文件" class="headerlink" title="5. 编辑httpd配置文件"></a>5. 编辑httpd配置文件</h6><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">vim <span class="meta-keyword">/etc/</span>httpd/conf.d/cacti.conf  </div><div class="line"></div><div class="line"><span class="meta"># 把<span class="string">"Deny from all"</span> 改为  <span class="string">"Allow from all"</span></span></div><div class="line"><span class="meta-keyword">/etc/</span>init.d/httpd  restart</div></pre></td></tr></table></figure>
<h6 id="6-导入数据创建cacti库"><a href="#6-导入数据创建cacti库" class="headerlink" title="6.  导入数据创建cacti库"></a>6.  导入数据创建cacti库</h6><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql -uroot  -e "<span class="keyword">create</span> <span class="keyword">database</span> cacti<span class="string">" #创建数据库</span></div><div class="line">mysql -uroot -e "<span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> cacti.* <span class="keyword">to</span> <span class="string">'cacti'</span>@<span class="string">'127.0.0.1'</span> identified <span class="keyword">by</span> <span class="string">'cacti'</span>;" #创建cacti用户</div><div class="line">mysql -uroot cacti &lt; /usr/share/doc/cacti-0.8.8b/cacti.sql #导入cacti文件</div></pre></td></tr></table></figure>
<h6 id="7-编辑cacti配置文件"><a href="#7-编辑cacti配置文件" class="headerlink" title="7.  编辑cacti配置文件"></a>7.  编辑cacti配置文件</h6><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">vim /usr/share/cacti/<span class="keyword">include</span>/config.php  更改如下：</div><div class="line"><span class="variable">$database_type</span> = <span class="string">"mysql"</span>;</div><div class="line"><span class="variable">$database_default</span> = <span class="string">"cacti"</span>;</div><div class="line"><span class="variable">$database_name</span> = <span class="string">"cacti"</span>;</div><div class="line"><span class="variable">$database_hostname</span> = <span class="string">"127.0.0.1"</span>;</div><div class="line"><span class="variable">$database_username</span> = <span class="string">"cacti"</span>;</div><div class="line"><span class="variable">$database_password</span> = <span class="string">"cacti"</span>;</div><div class="line"><span class="variable">$database_port</span> = <span class="string">"3306"</span>;</div><div class="line"><span class="variable">$database_ssl</span> = <span class="keyword">false</span>;</div></pre></td></tr></table></figure>
<h6 id="8-web访问cacti并安装"><a href="#8-web访问cacti并安装" class="headerlink" title="8. web访问cacti并安装"></a>8. web访问cacti并安装</h6><p><a href="http://192.168.209.131/cacti/" target="_blank" rel="external">http://192.168.209.131/cacti/</a><br>点两下“next” 和一次”Finish“ 即可<br>输入admin   admin 登录，重新设置新的密码</p>
<h6 id="9-执行poller-php-生成图形，-加入计划任务"><a href="#9-执行poller-php-生成图形，-加入计划任务" class="headerlink" title="9. 执行poller.php, 生成图形， 加入计划任务"></a>9. 执行poller.php, 生成图形， 加入计划任务</h6><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/usr/</span>bin<span class="regexp">/php /</span>usr<span class="regexp">/share/</span>cacti/poller.php添加cron任务</div><div class="line"><span class="comment">//crontab -e  增加：</span></div><div class="line">*<span class="regexp">/5 * * * *  /</span>usr<span class="regexp">/bin/</span>php <span class="regexp">/usr/</span>share<span class="regexp">/cacti/</span>poller.php</div></pre></td></tr></table></figure>
<p>以下10-12步骤在客户端机器上操作</p>
<h6 id="10-安装snmp"><a href="#10-安装snmp" class="headerlink" title="10. 安装snmp"></a>10. 安装snmp</h6><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y net-snmp</div></pre></td></tr></table></figure>
<h6 id="11-修改snmpd-conf"><a href="#11-修改snmpd-conf" class="headerlink" title="11. 修改snmpd.conf"></a>11. 修改snmpd.conf</h6><p>修改syslocation以及syscontact, 其中syslocation 可以写本机ip，syscontact写管理员邮箱<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">syslocation</span> 192<span class="selector-class">.168</span><span class="selector-class">.209</span><span class="selector-class">.131</span></div><div class="line"><span class="selector-tag">syscontact</span> <span class="selector-tag">Root</span> <span class="selector-tag">graped</span>@<span class="keyword">aliyun</span>.<span class="keyword">com</span></div></pre></td></tr></table></figure></p>
<h6 id="12-启动snmp"><a href="#12-启动snmp" class="headerlink" title="12. 启动snmp"></a>12. 启动snmp</h6><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service  snmpd  <span class="literal">start</span></div></pre></td></tr></table></figure>
<h6 id="13-登录cacti管理后台，点console-再点Device，-在右上角点”Add“"><a href="#13-登录cacti管理后台，点console-再点Device，-在右上角点”Add“" class="headerlink" title="13.  登录cacti管理后台，点console , 再点Device， 在右上角点”Add“"></a>13.  登录cacti管理后台，点console , 再点Device， 在右上角点”Add“</h6><p>Description  写本机ip或你自定义一个名字<br>Hostname  写本机ip<br>Host Template  选ucd/net  SNMP Host<br>SNMP Version  选Version 2<br>点右下角的create<br>点右上角的”Create Graphs for this Host“<br>Graph Types:  选择SNMP - Interface Statistics<br>在下面框中选择要监控的网卡，比如我选择eth0, 在最右侧小方块里打对勾，然后点右下角的create<br>（如果在这一步找不到网卡，可以根据这个帖子修改配置文件：<a href="http://ask.apelearn.com/question/8089" title="cacti监控找到网卡的方法" target="_blank" rel="external">cacti监控找到网卡的方法</a>）<br>Graph Types:  再选择 Graph Template Based<br>在下面的框中，选择你要监控的项目，比如ucd/net - Load Average<br>在右侧小方块中打对勾，然后点右下角的create</p>
<h6 id="14-点左侧的Graph-Trees"><a href="#14-点左侧的Graph-Trees" class="headerlink" title="14. 点左侧的Graph Trees"></a>14. 点左侧的Graph Trees</h6><p>选中”Default Tree“<br>点右上角的Add<br>Tree Item Type 选择 ”Host“<br>Host 选择我们刚刚增加的那个机器ip<br>点右下角的create</p>
<h6 id="15-点左上角的Graphs"><a href="#15-点左上角的Graphs" class="headerlink" title="15. 点左上角的Graphs"></a>15. 点左上角的Graphs</h6><p>在左侧可以看到<br>Defaut Tree下面已经增加了我们刚刚添加的主机，图形一开始不会那么快出来，要等一小会才可以。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;cacti 重图形，有数据历史，需用到数据库支持，支持web配置，默认不支持告警，可以加插件。&lt;/p&gt;
&lt;h5 id=&quot;cacti安装配置&quot;&gt;&lt;a href=&quot;#cacti安装配置&quot; class=&quot;headerlink&quot; title=&quot;cacti安装配置&quot;&gt;&lt;/a&gt;cact
    
    </summary>
    
      <category term="monitor" scheme="http://yoursite.com/categories/monitor/"/>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>Nginx 的负载均衡集群</title>
    <link href="http://yoursite.com/2017/03/30/17033001/"/>
    <id>http://yoursite.com/2017/03/30/17033001/</id>
    <published>2017-03-30T12:14:57.000Z</published>
    <updated>2017-03-30T12:24:25.294Z</updated>
    
    <content type="html"><![CDATA[<h5 id="Nginx-的负载均衡集群"><a href="#Nginx-的负载均衡集群" class="headerlink" title="Nginx 的负载均衡集群"></a>Nginx 的负载均衡集群</h5><p>Nginx的负载均衡和lvs相比，Nginx属于更高级的应用层，不会牵扯到IP和内核的改动，它只是单纯的把用户的请求转发到后面的机器上。这就意味着：后端的RS不需要配置公网IP。</p>
<h6 id="1-环境说明"><a href="#1-环境说明" class="headerlink" title="1. 环境说明"></a>1. 环境说明</h6><p>Nginx分发器（公网IP：192.168.0.161；内网IP：192.168.209.131）<br>RS1：只有内网，IP为：192.168.209.132<br>RS2：只有内网，IP为：192.168.209.133</p>
<h6 id="2-配置"><a href="#2-配置" class="headerlink" title="2. 配置"></a>2. 配置</h6><p>在nginx分发器上编辑配置文件<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">vim <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>conf<span class="meta-keyword">/vhosts/</span>lb.conf</div><div class="line"><span class="meta">#加入以下内容</span></div><div class="line">upstream <span class="class">graped </span>&#123;</div><div class="line">		ip_hash;</div><div class="line">        server <span class="number">192.168</span><span class="number">.209</span><span class="number">.132</span>:<span class="number">80</span>;</div><div class="line">        server <span class="number">192.168</span><span class="number">.209</span><span class="number">.133</span>:<span class="number">80</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class">server </span>&#123;</div><div class="line">        listen <span class="number">80</span>;</div><div class="line">        server_name www<span class="number">.123</span>.com;</div><div class="line">        location <span class="class">/ &#123;</span></div><div class="line">                proxy_pass      http:<span class="comment">//graped/;</span></div><div class="line">                proxy_set_header Host   $host;</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>说明：</p>
<p>upstream用来定义后端的RS，可以只写一个。ip_bash 为nginx的一种调度算法，加上这一行后会达到这样的效果：即一个用户的请求会始终被分发到固定的一个RS上。这样的好处是：可以避免吧同一个用户的请求分发到不同的机器上面而导致session丢失的情况。upstream里面，RS后面的IP后面还可以加权重，比如：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">server</span> <span class="number">192.168.209.132:80</span> weight=<span class="number">100</span></div></pre></td></tr></table></figure></p>
<p>还需要注意的是，upstream后面的graped是自定义的一个名字，可以随便写，唯一的要求是要和后面的proxy_pass后面保持一致。</p>
<p>另外：<br>还可以根据访问的目录来区分后端Web，请参考：nginx代理扩展：<br><a href="http://note.youdao.com/noteshare?id=6123c1559f821ab895eef6bab5174c77&amp;sub=4ECC2219D20C4C0CA2B4266E060AF30D" target="_blank" rel="external">根据目录区分后端web</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;Nginx-的负载均衡集群&quot;&gt;&lt;a href=&quot;#Nginx-的负载均衡集群&quot; class=&quot;headerlink&quot; title=&quot;Nginx 的负载均衡集群&quot;&gt;&lt;/a&gt;Nginx 的负载均衡集群&lt;/h5&gt;&lt;p&gt;Nginx的负载均衡和lvs相比，Nginx属于更高
    
    </summary>
    
      <category term="nginx" scheme="http://yoursite.com/categories/nginx/"/>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>LB集群之LVS介绍</title>
    <link href="http://yoursite.com/2017/03/29/17032902/"/>
    <id>http://yoursite.com/2017/03/29/17032902/</id>
    <published>2017-03-29T12:50:10.000Z</published>
    <updated>2017-03-30T01:40:37.320Z</updated>
    
    <content type="html"><![CDATA[<h5 id="1-LB集群之LVS介绍"><a href="#1-LB集群之LVS介绍" class="headerlink" title="1. LB集群之LVS介绍"></a>1. LB集群之LVS介绍</h5><p>LB集群是load balance 集群的简写，翻译成中文就是负载均衡集群。常用的负载均衡开源软件有，nginx、lvs、keepalived，商业的硬件负载均衡设备有F5，Netscale。</p>
<p>LB集群的结构如下图，原理也很简单，就是当用户的请求过来时，会直接发到分发器（Director Server）上，然后它把用户的请求根据预先设置好的算法，只能均衡的分发到后端真正的服务器（Real Server）上。如果不同的机器，可能用户请求到的数据不一样，为了避免这样情况的发生，所以用到了共享存储，这样保证所有用户请求的数据是一样的。<br><img src="http://www.apelearn.com/bbs/data/attachment/forum/201406/16/115112w1we1x4e5ueewzrd.png" alt="image"></p>
<p>LVS是一个实现负载均衡集群的开源软件项目，LVS架构从逻辑上课分为调度层（Director），server层（Real server）和共享存储。LVS从实现上，分为下面三种模式：</p>
<ol>
<li>NAT（调度器将请求的目标IP即vip改为Real Server的ip，返回的数据包也经过调度器，调度器再把原地址修改为vip）。<img src="http://www.apelearn.com/bbs/data/attachment/forum/201406/16/115114l0ez0aga011e901u.jpg" alt="image"></li>
<li>TUN （调度器将请求来的数据包封装加密通过IP隧道转发到后端的real server上，而real server会直接把数据返回给客户端，而不再经过调度器。）</li>
<li>DR （调度器将请求来的数据包的目标mac地址改为real server的mac地址，返回的时候也不经过调度器，直接返回给客户端）<img src="http://www.apelearn.com/bbs/data/attachment/forum/201406/16/115116xqv78w7v860vq8h6.jpg" alt="image"></li>
<li>参考资料：<a href="http://www.it165.net/admin/html/201401/2248.html" target="_blank" rel="external">LVS原理详解（3种工作方式8种调度算法）</a></li>
</ol>
<p>图中出现的几个IP概念，需要解释一下：</p>
<ul>
<li>DIP（Director ip）为分发器IP，NAT模式下它必须是公网IP，要对外服务。</li>
<li>VIP（Virtual  ip）为虚拟IP，用在TUN和DR模式中，需要同时配置在分发器和后端真实服务器上。</li>
<li>RIP（Real ip）为后端真实服务器的IP，在TUN和DR模式中，RIP为公网IP。</li>
</ul>
<p>要想把用户的请求调度给后端RS，是需要经过调度算法来实现的，那么关于LVS的调度算法，都有哪些？</p>
<ul>
<li>轮叫调度（Round Robin）（简称rr），这种算法是最简单的，不管后端RS配置和处理能力，非常均衡的分发下去。</li>
<li>加权轮叫（Weighted Round Robin）（简称wrr），比上面的算法多了一个权重概念，可以给RS设置权重，权重越高，那么分发的请求数越多，权重的取值范围0-100.</li>
<li>最少链接（least connection）（LC），这个算法会根据后端RS的连接数来决定把请求分发给谁，比如RS1链接数比RS2链接数少，那么请求就优先发给RS1。</li>
<li>加权最少链接（Weighted Least Connection）（WLC），比第三个算法多了一个权重概念。</li>
<li>基于局部性的最少连接调度算法(lblc)是请求数据包的目标IP地址的一种调度算法，该算法先根据请求的目标IP地址寻找最近的该目标IP地址所有使用的服务器，如果这台服务器依然可用，并且用能力处理该请求，调度器会尽量选择相同的服务器，否则会继续选择其他可行的服务器。</li>
<li>带复杂的基于局部性最少的连接算法(lblcr)激励的不是一个目标IP与一台服务器之间的连接记录，他会维护一个目标IP到一组服务器之间的映射关系，防止单点服务器负责过高。</li>
<li>目标地址散列调度算法(DH)也是根据目标IP地址通过散列函数将目标IP与服务器建立映射关系，出现服务器不可用或负载过高的情况下，发往该目标IP的请求会固定发给该服务器。</li>
<li>源地址散列调度算法(SH)与目标地址散列调度算法类似，但它是根据源地址散列算法进行静态分配固定的服务器资源。</li>
</ul>
<h5 id="2-LVS的NAT模式"><a href="#2-LVS的NAT模式" class="headerlink" title="2. LVS的NAT模式"></a>2. LVS的NAT模式</h5><h6 id="1-环境说明"><a href="#1-环境说明" class="headerlink" title="1. 环境说明"></a>1. 环境说明</h6><p>台服务器一台作为director, 两台作为real server<br>Director 有一个外网ip (192.168.31.166) 和一个内网ip(192.168.21.166), 两个real server上只有内网ip(192.168.21.100)和(192.168.21.101) 并且需要把两个real server的内网网关设置为director的内网ip(192.168.21.166)</p>
<p>补充：<a href="http://ask.apelearn.com/question/10536" target="_blank" rel="external">lvs nat模式时设置网络环境的方法</a></p>
<h6 id="2-安装和配置"><a href="#2-安装和配置" class="headerlink" title="2. 安装和配置"></a>2. 安装和配置</h6><p>两个real server 上都安装httpd:<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y nginx</div></pre></td></tr></table></figure></p>
<p>Director上安装ipvsadm<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y  ipvsadm</div></pre></td></tr></table></figure></p>
<p>Direcotr 上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">vim /usr/<span class="built_in">local</span>/sbin/lvs_nat.sh //增加:</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line"><span class="comment"># director 服务器上开启路由转发功能: </span></div><div class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward </div><div class="line"><span class="comment"># 关闭icmp的重定向</span></div><div class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/send_redirects</div><div class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/default/send_redirects</div><div class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/eth0/send_redirects</div><div class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/eth1/send_redirects</div><div class="line"></div><div class="line"><span class="comment"># director 设置nat防火墙</span></div><div class="line">iptables -t nat -F</div><div class="line">iptables -t nat -X</div><div class="line">iptables -t nat -A POSTROUTING <span class="_">-s</span> 192.168.21.0/24  -j MASQUERADE</div><div class="line"><span class="comment"># director设置ipvsadm</span></div><div class="line">IPVSADM=<span class="string">'/sbin/ipvsadm'</span></div><div class="line"><span class="variable">$IPVSADM</span> -C</div><div class="line"><span class="variable">$IPVSADM</span> -A -t 192.168.31.166:80 <span class="_">-s</span> lc -p 300</div><div class="line"><span class="variable">$IPVSADM</span> <span class="_">-a</span> -t 192.168.31.166:80 -r 192.168.21.100:80 -m -w 1</div><div class="line"><span class="variable">$IPVSADM</span> <span class="_">-a</span> -t 192.168.31.166:80 -r 192.168.21.101:80 -m -w 1</div></pre></td></tr></table></figure></p>
<p>直接运行这个脚本就可以完成lvs/nat的配置了: </p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/bin/</span>bash <span class="regexp">/usr/</span>local<span class="regexp">/sbin/</span>lvs_nat.sh</div></pre></td></tr></table></figure>
<h6 id="3-测试"><a href="#3-测试" class="headerlink" title="3. 测试"></a>3. 测试</h6><p>通过浏览器测试两台机器上的web内容，为了区分开，我们可以把nginx的默认页修改一下：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rs1上： echo <span class="string">"rs1rs1"</span> &gt;<span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/nginx/</span>html/index.html</div><div class="line">rs2上： echo <span class="string">"rs2rs2"</span> &gt;<span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/nginx/</span>html/index.html</div></pre></td></tr></table></figure>
<h5 id="3-LVS的DR设置"><a href="#3-LVS的DR设置" class="headerlink" title="3. LVS的DR设置"></a>3. LVS的DR设置</h5><h6 id="1-环境说明-1"><a href="#1-环境说明-1" class="headerlink" title="1. 环境说明"></a>1. 环境说明</h6><p>三台机器:<br>director(eth0192.168.31.166, vip eth0:0: 192.168.31.110)<br>real server1(eth0 rip: 192.168. 31.100, vip lo:0: 192.168.31.110)<br>real server2(eth0 rip: 192.168.31.101, vip lo:0: 192.168.31.110)</p>
<h6 id="2-编写脚本"><a href="#2-编写脚本" class="headerlink" title="2. 编写脚本"></a>2. 编写脚本</h6><p>Director 上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">vim /usr/<span class="built_in">local</span>/sbin/lvs_dr.sh //增加</div><div class="line"></div><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward</div><div class="line">ipv=/sbin/ipvsadm</div><div class="line">vip=192.168.31.110</div><div class="line">rs1=192.168.31.100</div><div class="line">rs2=192.168.31.101</div><div class="line">ifconfig eth0:0 <span class="variable">$vip</span> broadcast <span class="variable">$vip</span> netmask 255.255.255.255 up</div><div class="line">route add -host <span class="variable">$vip</span> dev eth0:0</div><div class="line"><span class="variable">$ipv</span> -C</div><div class="line"><span class="variable">$ipv</span> -A -t <span class="variable">$vip</span>:80 <span class="_">-s</span> rr </div><div class="line"><span class="variable">$ipv</span> <span class="_">-a</span> -t <span class="variable">$vip</span>:80 -r <span class="variable">$rs1</span>:80 -g -w 1</div><div class="line"><span class="variable">$ipv</span> <span class="_">-a</span> -t <span class="variable">$vip</span>:80 -r <span class="variable">$rs2</span>:80 -g -w 1</div></pre></td></tr></table></figure></p>
<p>两台rs上：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">vim /usr/<span class="built_in">local</span>/sbin/lvs_dr_rs.sh</div><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line">vip=192.168.31.110</div><div class="line">ifconfig lo:0 <span class="variable">$vip</span> broadcast <span class="variable">$vip</span> netmask 255.255.255.255 up </div><div class="line">route add -host <span class="variable">$vip</span> lo:0</div><div class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</div><div class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</div><div class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</div><div class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce</div></pre></td></tr></table></figure></p>
<p>关于arp_ignore和 arp_announce参考：<a href="http://www.cnblogs.com/lgfeng/archive/2012/10/16/2726308.html" target="_blank" rel="external">LVS负载均衡中arp_ignore和arp_annonuce参数配置的含义</a></p>
<p>然后director上执行:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash <span class="regexp">/usr/</span>local<span class="regexp">/sbin/</span>lvs_dr.sh</div></pre></td></tr></table></figure></p>
<p>两台rs上执行:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash <span class="regexp">/usr/</span>local<span class="regexp">/sbin/</span>lvs_dr_rs.sh</div></pre></td></tr></table></figure></p>
<p>Windows下浏览器测试访问。</p>
<h5 id="4-LVS-DR-keepalived配置"><a href="#4-LVS-DR-keepalived配置" class="headerlink" title="4. LVS/DR + keepalived配置"></a>4. LVS/DR + keepalived配置</h5><p>注意：前面虽然我们已经配置过一些操作，但是下面我们使用keepaliave操作和之前的操作是有些冲突的，所以若是之前配置过DR，请首先做如下操作：</p>
<p>dr上执行：<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta"><span class="meta-keyword">$ipv</span> -C</span></div><div class="line">ifconfig eth0:<span class="number">0</span>  down</div></pre></td></tr></table></figure></p>
<p>前面的lvs虽然已经配置成功也实现了负载均衡，但是我们测试的时候发现，当某台real server把httpd进程停掉，那么director照样会把请求转发过去，这样就造成了某些请求不正常。所以需要有一种机制用来检测real server的状态，这就是keepalived。它的作用除了可以检测rs状态外，还可以检测备用director的状态，也就是说keepalived可以实现ha集群的功能，当然了也需要一台备用director.<br>备用director也需要安装一下keepalived软件 </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y keepalived</div></pre></td></tr></table></figure>
<p>安装好后，编辑配置文件  </p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">vim /etc/keepalived/keepalived.conf   <span class="comment">//加入如下：</span></div><div class="line">vrrp_instance VI_1 &#123;</div><div class="line">    <span class="section">state</span> MASTER   #备用服务器上为 BACKUP</div><div class="line">    interface eth0</div><div class="line">    virtual_router_id <span class="number">51</span></div><div class="line">    priority <span class="number">100</span>  #备用服务器上为<span class="number">90</span></div><div class="line">    advert_int <span class="number">1</span></div><div class="line">    authentication &#123;</div><div class="line">        auth_type PASS</div><div class="line">        auth_pass <span class="number">1111</span></div><div class="line">    &#125;</div><div class="line">    virtual_ipaddress &#123;</div><div class="line">        <span class="number">192.168</span><span class="number">.31</span><span class="number">.110</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">virtual_server <span class="number">192.168</span><span class="number">.31</span><span class="number">.110</span> <span class="number">80</span> &#123;</div><div class="line">    delay_loop <span class="number">6</span>                  #(每隔<span class="number">10</span>秒查询realserver状态)</div><div class="line">    lb_algo wlc                  #(lvs 算法)</div><div class="line">    lb_kind DR                  #(Direct Route)</div><div class="line">    persistence_timeout <span class="number">60</span>        #(同一IP的连接<span class="number">60</span>秒内被分配到同一台realserver)</div><div class="line">    protocol TCP                #(用TCP协议检查realserver状态)</div><div class="line"></div><div class="line">real_server <span class="number">192.168</span><span class="number">.31</span><span class="number">.100</span> <span class="number">80</span> &#123;</div><div class="line">        weight <span class="number">100</span>               #(权重)</div><div class="line">        TCP_CHECK &#123;</div><div class="line">        connect_timeout <span class="number">10</span>       #(<span class="number">10</span>秒无响应超时)</div><div class="line">        nb_get_retry <span class="number">3</span></div><div class="line">        delay_before_retry <span class="number">3</span></div><div class="line">        connect_port <span class="number">80</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">real_server <span class="number">192.168</span><span class="number">.31</span><span class="number">.101</span> <span class="number">80</span> &#123;</div><div class="line">        weight <span class="number">100</span></div><div class="line">        TCP_CHECK &#123;</div><div class="line">        connect_timeout <span class="number">10</span></div><div class="line">        nb_get_retry <span class="number">3</span></div><div class="line">        delay_before_retry <span class="number">3</span></div><div class="line">        connect_port <span class="number">80</span></div><div class="line">        &#125;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上为主director的配置文件，从director的配置文件只需要修改</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">state</span> MASTER  -&gt; <span class="keyword">state</span> BACKUP</div><div class="line">priority <span class="number">100</span> -&gt; priority <span class="number">90</span></div></pre></td></tr></table></figure>
<p>配置完keepalived后，需要开启端口转发（主从都要做）：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo <span class="number">1</span> &gt; <span class="regexp">/proc/</span>sys<span class="regexp">/net/i</span>pv4<span class="regexp">/ip_forward</span></div></pre></td></tr></table></figure>
<p>然后，两个rs上执行 /usr/local/sbin/lvs_dr_rs.sh 脚本：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash <span class="regexp">/usr/</span>local<span class="regexp">/sbin/</span>lvs_dr_rs.sh</div></pre></td></tr></table></figure></p>
<p>最后，两个director上启动keepalived服务（先主后从）：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/etc/i</span>nit.d<span class="regexp">/keepalived start</span></div></pre></td></tr></table></figure>
<p>另外，需要注意的是，启动keepalived服务会自动生成vip和ipvsadm规则，不需要再去执行上面提到的/usr/local/sbin/lvs_dr.sh 脚本。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;1-LB集群之LVS介绍&quot;&gt;&lt;a href=&quot;#1-LB集群之LVS介绍&quot; class=&quot;headerlink&quot; title=&quot;1. LB集群之LVS介绍&quot;&gt;&lt;/a&gt;1. LB集群之LVS介绍&lt;/h5&gt;&lt;p&gt;LB集群是load balance 集群的简写，翻译成中
    
    </summary>
    
      <category term="LVS" scheme="http://yoursite.com/categories/LVS/"/>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>HA集群配置</title>
    <link href="http://yoursite.com/2017/03/29/17032901/"/>
    <id>http://yoursite.com/2017/03/29/17032901/</id>
    <published>2017-03-28T16:04:09.000Z</published>
    <updated>2017-03-28T16:12:54.305Z</updated>
    
    <content type="html"><![CDATA[<h4 id="HA集群配置"><a href="#HA集群配置" class="headerlink" title="HA集群配置"></a>HA集群配置</h4><p>HA 即 （high available）高可用，又被叫做双机热备，用于关键性业务。 简单理解就是，有两台机器A和B，正常是A提供服务，B待命闲置，当A宕机或服务宕掉，会切换至B机器继续提供服务。常用实现高可用的开源软件有heartbeat和keepalived，其中keepalived有负载均衡的功能。<img src="http://i.imgur.com/RKgR1gc.jpg" alt="image"><br>如图所示为一个HA架构，一个交换机下面有两台机器web1和web2，其中web1为主节点，正常是它在提供服务，web2为备用闲置节点。web1和web2中间有一个心跳线，检查对方是否存活状态。流动IP，也叫vip是对外提供服务的IP，正常情况下是配置在web1上的，当web1宕机后，web2会自动配置该vip，对外提供服务。</p>
<p>下面我们用heartbeat来做HA集群，并且把Nginx服务作为HA对应的服务。</p>
<p>准备工作：<br>两个机器，都是CentOS6.5 网卡eth0 ip如下：</p>
<pre><code>master 192.168.0.161
slave  192.168.0.162
</code></pre><h5 id="1-设置hostname-（主从上都要进行）"><a href="#1-设置hostname-（主从上都要进行）" class="headerlink" title="1. 设置hostname （主从上都要进行）"></a>1. 设置hostname （主从上都要进行）</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 在主上</span></div><div class="line">hostname <span class="keyword">master</span></div><div class="line"><span class="title">bash</span></div><div class="line"><span class="comment">#在从上</span></div><div class="line">hostname <span class="literal">slave</span></div><div class="line">bash</div></pre></td></tr></table></figure>
<h5 id="2-关闭防火墙-（主从上都要进行）"><a href="#2-关闭防火墙-（主从上都要进行）" class="headerlink" title="2. 关闭防火墙 （主从上都要进行）"></a>2. 关闭防火墙 （主从上都要进行）</h5><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># iptables</span></div><div class="line">iptables -F </div><div class="line">service iptables save</div><div class="line"><span class="meta"># selinux</span></div><div class="line">setenforce <span class="number">0</span></div><div class="line">sed -i <span class="string">'s/SELINUX=enforcing/SELINUX=disabled/'</span> /etc/selinux/config</div></pre></td></tr></table></figure>
<h5 id="3-配置hosts-（主从上都要进行）"><a href="#3-配置hosts-（主从上都要进行）" class="headerlink" title="3. 配置hosts （主从上都要进行）"></a>3. 配置hosts （主从上都要进行）</h5><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">vim /etc/hosts</div><div class="line"># 加入：</div><div class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.161</span> master</div><div class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.162</span> slave</div></pre></td></tr></table></figure>
<h5 id="4-安装epel扩展源-（主从上都要进行）"><a href="#4-安装epel扩展源-（主从上都要进行）" class="headerlink" title="4. 安装epel扩展源 （主从上都要进行）"></a>4. 安装epel扩展源 （主从上都要进行）</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y epel-<span class="keyword">release</span></div></pre></td></tr></table></figure>
<h5 id="5-安装heartbeat-libnet-Nginx"><a href="#5-安装heartbeat-libnet-Nginx" class="headerlink" title="5. 安装heartbeat libnet Nginx"></a>5. 安装heartbeat libnet Nginx</h5><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="keyword">install</span> -y heartbeat* libnet nginx</div></pre></td></tr></table></figure>
<h5 id="6-主（master）上配置"><a href="#6-主（master）上配置" class="headerlink" title="6. 主（master）上配置"></a>6. 主（master）上配置</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /usr/share/doc/heartbeat-<span class="number">3.0</span>.<span class="number">4</span>/</div><div class="line"><span class="keyword">cp</span>  authkeys  <span class="keyword">ha</span>.<span class="keyword">cf</span> haresources   /etc/<span class="keyword">ha</span>.d/</div><div class="line"><span class="keyword">cd</span> /etc/<span class="keyword">ha</span>.d</div><div class="line"><span class="keyword">vi</span>  authkeys  //加入或更改为</div><div class="line"></div><div class="line">auth <span class="number">3</span></div><div class="line"><span class="number">3</span> md5 Hello!</div><div class="line"></div><div class="line">chmod <span class="number">600</span> authkeys</div><div class="line"><span class="keyword">vi</span>  haresources  //加入</div><div class="line"></div><div class="line">master <span class="number">192.168</span>.<span class="number">0.150</span>/<span class="number">24</span>/eth0:<span class="number">0</span> nginx   </div><div class="line"></div><div class="line"><span class="keyword">vi</span>  <span class="keyword">ha</span>.<span class="keyword">cf</span>   //改为如下内容：</div><div class="line">debugfile /var/<span class="built_in">log</span>/<span class="keyword">ha</span>-<span class="keyword">debug</span></div><div class="line">logfile /var/<span class="built_in">log</span>/<span class="keyword">ha</span>-<span class="built_in">log</span></div><div class="line">logfacility     local0</div><div class="line">keepalive <span class="number">2</span></div><div class="line">deadtime <span class="number">30</span></div><div class="line">warntime <span class="number">10</span></div><div class="line">initdead <span class="number">60</span></div><div class="line">udpport <span class="number">694</span></div><div class="line">ucast eth0 <span class="number">192.168</span>.<span class="number">0.162</span></div><div class="line">auto_failback <span class="keyword">on</span></div><div class="line">node    master</div><div class="line">node    slave</div><div class="line">ping <span class="number">192.168</span>.<span class="number">0.1</span></div><div class="line">respawn hacluster /usr/lib/heartbeat/ipfail</div></pre></td></tr></table></figure>
<p>配置说明：</p>
<ul>
<li>debugfile /var/log/ha-debug：保存heartbeat的调试信息；</li>
<li>dlogfile /var/log/ha-log：heartbeat日志信息；</li>
<li>dlogfacility local0：日志级别；</li>
<li>dkeepalive 2：跳时间间隔；</li>
<li>ddeadtime 30：超出该时间间隔未收到对方节点心跳，则认为对方已死亡；</li>
<li>dwarntime 10：超出该时间间隔未收到对方节点心跳，则发出警告并记录到日志；</li>
<li>dinitdead 60：在某些系统上，系统启动或重启之后需要经过一段时间网络才能恢复正常工作，该选项用于解决这种情况产生的时间间隔；</li>
<li>dudpport 694：设置广播通信使用的端口，649为默认端口；</li>
<li>ducast eth0 192.168.0.162：设置对方奇迹心跳检测的网卡和IP；</li>
<li>dauto_failback on：heartbeat的两台之极分别为主节点和从节点，主节点在正常情况下占用资源并运行所有服务，遇到故障时把资源交给从节点并由从节点运行服务；</li>
<li>dnode   master：指定主；</li>
<li>dnode    slave：指定从；</li>
<li>dping 192.168.0.1</li>
<li>drespawn hacluster/usr/lib/heartbeat/ipfail：指定与heartbeat一同启动和关闭的进程，该进程被自动监听视，遇到故障则从新启动。最常见的进程是ipfail，该进程用于检测和处理网络故障，需要配合ping语句指定pingnode来检测网络连接。如果你的系统是64位，请注意该文件路径</li>
</ul>
<h5 id="7-把主上的三个配置拷贝到从上"><a href="#7-把主上的三个配置拷贝到从上" class="headerlink" title="7. 把主上的三个配置拷贝到从上"></a>7. 把主上的三个配置拷贝到从上</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /etc/<span class="keyword">ha</span>.d/</div><div class="line">scp  authkeys  <span class="keyword">ha</span>.<span class="keyword">cf</span> haresources   slave:/etc/<span class="keyword">ha</span>.d/</div></pre></td></tr></table></figure>
<h5 id="8-到从上-slave-编辑ha-cf"><a href="#8-到从上-slave-编辑ha-cf" class="headerlink" title="8. 到从上(slave) 编辑ha.cf"></a>8. 到从上(slave) 编辑ha.cf</h5><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vi  /etc/ha.d/ha.cf   <span class="comment">//只需要更改一个地方</span></div><div class="line">ucast eth1 <span class="number">192.168</span><span class="number">.0</span><span class="number">.162</span> 改为   ucast eth1 <span class="number">192.168</span><span class="number">.0</span><span class="number">.161</span></div></pre></td></tr></table></figure>
<h5 id="9-启动heartbeat"><a href="#9-启动heartbeat" class="headerlink" title="9. 启动heartbeat"></a>9. 启动heartbeat</h5><p>先主后从</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service heartbeat <span class="literal">start</span></div></pre></td></tr></table></figure>
<h5 id="10-检查测试"><a href="#10-检查测试" class="headerlink" title="10. 检查测试"></a>10. 检查测试</h5><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">ifconfig</span></div></pre></td></tr></table></figure>
<p> 看是否有 eth0:0</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ps</span> aux |<span class="keyword">grep</span> nginx</div></pre></td></tr></table></figure>
<p>  看是否有nginx进程</p>
<h5 id="11-测试1"><a href="#11-测试1" class="headerlink" title="11.  测试1"></a>11.  测试1</h5><p>主上故意禁ping</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -I <span class="keyword">INPUT</span> -p icmp -j <span class="keyword">DROP</span></div></pre></td></tr></table></figure>
<p>可以看到日志/var/log/ha-log 发生如下变化</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">ResourceManager(<span class="keyword">default</span>)[<span class="number">1751</span>]: <span class="number">2017</span><span class="regexp">/03/</span><span class="number">28</span><span class="string">_23:</span><span class="number">01</span>:<span class="number">07</span> <span class="string">info:</span> Running <span class="regexp">/etc/</span>init.d/nginx  start</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">06</span>:<span class="number">49</span> master <span class="string">heartbeat:</span> [<span class="number">1543</span>]: <span class="string">WARN:</span> node <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>: is dead</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">06</span>:<span class="number">49</span> master <span class="string">heartbeat:</span> [<span class="number">1543</span>]: <span class="string">info:</span> Link <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span> dead.</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">06</span>:<span class="number">49</span> master <span class="string">ipfail:</span> [<span class="number">1571</span>]: <span class="string">info:</span> Status <span class="string">update:</span> Node <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span> now has status dead</div><div class="line">harc(<span class="keyword">default</span>)[<span class="number">2053</span>]:    <span class="number">2017</span><span class="regexp">/03/</span><span class="number">28</span><span class="string">_23:</span><span class="number">06</span>:<span class="number">49</span> <span class="string">info:</span> Running <span class="regexp">/etc/</span>ha.d<span class="comment">//rc.d/status status</span></div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">06</span>:<span class="number">51</span> master <span class="string">ipfail:</span> [<span class="number">1571</span>]: <span class="string">info:</span> <span class="string">NS:</span> We are dead. :&lt;</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">06</span>:<span class="number">51</span> master <span class="string">ipfail:</span> [<span class="number">1571</span>]: <span class="string">info:</span> Link Status <span class="string">update:</span> Link <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span> now has status dead</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">06</span>:<span class="number">52</span> master <span class="string">ipfail:</span> [<span class="number">1571</span>]: <span class="string">info:</span> We are dead. :&lt;</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">06</span>:<span class="number">52</span> master <span class="string">ipfail:</span> [<span class="number">1571</span>]: <span class="string">info:</span> Asking other side <span class="keyword">for</span> ping node count.</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">06</span>:<span class="number">55</span> master <span class="string">ipfail:</span> [<span class="number">1571</span>]: <span class="string">info:</span> Giving up because we were told that we have less ping nodes.</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">06</span>:<span class="number">55</span> master <span class="string">ipfail:</span> [<span class="number">1571</span>]: <span class="string">info:</span> Delayed giveup <span class="keyword">in</span> <span class="number">4</span> seconds.</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">06</span>:<span class="number">59</span> master <span class="string">ipfail:</span> [<span class="number">1571</span>]: <span class="string">info:</span> giveup() called (timeout worked)</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">06</span>:<span class="number">59</span> master <span class="string">heartbeat:</span> [<span class="number">1543</span>]: <span class="string">info:</span> master wants to go standby [all]</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">07</span>:<span class="number">00</span> master <span class="string">heartbeat:</span> [<span class="number">1543</span>]: <span class="string">info:</span> <span class="string">standby:</span> slave can take our all resources</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">07</span>:<span class="number">00</span> master <span class="string">heartbeat:</span> [<span class="number">2079</span>]: <span class="string">info:</span> give up all HA resources (standby).</div><div class="line">ResourceManager(<span class="keyword">default</span>)[<span class="number">2092</span>]: <span class="number">2017</span><span class="regexp">/03/</span><span class="number">28</span><span class="string">_23:</span><span class="number">07</span>:<span class="number">00</span> <span class="string">info:</span> Releasing resource <span class="string">group:</span> master <span class="number">192.168</span><span class="number">.0</span><span class="number">.150</span><span class="regexp">/24/</span><span class="string">eth0:</span><span class="number">0</span> nginx</div><div class="line">ResourceManager(<span class="keyword">default</span>)[<span class="number">2092</span>]: <span class="number">2017</span><span class="regexp">/03/</span><span class="number">28</span><span class="string">_23:</span><span class="number">07</span>:<span class="number">00</span> <span class="string">info:</span> Running <span class="regexp">/etc/</span>init.d/nginx  stop</div><div class="line">ResourceManager(<span class="keyword">default</span>)[<span class="number">2092</span>]: <span class="number">2017</span><span class="regexp">/03/</span><span class="number">28</span><span class="string">_23:</span><span class="number">07</span>:<span class="number">00</span> <span class="string">info:</span> Running <span class="regexp">/etc/</span>ha.d<span class="regexp">/resource.d/</span>IPaddr <span class="number">192.168</span><span class="number">.0</span><span class="number">.150</span><span class="regexp">/24/</span><span class="string">eth0:</span><span class="number">0</span> stop</div><div class="line">IPaddr(IPaddr_192<span class="number">.168</span><span class="number">.0</span><span class="number">.150</span>)[<span class="number">2178</span>]:     <span class="number">2017</span><span class="regexp">/03/</span><span class="number">28</span><span class="string">_23:</span><span class="number">07</span>:<span class="number">00</span> <span class="string">INFO:</span> IP status = ok, IP_CIP=</div><div class="line"><span class="regexp">/usr/</span>lib<span class="regexp">/ocf/</span>resource.d<span class="comment">//heartbeat/IPaddr(IPaddr_192.168.0.150)[2152]:  2017/03/28_23:07:00 INFO:  Success</span></div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">07</span>:<span class="number">00</span> master <span class="string">heartbeat:</span> [<span class="number">2079</span>]: <span class="string">info:</span> all HA resource release completed (standby).</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">07</span>:<span class="number">00</span> master <span class="string">heartbeat:</span> [<span class="number">1543</span>]: <span class="string">info:</span> Local standby process completed [all].</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">07</span>:<span class="number">02</span> master <span class="string">heartbeat:</span> [<span class="number">1543</span>]: <span class="string">WARN:</span> <span class="number">1</span> lost packet(s) <span class="keyword">for</span> [slave] [<span class="number">197</span>:<span class="number">199</span>]</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">07</span>:<span class="number">02</span> master <span class="string">heartbeat:</span> [<span class="number">1543</span>]: <span class="string">info:</span> remote resource transition completed.</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">07</span>:<span class="number">02</span> master <span class="string">heartbeat:</span> [<span class="number">1543</span>]: <span class="string">info:</span> No pkts missing from slave!</div><div class="line">Mar <span class="number">28</span> <span class="number">23</span>:<span class="number">07</span>:<span class="number">02</span> master <span class="string">heartbeat:</span> [<span class="number">1543</span>]: <span class="string">info:</span> Other node completed standby takeover of all resources.</div></pre></td></tr></table></figure>
<h5 id="12-测试2"><a href="#12-测试2" class="headerlink" title="12. 测试2"></a>12. 测试2</h5><p>主上停止heartbeat服务</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service heartbeat <span class="built_in">stop</span></div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;HA集群配置&quot;&gt;&lt;a href=&quot;#HA集群配置&quot; class=&quot;headerlink&quot; title=&quot;HA集群配置&quot;&gt;&lt;/a&gt;HA集群配置&lt;/h4&gt;&lt;p&gt;HA 即 （high available）高可用，又被叫做双机热备，用于关键性业务。 简单理解就是，有两台机
    
    </summary>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>DNS服务及安装配置</title>
    <link href="http://yoursite.com/2017/03/27/17032701/"/>
    <id>http://yoursite.com/2017/03/27/17032701/</id>
    <published>2017-03-26T18:09:44.000Z</published>
    <updated>2017-03-26T18:23:05.528Z</updated>
    
    <content type="html"><![CDATA[<h4 id="DNS介绍"><a href="#DNS介绍" class="headerlink" title="DNS介绍"></a>DNS介绍</h4><p>DNS 为Domain Name System（域名系统）的缩写，它是一种将ip地址转换成对应的主机名或将主机名转换成与之相对应ip地址的一种服务机制。 </p>
<p>其中通过域名解析出ip地址的叫做正向解析，通过ip地址解析出域名的叫做反向解析。 DNS使用TCP和UDP, 端口号都是53, 但它主要使用UDP，服务器之间备份使用TCP。 </p>
<p>全世界只有13台“根”服务器，1个主根服务器放在美国，其他12台为辅根服务器，DNS服务器根据角色可以分为：主DNS, 从DNS, 缓存DNS服务器，DNS转发服务器。</p>
<p><img src="http://i.imgur.com/HRqBRw9.jpg" alt=""><br>有了网站域名，下面来看看域名www.baidu.com是如何解析到IP的，下图为域名解析流程图：</p>
<p><img src="http://i.imgur.com/8zme6Rz.jpg" alt=""></p>
<h5 id="域名解析过程"><a href="#域名解析过程" class="headerlink" title="域名解析过程"></a>域名解析过程</h5><ol>
<li>在浏览器输入www.baidu.com域名，操作系统会先检查自己本地的hosts文件，是否有这个网址的映射关系，如果有，就先调用这个IP地址映射，完成域名解析。</li>
<li>如果hosts里没有这个域名的映射，则查找本地的DNS解析缓存，是否有这个网址映射关系，如果有，直接返回，完成域名解析。</li>
<li>如果hosts与本地DNS解析缓存器中都没有相应的网址映射关系，首先会找本机设置的首选DNS服务器，再次我们叫它本地DNS服务器，此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。</li>
<li>如果要查询的域名，不由本地DNS服务器区域解析，但该服务器已缓存了此网址的映射关系，则调用这个IP地址映射，完成域名解析，此解析不具有权威性。</li>
<li>如果本地DNS服务器本地区域文件与缓存解析都失败，则根据本地DNS服务器的设置（是否设置转发器）进行查询，如果未用本地转发，本地DNS就把请求发至13台跟DNS，跟DNS收到请求后会判断这个域名（.com）是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP。本地DNS收到IP后，将会联系负责.com域的这台服务器。这台负责.com域的服务器收到请求后，如果自己已无法解析，他会找一个关系.com域下一级的DNS服务器地址（baidu.com）域服务器，重复上面的动作进行查询，直到找到www.baidu.com主机。</li>
<li>如果用的是转发模式，此DNS服务器就会把请求转发至上一级DNS服务器，由上一级进行解析，上一级服务器如果不能解析，或找跟DNS或把转发请求转至上上级，以此循环，不管是本地DNS服务器用到是转发，还是根提示，最后都是把结果返回给本地DNS服务器，由这个DNS服务器再返回给客户机。</li>
</ol>
<h4 id="DNS安装配置"><a href="#DNS安装配置" class="headerlink" title="DNS安装配置"></a>DNS安装配置</h4><p>我们使用bind来搭建DNS服务首先：</p>
<h5 id="1-安装bind"><a href="#1-安装bind" class="headerlink" title="1. 安装bind"></a>1. 安装bind</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y <span class="built_in">bind</span> <span class="built_in">bind</span>-utils</div></pre></td></tr></table></figure>
<p>清空默认配置文件，自定义配置。<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">cp /etc/named.<span class="keyword">conf</span> /etc/named.<span class="keyword">conf</span>.bak  </div><div class="line">&gt;/etc/named.<span class="keyword">conf</span></div><div class="line">vim /etc/named.<span class="keyword">conf</span>              #写入如下配置</div><div class="line"></div><div class="line">options &#123;</div><div class="line">    directory <span class="string">"/var/named"</span>;</div><div class="line">&#125;;</div><div class="line">zone <span class="string">"."</span> <span class="keyword">IN</span>  &#123;</div><div class="line">    <span class="keyword">type</span> hint;</div><div class="line">    <span class="keyword">file</span> <span class="string">"named.ca"</span>;</div><div class="line">&#125;;</div><div class="line">zone <span class="string">"localhost"</span> <span class="keyword">IN</span> &#123;</div><div class="line">    <span class="keyword">type</span> master;</div><div class="line">    <span class="keyword">file</span> <span class="string">"localhost.zone"</span>;</div><div class="line">&#125;;</div><div class="line">zone <span class="string">"0.0.127.in-addr.arpa"</span> <span class="keyword">IN</span> &#123;</div><div class="line">    <span class="keyword">type</span> master;</div><div class="line">    <span class="keyword">file</span> <span class="string">"named.local"</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>保存配置，然后修改其属性，定义本地根域配置</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">chown <span class="keyword">named</span> /etc/<span class="keyword">named</span>.conf</div><div class="line">cd /var/<span class="keyword">named</span>/</div><div class="line">dig -t NS . &gt; <span class="keyword">named</span>.ca</div></pre></td></tr></table></figure>
<h5 id="2-增加一个域名（zone）"><a href="#2-增加一个域名（zone）" class="headerlink" title="2. 增加一个域名（zone）"></a>2. 增加一个域名（zone）</h5><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">vim /etc/named.conf </div><div class="line"><span class="comment">// 增加:</span></div><div class="line">zone <span class="string">"123.com"</span> IN &#123;</div><div class="line">        type master;</div><div class="line">        file <span class="string">"123.com.zone"</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">zone <span class="string">"189.168.192.in-addr.arpa"</span> IN &#123;</div><div class="line">        type master;</div><div class="line">        file <span class="string">"189.168.192.zone"</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 修改： </span></div><div class="line"><span class="section">listen</span>-on port <span class="number">53</span> &#123; <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>;<span class="number">192.168</span><span class="number">.189</span><span class="number">.131</span>; &#125;;</div></pre></td></tr></table></figure>
<p>编辑zone文件:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">vim /var/named/<span class="number">123.</span>com.zone</div><div class="line"><span class="comment">//增加下列配置：</span></div><div class="line"> </div><div class="line">$TTL <span class="number">1</span>D</div><div class="line">@       IN SOA  @ admin<span class="number">.123</span>.com. (</div><div class="line">                                        <span class="number">2017032602</span>       ; serial</div><div class="line">                                        <span class="number">1</span>D      ; refresh</div><div class="line">                                        <span class="number">1</span>H      ; retry</div><div class="line">                                        <span class="number">1</span>W      ; expire</div><div class="line">                                        <span class="number">3</span>H )    ; minimum</div><div class="line">       IN  NS      ns<span class="number">.123</span>.com.</div><div class="line">       IN  MX  <span class="number">5</span>   mail<span class="number">.123</span>.com.</div><div class="line">mail   IN  A       <span class="number">192.168</span><span class="number">.189</span><span class="number">.133</span></div><div class="line">ns     IN  A       <span class="number">192.168</span><span class="number">.189</span><span class="number">.131</span></div><div class="line">www    IN  A       <span class="number">11.11</span><span class="number">.11</span><span class="number">.11</span></div><div class="line">bbs    IN  CNAME    www</div></pre></td></tr></table></figure></p>
<p>编辑反解析文件:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">vim /var/named/<span class="number">189.168</span><span class="number">.192</span>.zone</div><div class="line"><span class="comment">//增加</span></div><div class="line">$TTL <span class="number">1</span>D</div><div class="line">@       IN SOA  @ admin<span class="number">.123</span>.com. (</div><div class="line">                                        <span class="number">20170326</span>       ; serial</div><div class="line">                                        <span class="number">1</span>D      ; refresh</div><div class="line">                                        <span class="number">1</span>H      ; retry</div><div class="line">                                        <span class="number">1</span>W      ; expire</div><div class="line">                                        <span class="number">3</span>H )    ; minimum</div><div class="line">       IN  NS      ns<span class="number">.123</span>.com.</div><div class="line"><span class="number">131</span>    IN  PTR     ns<span class="number">.123</span>.com.</div><div class="line"><span class="number">133</span>    IN  PTR     mail<span class="number">.123</span>.com.</div></pre></td></tr></table></figure></p>
<p>重启named服务，测试 </p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/named restart                                 </div><div class="line">停止 named：                                               [确定]</div><div class="line">启动 named：                                               [确定]</div><div class="line">dig @<span class="number">192.168</span><span class="number">.189</span><span class="number">.131</span> www<span class="number">.123</span>.com  #检测正解析</div><div class="line">dig @<span class="number">192.168</span><span class="number">.189</span><span class="number">.131</span> -x <span class="number">192.168</span><span class="number">.189</span><span class="number">.131</span> #检测反解析</div></pre></td></tr></table></figure>
<h5 id="3-配置DNS转发"><a href="#3-配置DNS转发" class="headerlink" title="3. 配置DNS转发"></a>3. 配置DNS转发</h5><p>我们配置的DNS是只能解析我们定义的zone的，我们没有定义的是不能解析的。<br>配置DNS转发就可以解析其他互联网上的域名了，前提是这个域名在互联网中的确在使用，也就是说这个域名已经被某个DNS服务器解析了。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">vim  /etc/named.conf </div><div class="line"><span class="comment">//在options&#123;&#125; 里面增加</span></div><div class="line">forward first;  </div><div class="line">forwarders &#123; <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span>; &#125;;</div></pre></td></tr></table></figure></p>
<p>这两行就是用来配置转发的，该DNS服务器不能解析的域名会转发到114.114.114.114这个DNS服务器上去解析。</p>
<h5 id="4-配置主从"><a href="#4-配置主从" class="headerlink" title="4. 配置主从"></a>4. 配置主从</h5><p>在从服务器上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y <span class="built_in">bind</span> <span class="built_in">bind</span>-utils</div></pre></td></tr></table></figure></p>
<p>修改一下从的/etc/named.conf </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">options &#123;</div><div class="line"><span class="comment">//      listen-on port 53 &#123; 127.0.0.1; &#125;; </span></div><div class="line"><span class="comment">//      listen-on-v6 port 53 &#123; ::1; &#125;;</span></div><div class="line"><span class="comment">//      注释掉后表明监听任何端口</span></div><div class="line">        directory       <span class="string">"/var/named"</span>;</div><div class="line">        dump-<span class="keyword">file</span>       <span class="string">"/var/named/data/cache_dump.db"</span>;</div><div class="line">        statistics-<span class="keyword">file</span> <span class="string">"/var/named/data/named_stats.txt"</span>;</div><div class="line">        memstatistics-<span class="keyword">file</span> <span class="string">"/var/named/data/named_mem_stats.txt"</span>;</div><div class="line">        allow-<span class="keyword">query</span>     &#123; localhost; &#125;;</div><div class="line">        recursion yes;</div><div class="line"></div><div class="line">        dnssec-enable yes;</div><div class="line">        dnssec-validation yes;</div><div class="line"></div><div class="line">        <span class="comment">/* Path to ISC DLV key */</span></div><div class="line">        bindkeys-<span class="keyword">file</span> <span class="string">"/etc/named.iscdlv.key"</span>;</div><div class="line"></div><div class="line">        managed-keys-directory <span class="string">"/var/named/dynamic"</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">logging &#123;</div><div class="line">        channel default_debug &#123;</div><div class="line">                <span class="keyword">file</span> <span class="string">"data/named.run"</span>;</div><div class="line">                severity dynamic;</div><div class="line">        &#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">zone <span class="string">"."</span> <span class="keyword">IN</span> &#123;</div><div class="line">        <span class="keyword">type</span> hint;</div><div class="line">        <span class="keyword">file</span> <span class="string">"named.ca"</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">include</span> <span class="string">"/etc/named.rfc1912.zones"</span>;</div><div class="line"><span class="keyword">include</span> <span class="string">"/etc/named.root.key"</span>;</div><div class="line"></div><div class="line">zone <span class="string">"123.com"</span> <span class="keyword">IN</span> &#123;</div><div class="line">        <span class="keyword">type</span> slave ;</div><div class="line">        <span class="keyword">file</span> <span class="string">"slaves/123.com.zone"</span>;</div><div class="line">        masters &#123; 192.168.189.131; &#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">zone <span class="string">"189.168.192.in-addr.arpa"</span> <span class="keyword">IN</span> &#123;</div><div class="line">        <span class="keyword">type</span> slave;</div><div class="line">        <span class="keyword">file</span> <span class="string">"slaves/189.168.192.zone"</span>;</div><div class="line">        masters &#123; 192.168.189.131; &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>从上生成rndc.key:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rndc-confgen -r <span class="regexp">/dev/</span>urandom -a </div><div class="line">chown <span class="string">named:</span>named <span class="regexp">/etc/</span>rndc.key</div></pre></td></tr></table></figure></p>
<p>从上启动named:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/etc/i</span>nit.d<span class="regexp">/named start</span></div></pre></td></tr></table></figure></p>
<p>启动成功后会在 /var/named/下生成一个slaves目录，这个目录下会有192.168.zone, abc.com.zone这两个文件，内容是和主上的一样的<br>在从上测试：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">dig @<span class="number">192.168</span><span class="number">.189</span><span class="number">.133</span> www<span class="number">.123</span>.com  #检测正解析</div><div class="line">dig @<span class="number">192.168</span><span class="number">.189</span><span class="number">.132</span> -x <span class="number">192.168</span><span class="number">.189</span><span class="number">.131</span> #检测反解析</div></pre></td></tr></table></figure></p>
<h5 id="5-测试主从同步"><a href="#5-测试主从同步" class="headerlink" title="5. 测试主从同步"></a>5. 测试主从同步</h5><p>在主dns上更改文件<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">vim /var/named/<span class="number">123.</span>com.zone </div><div class="line"><span class="comment">// 在最后增加一行：</span></div><div class="line"></div><div class="line">graped IN  A       <span class="number">111.111</span><span class="number">.111</span><span class="number">.111</span></div></pre></td></tr></table></figure></p>
<p>另外需要修改一下第三行的那个数字串，这个是用来做标记的，只有这个数字变化了，才可以让从自动跟着变，数字只能是变大，不能减小，<br><figure class="highlight basic"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">2016081601 </span>-&gt; <span class="number">2016081602</span></div></pre></td></tr></table></figure></p>
<p>重启主namd服务:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/etc/i</span>nit.d<span class="regexp">/named restart</span></div></pre></td></tr></table></figure></p>
<p>经测试我们发现一个问题，就是从经常会同步特别慢，这是很要命的。所以需要我们做一个特殊操作，在主上的/etc/named.conf中，123.com的zone中增加两行：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">notify yes;</div><div class="line">also-notify &#123; <span class="number">192.168</span><span class="number">.0</span><span class="number">.12</span>; &#125;;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;DNS介绍&quot;&gt;&lt;a href=&quot;#DNS介绍&quot; class=&quot;headerlink&quot; title=&quot;DNS介绍&quot;&gt;&lt;/a&gt;DNS介绍&lt;/h4&gt;&lt;p&gt;DNS 为Domain Name System（域名系统）的缩写，它是一种将ip地址转换成对应的主机名或将主机名转换
    
    </summary>
    
      <category term="Linux_Network" scheme="http://yoursite.com/categories/Linux-Network/"/>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>使用mysql-proxy 快速实现mysql 集群 读写分离</title>
    <link href="http://yoursite.com/2017/03/23/17032304/"/>
    <id>http://yoursite.com/2017/03/23/17032304/</id>
    <published>2017-03-23T10:08:04.000Z</published>
    <updated>2017-03-23T10:14:49.500Z</updated>
    
    <content type="html"><![CDATA[<h3 id="使用mysql-proxy-快速实现mysql-集群-读写分离"><a href="#使用mysql-proxy-快速实现mysql-集群-读写分离" class="headerlink" title="使用mysql-proxy 快速实现mysql 集群 读写分离"></a>使用mysql-proxy 快速实现mysql 集群 读写分离</h3><h6 id="目前较为常见的mysql读写分离分为两种："><a href="#目前较为常见的mysql读写分离分为两种：" class="headerlink" title="目前较为常见的mysql读写分离分为两种："></a>目前较为常见的mysql读写分离分为两种：</h6><ol>
<li>基于程序代码内部实现：在代码中对select操作分发到从库；其它操作由主库执行；这类方法也是目前生产环境应用最广泛，知名的如DISCUZ X2。优点是性能较好，因为在程序代码中实现，不需要增加额外的设备作为硬件开支。缺点是需要开发人员来实现，运维人员无从下手。 </li>
</ol>
<ol>
<li>基于中间代理层实现：我们都知道代理一般是位于客户端和服务器之间，代理服务器接到客户端请求后通过判断然后转发到后端数据库。在这有两个代表性程序。</li>
</ol>
<p><strong>mysql-proxy：</strong> mysql-proxy为mysql开源项目，通过其自带的lua脚本进行sql判断，虽然是mysql官方产品，但是mysql官方并不建议将mysql-proxy用到生产环境。  </p>
<p><strong>amoeba：</strong> 由陈思儒开发，作者曾就职于阿里巴巴，现就职于盛大。该程序由java语言进行开发，目前只听说阿里巴巴将其用于生产环境。另外，此项目严重缺少维护和推广（作者有个官方博客，很多用户反馈的问题发现作者不理睬） </p>
<p>经过上述简单的比较，通过程序代码实现mysql读写分离自然是一个不错的选择。但是并不是所有的应用都适合在程序代码中实现读写分离，像大型SNS、B2C这类应用可以在代码中实现，因为这样对程序代码本身改动较小；像一些大型复杂的java应用，这种类型的应用在代码中实现对代码改动就较大了。所以，像这种应用一般就会考虑使用代理层来实现。</p>
<p>下面我们看一下如何搭建mysql-proxy来实现mysql读写分离。</p>
<p>环境拓扑如下： </p>
<p><img src="http://static.oschina.net/uploads/img/201212/02005629_LhUe.jpg" alt="image"></p>
<p>关于mysql、mysql主从的搭建，在此不再演示，如下的操作均在mysql-proxy（192.168.1.200）服务器进行。</p>
<h5 id="1-安装mysql-proxy"><a href="#1-安装mysql-proxy" class="headerlink" title="1. 安装mysql-proxy"></a>1. 安装mysql-proxy</h5><p>i. 安装lua  (mysql-proxy需要使用lua脚本进行数据转发) </p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">tar zxvf </div><div class="line"><span class="keyword">lua</span>-<span class="number">5.1</span>.<span class="number">4</span>.tar.gz </div><div class="line"><span class="keyword">cd</span> <span class="keyword">lua</span>-<span class="number">5.1</span>.<span class="number">4</span> </div><div class="line"><span class="keyword">vi</span> Makefile，修改INSTALL_TOP= </div><div class="line">/usr/local/<span class="keyword">lua</span> </div><div class="line"><span class="keyword">make</span> posix </div><div class="line"><span class="keyword">make</span> install</div></pre></td></tr></table></figure>
<p>ii. 安装libevent </p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">tar zxvf libevent<span class="number">-2.0</span><span class="number">.8</span>-rc.tar.gz </div><div class="line">cd libevent<span class="number">-2.0</span><span class="number">.8</span>-rc </div><div class="line">./configure </div><div class="line">--prefix=/usr/local/libevent </div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>iii. 安装check<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tar zxvf check<span class="number">-0.9</span><span class="number">.8</span>.tar.gz </div><div class="line">cd check<span class="number">-0.9</span><span class="number">.8</span> </div><div class="line">./configure &amp;&amp; make &amp;&amp; make install</div></pre></td></tr></table></figure></p>
<p>iv. 安装mysql客户端 </p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tar zxvf mysql<span class="number">-5.0</span><span class="number">.92</span>.tar.gz </div><div class="line">cd mysql<span class="number">-5.0</span><span class="number">.92</span> </div><div class="line">./configure --without-server &amp;&amp; make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>v. 设置环境变量 （安装mysql-proxy所需变量） </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vi /etc/profile </div><div class="line"><span class="built_in">export</span> LUA_CFLAGS=<span class="string">"-I/usr/local/lua/include"</span> LUA_LIBS=<span class="string">"-L/usr/local/lua/lib -llua -ldl"</span> LDFLAGS=<span class="string">"-L/usr/local/libevent/lib -lm"</span> </div><div class="line"><span class="built_in">export</span> CPPFLAGS=<span class="string">"-I/usr/local/libevent/include"</span> </div><div class="line"><span class="built_in">export</span> CFLAGS=<span class="string">"-I/usr/local/libevent/include"</span> </div><div class="line"><span class="built_in">source</span> /etc/profile</div></pre></td></tr></table></figure>
<p>vi. 安装mysql-proxy</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">tar zxvf mysql-proxy<span class="number">-0.6</span><span class="number">.0</span>.tar.gz </div><div class="line">cd </div><div class="line">mysql-proxy<span class="number">-0.6</span><span class="number">.0</span> </div><div class="line">./configure --prefix=/usr/local/mysql-proxy --with-mysql --with-lua </div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>vii. 启动mysql-proxy </p>
<p>本次对两台数据库实现了读写分离；mysql-master为可读可写，mysql-slave为只读<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/usr/local/mysql-proxy/sbin/mysql-proxy --proxy-backend-addresses=192.168.1.201:3306 </span></div><div class="line">-<span class="ruby">-proxy-read-only-backend-addresses=<span class="number">192.168</span>.<span class="number">1.202</span><span class="symbol">:</span><span class="number">3306</span> </span></div><div class="line">-<span class="ruby">-proxy-lua-script=<span class="regexp">/usr/local</span><span class="regexp">/mysql-proxy/share</span><span class="regexp">/mysql-proxy/rw</span>-splitting.lua </span></div><div class="line">&amp;</div></pre></td></tr></table></figure></p>
<p>注：如果正常情况下启动后终端不会有任何提示信息，mysql-proxy启动后会启动两个端口4040和4041，4040用于SQL转发，4041用于管理mysql-proxy。如有多个mysql-slave可以依次在后面添加 </p>
<h5 id="2-测试"><a href="#2-测试" class="headerlink" title="2. 测试"></a>2. 测试</h5><p>i. 连接测试 </p>
<p>因为默认情况下mysql数据库不允许用户在远程连接<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mysql&gt;grant </div><div class="line"><span class="literal">all</span> privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> identified <span class="keyword">by</span> <span class="string">'123456'</span>; </div><div class="line"></div><div class="line">mysql&gt;flush privileges;</div></pre></td></tr></table></figure></p>
<p>客户端连接<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">mysql</span> <span class="selector-tag">-uroot</span> <span class="selector-tag">-p123456</span> <span class="selector-tag">-h192</span><span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.200</span> <span class="selector-tag">-P4040</span></div></pre></td></tr></table></figure></p>
<p>ii. 读写分离测试 </p>
<p>为了测试出mysql读写分离的真实性，在测试之前，需要开启两台mysql的log功能，然后在mysql-slave服务器停止复制 </p>
<p>① 在两台mysql配置文件my.cnf中加入log=query.log，然后重启</p>
<p>② 在mysql-slave上执行SQL语句stop slave</p>
<p>③ 在两台mysql上执行#tail -f /usr/local/mysql/var/query.log</p>
<p>④ 在客户端上连接mysql（三个连接以上），然后执行create、select等SQL语句，观察两台mysql的日志有何变化</p>
<p>注：生产环境中除了进行程序调试外，其它不要开启mysql查询日志，因为查询日志记录了客户端的所有语句，频繁的IO操作将会导致mysql整体性能下降 </p>
<p>总结：在上述环境中，mysql-proxy和mysql-master、mysql-slave三台服务器均存在单点故障。如果在可用性要求较高的场合，单点隐患是绝对不允许的。为了避免mysql-proxy单点隐患有两种方法，一种方法是mysql-proxy配合keepalived做双机，另一种方法是将mysql-proxy和应用服务安装到同一台服务器上；为了避免mysql-master单点故障可以使用DRBD+heartbear做双机；避免mysql-slave单点故障增加多台mysql-slave即可，因为mysql-proxy会自动屏蔽后端发生故障的mysql-slave。</p>
<p>附: mysql-proxy LUA 读写分离脚本代码:<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--[[</span></div><div class="line"><span class="comment">--</span></div><div class="line"><span class="comment">-- author : KDr2 </span></div><div class="line"><span class="comment">-- version 0.01</span></div><div class="line"><span class="comment">-- SYNOPSIS:</span></div><div class="line"><span class="comment">---  </span></div><div class="line"><span class="number">1.</span>维护了一个连接池</div><div class="line"><span class="comment">---  2.读写分离，简单的将select开头的语句放到slave上执行</span></div><div class="line"><span class="comment">---  </span></div><div class="line"><span class="number">3.</span>事务支持，所有事务放到master上执行，事务中不更改连接</div><div class="line"><span class="comment">---  4.简单日志</span></div><div class="line"><span class="comment">--</span></div><div class="line"><span class="comment">--]]</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">--- config vars</span></div><div class="line"><span class="keyword">local</span> min_idle_connections = <span class="number">4</span></div><div class="line"><span class="keyword">local</span> </div><div class="line">max_idle_connections = <span class="number">8</span></div><div class="line"><span class="keyword">local</span> log_level=<span class="number">1</span></div><div class="line"><span class="keyword">local</span> encoding=<span class="string">"utf8"</span></div><div class="line"><span class="comment">--- </span></div><div class="line"><span class="keyword">end</span> <span class="keyword">of</span> config</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- 事务标识，在事务内不归还连接</span></div><div class="line"><span class="keyword">local</span> </div><div class="line">transaction_flags=&#123;&#125;</div><div class="line">setmetatable(transaction_flags,&#123;__index=function() </div><div class="line"><span class="built_in">return</span> <span class="number">0</span> <span class="keyword">end</span>&#125;)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- log system</span></div><div class="line"><span class="built_in">log</span>=&#123;</div><div class="line">   level=&#123;debug=<span class="number">1</span>,info=<span class="number">2</span>,warn=<span class="number">3</span>,<span class="keyword">error</span>=<span class="number">4</span>&#125;,</div><div class="line">   </div><div class="line">funcs=&#123;<span class="string">"debug"</span>,<span class="string">"info"</span>,<span class="string">"warn"</span>,<span class="string">"error"</span>&#125;,</div><div class="line">&#125;</div><div class="line">function <span class="built_in">log</span>.<span class="built_in">log</span>(level,m)</div><div class="line">   </div><div class="line"><span class="keyword">if</span> level &gt;= log_level <span class="keyword">then</span></div><div class="line">      <span class="keyword">local</span> msg=<span class="string">"["</span> .. os.<span class="built_in">date</span>(<span class="string">"%Y-%m-%d %X"</span>) </div><div class="line">..<span class="string">"] "</span>.. <span class="built_in">log</span>.funcs[level] .. <span class="string">": "</span> .. tostring(m)</div><div class="line">      print(msg) <span class="comment">-- TODO  </span></div><div class="line"><span class="built_in">write</span> msg <span class="keyword">into</span> a <span class="built_in">log</span> <span class="built_in">file</span>.</div><div class="line">   <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> ipairs(<span class="built_in">log</span>.funcs) </div><div class="line">do</div><div class="line">   <span class="built_in">log</span>[v]=function(m) <span class="built_in">log</span>.<span class="built_in">log</span>(<span class="built_in">log</span>.level[v],m) <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- connect to server</span></div><div class="line">function connect_server() </div><div class="line">   <span class="built_in">log</span>.info(<span class="string">" starting </span></div><div class="line">connect_server ... ")</div><div class="line">   <span class="keyword">local</span> least_idle_conns_ndx = <span class="number">0</span></div><div class="line">   <span class="keyword">local</span> </div><div class="line">least_idle_conns = <span class="number">0</span></div><div class="line">   </div><div class="line">   <span class="keyword">for</span> i = <span class="number">1</span>, <span class="comment">#proxy.backends do</span></div><div class="line">      <span class="keyword">local</span> s </div><div class="line">= proxy.backends[i]</div><div class="line">      <span class="keyword">local</span> pool = s.pool </div><div class="line">      <span class="keyword">local</span> cur_idle = </div><div class="line">pool.users[<span class="string">""</span>].cur_idle_connections</div><div class="line"></div><div class="line"></div><div class="line">      <span class="built_in">log</span>.debug(<span class="string">"["</span>.. s.address ..<span class="string">"].connected_clients = "</span> .. </div><div class="line">s.connected_clients)</div><div class="line">      <span class="built_in">log</span>.debug(<span class="string">"["</span>.. s.address ..<span class="string">"].idling_connections </span></div><div class="line">= " .. cur_idle)</div><div class="line">      <span class="built_in">log</span>.debug(<span class="string">"["</span>.. s.address ..<span class="string">"].type = "</span> .. </div><div class="line">s.type)</div><div class="line">      <span class="built_in">log</span>.debug(<span class="string">"["</span>.. s.address ..<span class="string">"].state = "</span> .. s.state)</div><div class="line"></div><div class="line"></div><div class="line">      <span class="keyword">if</span> s.state ~= proxy.BACKEND_STATE_DOWN <span class="keyword">then</span></div><div class="line">         <span class="comment">-- try to </span></div><div class="line">connect <span class="keyword">to</span> each backend once <span class="keyword">at</span> least</div><div class="line">         <span class="keyword">if</span> cur_idle == <span class="number">0</span> </div><div class="line"><span class="keyword">then</span></div><div class="line">            proxy.connection.backend_ndx = i</div><div class="line">            </div><div class="line"><span class="built_in">log</span>.info(<span class="string">"server ["</span>.. proxy.backends[i].address ..<span class="string">"] open new </span></div><div class="line">connection")</div><div class="line"><span class="built_in">            return</span></div><div class="line">         <span class="keyword">end</span></div><div class="line">         <span class="comment">-- try to open at </span></div><div class="line">least min_idle_connections</div><div class="line">         <span class="keyword">if</span> least_idle_conns_ndx == <span class="number">0</span> </div><div class="line"><span class="keyword">or</span></div><div class="line">            ( cur_idle &lt; min_idle_connections <span class="keyword">and</span> </div><div class="line">              </div><div class="line">cur_idle &lt; least_idle_conns ) <span class="keyword">then</span></div><div class="line">            least_idle_conns_ndx = </div><div class="line">i</div><div class="line">            least_idle_conns = cur_idle</div><div class="line">         <span class="keyword">end</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">   </div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"></div><div class="line">   <span class="keyword">if</span> least_idle_conns_ndx &gt; <span class="number">0</span> <span class="keyword">then</span></div><div class="line">      proxy.connection.backend_ndx </div><div class="line">= least_idle_conns_ndx</div><div class="line">   <span class="keyword">end</span></div><div class="line">   </div><div class="line">   <span class="keyword">if</span> proxy.connection.backend_ndx </div><div class="line">&gt; <span class="number">0</span> <span class="keyword">then</span> </div><div class="line">      <span class="keyword">local</span> s = </div><div class="line">proxy.backends[proxy.connection.backend_ndx]</div><div class="line">      <span class="keyword">local</span> pool = s.pool </div><div class="line"></div><div class="line">      <span class="keyword">local</span> cur_idle = pool.users[<span class="string">""</span>].cur_idle_connections</div><div class="line"></div><div class="line"></div><div class="line">      <span class="keyword">if</span> cur_idle &gt;= min_idle_connections <span class="keyword">then</span></div><div class="line">         <span class="comment">-- we have 4 </span></div><div class="line">idling connections <span class="keyword">in</span> <span class="keyword">the</span> pool, <span class="keyword">that</span>'s good enough</div><div class="line">         <span class="built_in">log</span>.debug(<span class="string">"using </span></div><div class="line">pooled connection from: " .. proxy.connection.backend_ndx)</div><div class="line"><span class="built_in">         return</span> </div><div class="line">proxy.PROXY_IGNORE_RESULT</div><div class="line">      <span class="keyword">end</span></div><div class="line">   <span class="keyword">end</span></div><div class="line">   <span class="comment">-- open a new connection </span></div><div class="line"></div><div class="line">   <span class="built_in">log</span>.info(<span class="string">"opening new connection on: "</span> .. </div><div class="line">proxy.backends[proxy.connection.backend_ndx].address)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">---</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- auth.packet is the packet</span></div><div class="line">function read_auth_result( auth )</div><div class="line">   <span class="keyword">if</span> </div><div class="line">auth.packet:byte() == proxy.MYSQLD_PACKET_OK <span class="keyword">then</span></div><div class="line">      <span class="comment">-- 连接正常</span></div><div class="line">      </div><div class="line">proxy.connection.backend_ndx = <span class="number">0</span></div><div class="line">   elseif auth.packet:byte() == </div><div class="line">proxy.MYSQLD_PACKET_EOF <span class="keyword">then</span></div><div class="line">      <span class="comment">-- we received either a </span></div><div class="line">      <span class="comment">-- * </span></div><div class="line">MYSQLD_PACKET_ERR <span class="keyword">and</span> <span class="keyword">the</span> auth failed <span class="keyword">or</span></div><div class="line">      <span class="comment">-- * MYSQLD_PACKET_EOF which </span></div><div class="line">means a OLD PASSWORD (<span class="number">4.0</span>) was sent</div><div class="line">      <span class="built_in">log</span>.<span class="keyword">error</span>(<span class="string">"(read_auth_result) ... </span></div><div class="line">not ok yet");</div><div class="line">   elseif auth.packet:byte() == proxy.MYSQLD_PACKET_ERR </div><div class="line"><span class="keyword">then</span></div><div class="line">      <span class="built_in">log</span>.<span class="keyword">error</span>(<span class="string">"auth failed!"</span>)</div><div class="line">   <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">--- </span></div><div class="line"><span class="comment">-- read/write splitting</span></div><div class="line">function read_query( packet ) </div><div class="line">   </div><div class="line"><span class="built_in">log</span>.debug(<span class="string">"[read_query]"</span>)</div><div class="line">   <span class="built_in">log</span>.debug(<span class="string">"authed backend = "</span> .. </div><div class="line">proxy.connection.backend_ndx)</div><div class="line">   <span class="built_in">log</span>.debug(<span class="string">"used db = "</span> .. </div><div class="line">proxy.connection.client.default_db)</div><div class="line"></div><div class="line"></div><div class="line">   <span class="keyword">if</span> packet:byte() == proxy.COM_QUIT <span class="keyword">then</span></div><div class="line">      proxy.response = </div><div class="line">&#123;</div><div class="line">         type = proxy.MYSQLD_PACKET_OK,</div><div class="line">      &#125;</div><div class="line"><span class="built_in">      return</span> </div><div class="line">proxy.PROXY_SEND_RESULT</div><div class="line">   <span class="keyword">end</span></div><div class="line"></div><div class="line"></div><div class="line">   <span class="keyword">if</span> proxy.connection.backend_ndx == <span class="number">0</span> <span class="keyword">then</span></div><div class="line">      <span class="keyword">local</span> </div><div class="line">is_read=(<span class="built_in">string</span>.upper(packet:sub(<span class="number">2</span>))):match(<span class="string">"^SELECT"</span>)</div><div class="line">      <span class="keyword">local</span> </div><div class="line">target_type=proxy.BACKEND_TYPE_RW</div><div class="line">      <span class="keyword">if</span> is_read <span class="keyword">then</span> </div><div class="line">target_type=proxy.BACKEND_TYPE_RO <span class="keyword">end</span></div><div class="line">      <span class="keyword">for</span> i = <span class="number">1</span>, <span class="comment">#proxy.backends </span></div><div class="line">do</div><div class="line">         <span class="keyword">local</span> s = proxy.backends[i]</div><div class="line">         <span class="keyword">local</span> pool = s.pool </div><div class="line"></div><div class="line">         <span class="keyword">local</span> cur_idle = </div><div class="line">pool.users[proxy.connection.client.username].cur_idle_connections</div><div class="line">         </div><div class="line"></div><div class="line">         <span class="keyword">if</span> cur_idle &gt; <span class="number">0</span> <span class="keyword">and</span> </div><div class="line">            s.state ~= </div><div class="line">proxy.BACKEND_STATE_DOWN <span class="keyword">and</span> </div><div class="line">            s.type == target_type </div><div class="line"><span class="keyword">then</span></div><div class="line">            proxy.connection.backend_ndx = i</div><div class="line">            </div><div class="line">break</div><div class="line">         <span class="keyword">end</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">   <span class="keyword">end</span></div><div class="line">   <span class="comment">-- sync the client-side </span></div><div class="line">default_db <span class="keyword">with</span> <span class="keyword">the</span> server-side default_db</div><div class="line">   <span class="keyword">if</span> proxy.connection.server <span class="keyword">and</span> </div><div class="line">proxy.connection.client.default_db ~= proxy.connection.server.default_db </div><div class="line"><span class="keyword">then</span></div><div class="line">      <span class="keyword">local</span> server_db=proxy.connection.server.default_db</div><div class="line">      <span class="keyword">local</span> </div><div class="line">client_db=proxy.connection.client.default_db</div><div class="line">      <span class="keyword">local</span> default_db= </div><div class="line">(<span class="comment">#client_db &gt; 0) and client_db or server_db</span></div><div class="line">      <span class="keyword">if</span> <span class="comment">#default_db &gt; 0 </span></div><div class="line"><span class="keyword">then</span></div><div class="line">         proxy.queries:append(<span class="number">2</span>, <span class="built_in">string</span>.char(proxy.COM_INIT_DB) .. </div><div class="line">default_db)</div><div class="line">         proxy.queries:append(<span class="number">2</span>, <span class="built_in">string</span>.char(proxy.COM_QUERY) .. </div><div class="line"><span class="string">"set names '"</span> .. encoding ..<span class="string">"'"</span>)</div><div class="line">         <span class="built_in">log</span>.info(<span class="string">"change database to "</span> .. </div><div class="line">default_db);</div><div class="line">      <span class="keyword">end</span></div><div class="line">   <span class="keyword">end</span></div><div class="line">   <span class="keyword">if</span> proxy.connection.backend_ndx &gt; <span class="number">0</span> </div><div class="line"><span class="keyword">then</span></div><div class="line">      <span class="built_in">log</span>.debug(<span class="string">"Query["</span> .. packet:sub(<span class="number">2</span>) .. <span class="string">"] Target is ["</span> .. </div><div class="line">proxy.backends[proxy.connection.backend_ndx].address ..<span class="string">"]"</span>)</div><div class="line">   <span class="keyword">end</span></div><div class="line">   </div><div class="line">proxy.queries:append(<span class="number">1</span>, packet)</div><div class="line"><span class="built_in">   return</span> proxy.PROXY_SEND_QUERY</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">---</span></div><div class="line"><span class="comment">-- as long as we are in a transaction keep the connection</span></div><div class="line"><span class="comment">-- </span></div><div class="line">otherwise release <span class="keyword">it</span> so another client can use <span class="keyword">it</span></div><div class="line">function read_query_result( </div><div class="line">inj ) </div><div class="line">   <span class="keyword">local</span> res      = assert(inj.resultset)</div><div class="line">   <span class="keyword">local</span> flags    = </div><div class="line">res.flags</div><div class="line"></div><div class="line"></div><div class="line">   <span class="keyword">if</span> inj.<span class="built_in">id</span> ~= <span class="number">1</span> <span class="keyword">then</span></div><div class="line">      <span class="comment">-- ignore the result of the USE </span></div><div class="line">&lt;default_db&gt;</div><div class="line"><span class="built_in">      return</span> proxy.PROXY_IGNORE_RESULT</div><div class="line">   <span class="keyword">end</span></div><div class="line">   </div><div class="line">is_in_transaction = flags.in_trans</div><div class="line"></div><div class="line"></div><div class="line">   <span class="keyword">if</span> flags.in_trans <span class="keyword">then</span></div><div class="line">      </div><div class="line">transaction_flags[proxy.connection.server.thread_id] = </div><div class="line">transaction_flags[proxy.connection.server.thread_id] + <span class="number">1</span></div><div class="line">   elseif </div><div class="line">inj.query:sub(<span class="number">2</span>):lower():match(<span class="string">"^%s*commit%s*$"</span>) <span class="keyword">or</span> </div><div class="line">inj.query:sub(<span class="number">2</span>):lower():match(<span class="string">"^%s*rollback%s*$"</span>) <span class="keyword">then</span></div><div class="line">      </div><div class="line">transaction_flags[proxy.connection.server.thread_id] = </div><div class="line">transaction_flags[proxy.connection.server.thread_id] - <span class="number">1</span></div><div class="line">      <span class="keyword">if</span> </div><div class="line">transaction_flags[proxy.connection.server.thread_id] &lt; <span class="number">0</span> <span class="keyword">then</span> </div><div class="line">transaction_flags[proxy.connection.server.thread_id] = <span class="number">0</span> <span class="keyword">end</span></div><div class="line">   <span class="keyword">end</span></div><div class="line">   </div><div class="line"></div><div class="line">   <span class="built_in">log</span>.debug(<span class="string">"transaction res : "</span> .. </div><div class="line">tostring(transaction_flags[proxy.connection.server.thread_id]));</div><div class="line">   <span class="keyword">if</span> </div><div class="line">transaction_flags[proxy.connection.server.thread_id]==<span class="number">0</span> <span class="keyword">or</span> </div><div class="line">transaction_flags[proxy.connection.server.thread_id] == nil <span class="keyword">then</span> </div><div class="line">      <span class="comment">-- </span></div><div class="line">isnot <span class="keyword">in</span> a <span class="keyword">transaction</span>, need <span class="keyword">to</span> release <span class="keyword">the</span> backend</div><div class="line">      </div><div class="line">proxy.connection.backend_ndx = <span class="number">0</span></div><div class="line">   <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">--- </span></div><div class="line"><span class="comment">-- close the connections if we have enough connections in the </span></div><div class="line">pool</div><div class="line"><span class="comment">--</span></div><div class="line"><span class="comment">-- @return nil - close connection </span></div><div class="line"><span class="comment">-- IGNORE_RESULT - store </span></div><div class="line">connection <span class="keyword">in</span> <span class="keyword">the</span> pool</div><div class="line">function disconnect_client()</div><div class="line">   </div><div class="line"><span class="built_in">log</span>.debug(<span class="string">"[disconnect_client]"</span>)</div><div class="line">   <span class="keyword">if</span> proxy.connection.backend_ndx == <span class="number">0</span> </div><div class="line"><span class="keyword">then</span></div><div class="line">      <span class="keyword">for</span> i = <span class="number">1</span>, <span class="comment">#proxy.backends do</span></div><div class="line">         <span class="keyword">local</span> s = </div><div class="line">proxy.backends[i]</div><div class="line">         <span class="keyword">local</span> pool = s.pool </div><div class="line">         <span class="keyword">local</span> cur_idle = </div><div class="line">pool.users[proxy.connection.client.username].cur_idle_connections</div><div class="line">         </div><div class="line"></div><div class="line">         <span class="keyword">if</span> s.state ~= proxy.BACKEND_STATE_DOWN <span class="keyword">and</span></div><div class="line">            cur_idle </div><div class="line">&gt; max_idle_connections <span class="keyword">then</span></div><div class="line">            <span class="comment">-- try to disconnect a </span></div><div class="line">backend</div><div class="line">            proxy.connection.backend_ndx = i</div><div class="line">            </div><div class="line"><span class="built_in">log</span>.info(<span class="string">"["</span>.. proxy.backends[i].address ..<span class="string">"] closing connection, idling: "</span> .. </div><div class="line">cur_idle)</div><div class="line"><span class="built_in">            return</span></div><div class="line">         <span class="keyword">end</span></div><div class="line">      <span class="keyword">end</span></div><div class="line"><span class="built_in">      return</span> </div><div class="line">proxy.PROXY_IGNORE_RESULT</div><div class="line">   <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;使用mysql-proxy-快速实现mysql-集群-读写分离&quot;&gt;&lt;a href=&quot;#使用mysql-proxy-快速实现mysql-集群-读写分离&quot; class=&quot;headerlink&quot; title=&quot;使用mysql-proxy 快速实现mysql 集群 读写分
    
    </summary>
    
    
      <category term="mysql" scheme="http://yoursite.com/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>查看mysql主从复制延迟和数据中断--带脚本</title>
    <link href="http://yoursite.com/2017/03/23/17032303/"/>
    <id>http://yoursite.com/2017/03/23/17032303/</id>
    <published>2017-03-23T10:07:14.000Z</published>
    <updated>2017-03-23T10:14:39.464Z</updated>
    
    <content type="html"><![CDATA[<p>查看mySQL延迟的方法，查看了多个案例，大家众说纷纭，意见差不多一致。如下也是我参考别人经验做的一些测试，希望能检测到mysql复制延迟、数据中断。</p>
<h4 id="方法一、查看Seconds-Behind-Master"><a href="#方法一、查看Seconds-Behind-Master" class="headerlink" title="方法一、查看Seconds_Behind_Master"></a>方法一、查看Seconds_Behind_Master</h4><p><strong>该参数有如下值：</strong></p>
<p>NULL  表示io_thread或sql_thread有一个发生故障，就是说该线程的Running状态时No，而非Yes<br>0     表示主从复制良好，没有lag存在<br>正值  表示主从已出现延时，数字越大表示从库落后主库越多<br>负值  很罕见，是一个BUG，按理说不应该出现</p>
<p>该方法是使用命令show slave status,通过比较SQL THREAD接受events时间的时间戳与IO THREAD执行事件events时间戳的差值–秒数，来确定slave落后于master多少，如主从</p>
<p>时间不同，改时间的计算不受影响<br>众所周知备库relay-log和主库的bin-log里的内容一样，真正和主库有关两的是io_thread，当主库I/O负载很大或网络阻塞时，io_thread不能及时复制binlog，而sql_thread一</p>
<p>直能跟上io_thread的脚步，这时seconds_behind_master的值是0，实际上却不是，这时用该值作为延迟参考则不准。<br>change master to master_host=’192.168.2.7’,master_user=’tongbu’,master_password=’123456’,master_log_file=’mysql-bin.000008’,master_log_pos=291263843;</p>
<h4 id="方法二、使用pt-heartbeat工具"><a href="#方法二、使用pt-heartbeat工具" class="headerlink" title="方法二、使用pt-heartbeat工具"></a>方法二、使用pt-heartbeat工具</h4><p> 该工具可以计算出MySQL复制或者是PostgreSQL,它可以更新master或者监控复制。它还可以从f 读取配置。它借助timestmp的比较实现的，首先需要保证主从服务器时间必须要</p>
<p>保持一致，通过与相同的一个NTP server同步时钟。它需要在主库上创建一个heartbeat的表，里面的时间戳ts就是当前的时间戳 now()，该结构也会被复制到从库上。表建好以后</p>
<p>，会在主库上以后台进程的模式去执行一行更新操作的命令，定期去向表中的插入数据，这 个周期默认为1 秒，同时从库也会在后台执行一个监控命令，与主库保持一致的周期</p>
<p>+0.5S（默认0.5S延迟检查）去比较，复制过来记录的ts值与主库上的同一条ts值，差值为0表示无延时，差值越大表示 延时的秒数越多。</p>
<p>使用工具前提：</p>
<ol>
<li><p>在主库上建立heartbeat表</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pt-heartbeat -<span class="keyword">h</span> localhost -<span class="keyword">D</span> <span class="keyword">test</span>  --create-<span class="keyword">table</span> --<span class="keyword">update</span></div></pre></td></tr></table></figure>
</li>
<li><p>更新主库上的heartbeat</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">pt</span><span class="literal">-</span><span class="comment">heartbeat</span> <span class="literal">-</span><span class="comment">D</span> <span class="comment">test</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">master</span><span class="literal">-</span><span class="comment">server</span><span class="literal">-</span><span class="comment">id=1</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">update</span></div></pre></td></tr></table></figure>
</li>
<li><p>在从库上监控复制延迟</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">pt-heartbeat --user=tongbu --password='<span class="number">123456</span>' -D test --monitor -h <span class="number">192.168</span><span class="number">.2</span><span class="number">.9</span> --print-master-server-id</div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.01</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div><div class="line"><span class="number">0.00</span>s [  <span class="number">0.00</span>s,  <span class="number">0.00</span>s,  <span class="number">0.00</span>s ] <span class="number">1</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>当然还有其他一些操作命令：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#将主库上的update使用守护进程方式调度</span></div><div class="line"><span class="string">pt-heartbeat </span>-D <span class="string">test </span><span class="built_in">--master-server-id=1</span> <span class="built_in">--update</span> <span class="built_in">--daemonize</span></div><div class="line"><span class="comment">#修改主库上的更新时间间隔为2s</span></div><div class="line"><span class="string">pt-heartbeat </span>-D <span class="string">test </span><span class="built_in">--update</span> <span class="built_in">--daemonize</span> <span class="built_in">--interval=2</span></div><div class="line"><span class="comment">#修改主库上的pt-heartbeat守护进程</span></div><div class="line"><span class="string">pt-heartbeat </span><span class="built_in">--stop</span></div><div class="line"><span class="string">Successfully </span><span class="string">created </span><span class="string">file </span>/<span class="string">tmp/</span><span class="string">pt-heartbeat-</span><span class="string">sentinel</span></div><div class="line"><span class="string">rm </span>-<span class="string">rf </span>/<span class="string">tmp/</span><span class="string">pt-heartbeat-</span><span class="string">sentinel</span></div><div class="line"><span class="comment">#单词查看从库上的延迟情况</span></div><div class="line"><span class="string">pt-heartbeat </span><span class="built_in">--user=tongbu</span> <span class="built_in">--password='123456'</span> -D <span class="string">test </span> -h <span class="string">192.</span><span class="string">168.</span>2.9 <span class="built_in">--check</span></div><div class="line">0.<span class="string">00</span></div><div class="line"><span class="comment">#使用守护进程监控从库并输出日志</span></div><div class="line"><span class="string">pt-heartbeat </span><span class="built_in">--user=tongbu</span> <span class="built_in">--password='123456'</span> -h <span class="string">192.</span><span class="string">168.</span>2.9 -D <span class="string">test </span><span class="built_in">--master-server-id=1</span> <span class="built_in">--monitor</span> <span class="built_in">--print-master-server-id</span> <span class="built_in">--daemonize</span> <span class="built_in">--log=/var/log/pt_slave_lag.log</span></div></pre></td></tr></table></figure>
<hr>
<p>如下是脚本的方式，只不过使用脚本的方式实现的。如果有什么地方需要完善的，请各位看客留言提示哦</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line">#description:check slave replication delay</div><div class="line">PT=`which pt-heartbeat`</div><div class="line">ADMIN=`which mysqladmin`</div><div class="line">MYSQL=`which mysql`</div><div class="line">WARN=<span class="number">10</span></div><div class="line">CRITIC=<span class="number">20</span></div><div class="line">COMMON=<span class="number">3</span></div><div class="line">MASTERID=<span class="number">1</span></div><div class="line">###############</div><div class="line">watch_update()&#123;</div><div class="line">RE=`ps -ef|grep $PT|grep -v grep|grep <span class="string">"\--update"</span>`</div><div class="line"><span class="keyword">if</span> [ ! -n <span class="string">"$RE"</span> ];then</div><div class="line">   $PT -D test --master-server-id=$MASTERID --update --daemonize</div><div class="line">fi</div><div class="line">&#125;</div><div class="line">################</div><div class="line">watch_mysql()&#123;</div><div class="line">SAFE_STATUS=`ps -ef|grep -w mysqld_safe|grep -v grep`</div><div class="line">MYSQLD_STATUS=`ps -ef|grep -w mysqld|grep -v grep`</div><div class="line"><span class="keyword">if</span> [ ! -n <span class="string">"$SAFE_STATUS"</span> ];then</div><div class="line">   echo <span class="string">"Mysqld_safe doesn't running,Please check your mysqld_safe status"</span></div><div class="line">   exit <span class="number">1</span></div><div class="line">fi</div><div class="line"><span class="keyword">if</span> [ ! -n <span class="string">"$MYSQLD_STATUS"</span> ];then</div><div class="line">   echo <span class="string">"Mysqld program status --stop,Please check your mysqld status "</span></div><div class="line">   exit <span class="number">1</span></div><div class="line">fi</div><div class="line">&#125;</div><div class="line">####################</div><div class="line">watch_mysql_slave()&#123;</div><div class="line">REP_STATUS=`$ADMIN processlist|grep <span class="string">"Binlog Dump"</span>`</div><div class="line"><span class="keyword">if</span> [ ! -n <span class="string">"$REP_STATUS"</span> ];then</div><div class="line">    echo <span class="string">"slave process doesn't running,Please check your replication"</span></div><div class="line">    exit <span class="number">1</span></div><div class="line">fi</div><div class="line">&#125;</div><div class="line">#################</div><div class="line">enter_slave_info()&#123;</div><div class="line">  echo <span class="string">"please enter your slave username:"</span></div><div class="line">  read NAME</div><div class="line">  <span class="keyword">if</span> [  -n <span class="string">"$NAME"</span> ];then</div><div class="line">      echo <span class="string">" you enter username is: $NAME"</span></div><div class="line">  fi</div><div class="line">  </div><div class="line">  echo <span class="string">"please enter your slave user password:"</span></div><div class="line">  read PASS</div><div class="line">  <span class="keyword">if</span> [ -n <span class="string">"$PASS"</span> ];then</div><div class="line">      echo <span class="string">"you enter user password is: $PASS"</span></div><div class="line">  fi  </div><div class="line">  </div><div class="line">  echo <span class="string">"please enter your slave hostname or address:"</span></div><div class="line">  read ADDR</div><div class="line">  <span class="keyword">if</span> [ -n <span class="string">"$ADDR"</span> ];then</div><div class="line">      echo <span class="string">"you enter slave hostname or address is: $ADDR"</span></div><div class="line">  fi</div><div class="line">&#125;</div><div class="line">##################</div><div class="line">watch_slave_delay()&#123;</div><div class="line">#  echo <span class="string">"please enter your watch options(1.check 2.monitor)"</span></div><div class="line">#  read OPTION</div><div class="line">#  <span class="keyword">if</span>  [ $OPTION -eq <span class="number">1</span> ];then</div><div class="line">      SLAVE_DELAY=`$PT --user=$NAME --password=<span class="string">"$PASS"</span> -h $ADDR -D test --master-server-id=$MASTERID --check --print-master-server-id`</div><div class="line">#  elif [ $OPTION -eq <span class="number">2</span> ];then</div><div class="line">#      `$PT --user=$NAME --password=<span class="string">"PASS"</span> -h $ADDR -D test --master-server-id=$MASTERID --monitor --print-master-server-id`</div><div class="line">#  else</div><div class="line">#       echo <span class="string">"your enter are error,now EXIT"</span></div><div class="line">#       exit <span class="number">1</span></div><div class="line">#  fi</div><div class="line"><span class="keyword">if</span> [ ! -n <span class="string">"$SLAVE_DELAY"</span> ];then</div><div class="line">   echo <span class="string">"Your pt-heartbeat tool must haven't install or you username,password,slave hostname ERROR"</span></div><div class="line">   exit <span class="number">1</span></div><div class="line">else</div><div class="line">   echo <span class="string">"DELAY TIME:  $SLAVE_DELAY"</span></div><div class="line">fi  </div><div class="line">&#125;</div><div class="line"></div><div class="line">##################################</div><div class="line">watch_slave_interrupt()&#123;</div><div class="line">  INT_RE=`$MYSQL -s -u $NAME -p<span class="string">"$PASS"</span> -h $ADDR -e <span class="string">'show slave status\G'</span>|grep <span class="string">"Last_Error:"</span>`</div><div class="line">  <span class="keyword">if</span> [ -n <span class="string">"$INT_RE"</span> ];then</div><div class="line">    echo <span class="string">"$INT_RE"</span></div><div class="line">  else</div><div class="line">    echo  <span class="string">"INTERUUPT Info: "</span></div><div class="line">    echo  <span class="string">"$INT_RE"</span></div><div class="line">  fi</div><div class="line">&#125;</div><div class="line">########################</div><div class="line">WATCH()&#123;</div><div class="line">watch_slave_delay</div><div class="line">watch_slave_interrupt</div><div class="line">&#125;</div><div class="line"></div><div class="line">#########################</div><div class="line">START_WATCH()&#123;</div><div class="line">  watch_mysql</div><div class="line">  watch_mysql_slave</div><div class="line">  watch_update</div><div class="line">  enter_slave_info </div><div class="line">&#125;</div><div class="line">##########################</div><div class="line">LOOP_WATCH()&#123;</div><div class="line">  START_WATCH</div><div class="line">echo <span class="string">"+++++++++++++ DELAY INFO  ++++++++++++++++"</span></div><div class="line">  while true;do</div><div class="line">    WATCH</div><div class="line">    sleep <span class="number">30</span></div><div class="line">  done</div><div class="line">&#125;</div><div class="line">##########################</div><div class="line">LOOP_WATCH</div></pre></td></tr></table></figure>
<p>脚本运行结果如下：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">./delay.<span class="keyword">sh</span> </div><div class="line">please enter your slave username:</div><div class="line">tongbu</div><div class="line">you enter username i<span class="variable">s:</span> tongbu</div><div class="line">please enter your slave user password:</div><div class="line"><span class="number">123456</span></div><div class="line">you enter user password i<span class="variable">s:</span> <span class="number">123456</span></div><div class="line">please enter your slave <span class="built_in">hostname</span> <span class="built_in">or</span> addres<span class="variable">s:</span></div><div class="line"><span class="number">192.168</span>.<span class="number">2.9</span></div><div class="line">you enter slave <span class="built_in">hostname</span> <span class="built_in">or</span> address i<span class="variable">s:</span> <span class="number">192.168</span>.<span class="number">2.9</span></div><div class="line">+++++++++++++ DELAY INFO  ++++++++++++++++</div><div class="line">DELAY TIME:  <span class="number">0.36</span> <span class="number">1</span></div><div class="line">Warnin<span class="variable">g:</span> Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</div><div class="line">                   Last_Error: </div><div class="line">DELAY TIME:  <span class="number">0.96</span> <span class="number">1</span></div><div class="line">Warnin<span class="variable">g:</span> Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</div><div class="line">                   Last_Error: </div><div class="line">DELAY TIME:  <span class="number">0.12</span> <span class="number">1</span></div><div class="line">Warnin<span class="variable">g:</span> Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</div><div class="line">                   Last_Error: </div><div class="line">DELAY TIME:  <span class="number">1.91</span> <span class="number">1</span></div><div class="line">Warnin<span class="variable">g:</span> Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</div><div class="line">                   Last_Error:</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;查看mySQL延迟的方法，查看了多个案例，大家众说纷纭，意见差不多一致。如下也是我参考别人经验做的一些测试，希望能检测到mysql复制延迟、数据中断。&lt;/p&gt;
&lt;h4 id=&quot;方法一、查看Seconds-Behind-Master&quot;&gt;&lt;a href=&quot;#方法一、查看Seco
    
    </summary>
    
    
      <category term="mysql" scheme="http://yoursite.com/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>XtraBackup不停机不锁表搭建MySQL主从同步实践</title>
    <link href="http://yoursite.com/2017/03/23/17032302/"/>
    <id>http://yoursite.com/2017/03/23/17032302/</id>
    <published>2017-03-23T09:39:01.000Z</published>
    <updated>2017-03-23T10:13:20.347Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://segmentfault.com/image?src=//i.v2ex.co/02ftb7pa.jpeg&amp;objectId=1190000003063874&amp;token=84a6c16fc60173037b58ca5da83f56a8" alt="image"></p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Percona XtraBackup可以说是一个相对完美的免费开源数据备份工具，支持在线无锁表同步复制和可并行高效率的安全备份恢复机制相比mysqldump来说确实让人眼前一亮，与MySQL Enterprise Backup(InnoDB Hot Backup)的功能对比可以参考扩展阅读。当然我们在实际运维过程中都应针对不同的业务需求分析和选择合适的备份恢复方案，这篇文章就是针对MySQL多实例且一个实例对应多个database的情况，实现MySQL在线不停机不锁表的主从同步，日后再继续更新分享基于XtraBackup的其它实用技能。</p>
<pre><code>XtraBackup是目前首选的备份方案之一 
</code></pre><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><h4 id="MySQL主从同步原理"><a href="#MySQL主从同步原理" class="headerlink" title="MySQL主从同步原理"></a>MySQL主从同步原理</h4><p>MySQL主从同步是在MySQL主从复制(Master-Slave Replication)基础上实现的，通过设置在Master MySQL上的binlog(使其处于打开状态)，Slave MySQL上通过一个I/O线程从Master MySQL上读取binlog，然后传输到Slave MySQL的中继日志中，然后Slave MySQL的SQL线程从中继日志中读取中继日志，然后应用到Slave MySQL的数据库中。这样实现了主从数据同步功能。</p>
<h4 id="XtraBackup备份原理"><a href="#XtraBackup备份原理" class="headerlink" title="XtraBackup备份原理"></a>XtraBackup备份原理</h4><p>innobackupex在后台线程不断追踪InnoDB的日志文件，然后复制InnoDB的数据文件。数据文件复制完成之后，日志的复制线程也会结束。这样就得到了不在同一时间点的数据副本和开始备份以后的事务日志。完成上面的步骤之后，就可以使用InnoDB崩溃恢复代码执行事务日志（redo log），以达到数据的一致性。<br>备份分为两个过程：</p>
<ol>
<li>backup，备份阶段，追踪事务日志和复制数据文件（物理备份）。</li>
<li>preparing，重放事务日志，使所有的数据处于同一个时间点，达到一致性状态。<h4 id="XtraBackup的优点"><a href="#XtraBackup的优点" class="headerlink" title="XtraBackup的优点"></a>XtraBackup的优点</h4></li>
<li>可以快速可靠的完成数据备份（复制数据文件和追踪事务日志）</li>
<li>数据备份过程中不会中断事务的处理（热备份）</li>
<li>节约磁盘空间和网络带宽</li>
<li>自动完成备份鉴定</li>
<li>因更快的恢复时间而提高在线时间</li>
</ol>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><p>MySQL步骤和my.cnf配置参考<a href="https://graped.github.io/2017/03/23/17032301/" target="_blank" rel="external">mysql主从配置</a></p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#原有主数据库版本</span></div><div class="line">mysql -V</div><div class="line">mysql  Ver 14.14 Distrib 5.5.31, for Linux (x86_64) using readline 5.1</div><div class="line"></div><div class="line"><span class="comment">#迁移从数据库版本</span></div><div class="line">mysql -V</div><div class="line">mysql  Ver 14.14 Distrib 5.6.25, for linux-glibc2.5 (x86_64) using  EditLine wrapper</div><div class="line"></div><div class="line"><span class="comment">#检查数据库引擎</span></div><div class="line">show engines;</div><div class="line"></div><div class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</div><div class="line">|<span class="string"> Engine             </span>|<span class="string"> Support </span>|<span class="string"> Comment                                                        </span>|<span class="string"> Transactions </span>|<span class="string"> XA   </span>|<span class="string"> Savepoints </span>|</div><div class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</div><div class="line">|<span class="string"> MRG_MYISAM         </span>|<span class="string"> YES     </span>|<span class="string"> Collection of identical MyISAM tables                          </span>|<span class="string"> NO           </span>|<span class="string"> NO   </span>|<span class="string"> NO         </span>|</div><div class="line">|<span class="string"> CSV                </span>|<span class="string"> YES     </span>|<span class="string"> CSV storage engine                                             </span>|<span class="string"> NO           </span>|<span class="string"> NO   </span>|<span class="string"> NO         </span>|</div><div class="line">|<span class="string"> MyISAM             </span>|<span class="string"> YES     </span>|<span class="string"> MyISAM storage engine                                          </span>|<span class="string"> NO           </span>|<span class="string"> NO   </span>|<span class="string"> NO         </span>|</div><div class="line">|<span class="string"> BLACKHOLE          </span>|<span class="string"> YES     </span>|<span class="string"> /dev/null storage engine (anything you write to it disappears) </span>|<span class="string"> NO           </span>|<span class="string"> NO   </span>|<span class="string"> NO         </span>|</div><div class="line">|<span class="string"> MEMORY             </span>|<span class="string"> YES     </span>|<span class="string"> Hash based, stored in memory, useful for temporary tables      </span>|<span class="string"> NO           </span>|<span class="string"> NO   </span>|<span class="string"> NO         </span>|</div><div class="line">|<span class="string"> InnoDB             </span>|<span class="string"> DEFAULT </span>|<span class="string"> Supports transactions, row-level locking, and foreign keys     </span>|<span class="string"> YES          </span>|<span class="string"> YES  </span>|<span class="string"> YES        </span>|</div><div class="line">|<span class="string"> ARCHIVE            </span>|<span class="string"> YES     </span>|<span class="string"> Archive storage engine                                         </span>|<span class="string"> NO           </span>|<span class="string"> NO   </span>|<span class="string"> NO         </span>|</div><div class="line">|<span class="string"> PERFORMANCE_SCHEMA </span>|<span class="string"> YES     </span>|<span class="string"> Performance Schema                                             </span>|<span class="string"> NO           </span>|<span class="string"> NO   </span>|<span class="string"> NO         </span>|</div><div class="line">|<span class="string"> FEDERATED          </span>|<span class="string"> NO      </span>|<span class="string"> Federated MySQL storage engine                                 </span>|<span class="string"> NULL         </span>|<span class="string"> NULL </span>|<span class="string"> NULL       </span>|</div><div class="line">+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#主从数据库同步注意点</span></div><div class="line">[mysqld]</div><div class="line"><span class="comment">#主从之间的id不能相同</span></div><div class="line">server-id</div><div class="line"><span class="comment">#启用二进制日志</span></div><div class="line">log-bin</div><div class="line"><span class="comment">#一般在从库开启（可选）</span></div><div class="line">read_only</div><div class="line"><span class="comment">#推荐使用InnoDB并做好相关配置</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#检查主从数据库状态</span></div><div class="line">mysql -S /tmp/mysql.sock -e <span class="string">"show global variables like 'server_id';"</span></div><div class="line">+---------------+-------+</div><div class="line">|<span class="string"> Variable_name </span>|<span class="string"> Value </span>|</div><div class="line">+---------------+-------+</div><div class="line">|<span class="string"> server_id     </span>|<span class="string"> 1     </span>|</div><div class="line">+---------------+-------+</div><div class="line"></div><div class="line">mysql -S /tmp/mysql.sock -e <span class="string">"show global variables like 'log_bin';"</span></div><div class="line">+---------------+-------+</div><div class="line">|<span class="string"> Variable_name </span>|<span class="string"> Value </span>|</div><div class="line">+---------------+-------+</div><div class="line">|<span class="string"> log_bin       </span>|<span class="string"> ON    </span>|</div><div class="line">+---------------+-------+</div></pre></td></tr></table></figure>
<h4 id="安装percona-xtrabackup"><a href="#安装percona-xtrabackup" class="headerlink" title="安装percona-xtrabackup"></a>安装percona-xtrabackup</h4><p>一般推荐rpm安装 - <a href="https://www.percona.com/downloads/XtraBackup/LATEST/" target="_blank" rel="external">https://www.percona.com/downloads/XtraBackup/LATEST/</a><br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">yum</span> <span class="selector-tag">-y</span> <span class="selector-tag">install</span> <span class="selector-tag">perl</span> <span class="selector-tag">perl-devel</span> <span class="selector-tag">libaio</span> <span class="selector-tag">libaio-devel</span> <span class="selector-tag">perl-Time-HiRes</span> <span class="selector-tag">perl-DBD-MySQL</span></div><div class="line"><span class="selector-id">#rpm</span> <span class="selector-tag">-ivh</span> <span class="selector-tag">percona-xtrabackup-2</span><span class="selector-class">.2</span><span class="selector-class">.12-1</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span><span class="selector-class">.rpm</span> </div><div class="line"><span class="selector-tag">rpm</span> <span class="selector-tag">-Uvh</span> <span class="selector-tag">percona-xtrabackup-2</span><span class="selector-class">.2</span><span class="selector-class">.12-1</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span><span class="selector-class">.rpm</span></div></pre></td></tr></table></figure></p>
<h4 id="备份和恢复"><a href="#备份和恢复" class="headerlink" title="备份和恢复"></a>备份和恢复</h4><p>通常一般都直接使用innobackupex，因为它能同时备份InnoDB和MyISAM引擎的表 重点关注Slave_IO_Running和Slave_SQL_Runningd的状态是否为YES.<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#备份</span></div><div class="line"><span class="string">innobackupex </span><span class="built_in">--socket=/usr/local/var/mysql2/mysql2.sock</span> <span class="built_in">--user=root</span> <span class="built_in">--password</span> <span class="built_in">--defaults-file=/etc/mysqld_multi.cnf</span> <span class="built_in">--parallel=4</span> <span class="built_in">--database=passport</span> /<span class="string">tmp/</span><span class="string">backup</span></div><div class="line"><span class="comment">#保持事务一致性</span></div><div class="line"><span class="string">innobackupex </span><span class="built_in">--socket=/usr/local/var/mysql2/mysql2.sock</span> <span class="built_in">--user=root</span> <span class="built_in">--password</span> <span class="built_in">--defaults-file=/etc/mysqld_multi.cnf</span> <span class="built_in">--database=passport</span> <span class="built_in">--apply-log</span> /<span class="string">tmp/</span><span class="string">backup/</span><span class="string">2015-08-</span><span class="string">05_16-08-</span><span class="string">14</span></div><div class="line"><span class="comment">#传输</span></div><div class="line"><span class="string">scp </span>-r /<span class="string">tmp/</span><span class="string">backup/</span><span class="string">2015-08-</span><span class="string">05_16-08-</span><span class="string">14 </span><span class="string">10.</span><span class="string">10.</span><span class="string">16.</span><span class="string">24:</span>/<span class="string">tmp/</span><span class="string">backup/</span> </div><div class="line"><span class="comment">#恢复</span></div><div class="line"><span class="string">innobackupex </span><span class="built_in">--socket=/tmp/mysql.sock</span> <span class="built_in">--user=root</span> <span class="built_in">--password</span> <span class="built_in">--defaults-file=/app/local/mysql/my.cnf</span> <span class="built_in">--copy-back</span> /<span class="string">tmp/</span><span class="string">backup/</span><span class="string">2015-08-</span><span class="string">05_16-08-</span><span class="string">14/</span></div><div class="line"><span class="comment">#还原权限</span></div><div class="line"><span class="string">chown </span>-R <span class="string">mysql:mysql </span>/<span class="string">app/</span><span class="string">data/</span><span class="string">mysql/</span><span class="string">data</span></div><div class="line"><span class="string">service </span><span class="string">mysqld </span><span class="string">start</span></div><div class="line">/<span class="string">app/</span><span class="string">local/</span><span class="string">mysql/</span><span class="string">scripts/</span><span class="string">mysql_install_db </span><span class="built_in">--basedir=/app/local/mysql</span> <span class="built_in">--datadir=/app/data/mysql/data</span> <span class="built_in">--no-defaults</span> <span class="built_in">--skip-name-resolve</span> <span class="built_in">--user=mysql</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#主库授权同步帐号</span></div><div class="line"><span class="string">SELECT </span><span class="string">DISTINCT </span><span class="string">CONCAT(</span><span class="string">'User: '</span><span class="string">''</span>,<span class="string">user,</span><span class="string">''</span><span class="string">'@'</span><span class="string">''</span>,<span class="string">host,</span><span class="string">''</span><span class="string">';'</span>) <span class="string">AS </span><span class="string">query </span><span class="string">FROM </span><span class="string">mysql.</span><span class="string">user;</span></div><div class="line"><span class="string">GRANT </span><span class="string">REPLICATION </span><span class="string">SLAVE </span><span class="string">ON </span>*.* <span class="string">TO </span><span class="string">'slave_passport'</span>@<span class="string">'10.10.16.24'</span> <span class="string">IDENTIFIED </span><span class="string">BY </span><span class="string">'slave_passport'</span>;</div><div class="line"><span class="string">FLUSH </span><span class="string">PRIVILEGES;</span></div><div class="line"></div><div class="line"><span class="comment">#从库开启同步</span></div><div class="line"><span class="string">cat </span>/<span class="string">tmp/</span><span class="string">backup/</span><span class="string">2015-08-</span><span class="string">05_16-08-</span><span class="string">14/</span><span class="string">xtrabackup_binlog_info </span></div><div class="line"><span class="string">mysql-bin.</span><span class="string">002599 </span>   <span class="string">804497686</span></div><div class="line"></div><div class="line"><span class="string">CHANGE </span><span class="string">MASTER </span><span class="string">TO</span></div><div class="line"><span class="string">MASTER_HOST=</span><span class="string">'10.10.16.51'</span>,</div><div class="line"><span class="string">MASTER_USER=</span><span class="string">'slave_passport'</span>,</div><div class="line"><span class="string">MASTER_PASSWORD=</span><span class="string">'slave_passport'</span>,</div><div class="line"><span class="string">MASTER_PORT=</span><span class="string">3307,</span></div><div class="line"><span class="string">MASTER_LOG_FILE=</span><span class="string">'mysql-bin.002599'</span>,</div><div class="line"><span class="string">MASTER_LOG_POS=</span><span class="string">804497686;</span></div><div class="line"></div><div class="line"><span class="comment">#开启主从同步</span></div><div class="line"><span class="string">start </span><span class="string">slave;</span></div><div class="line"><span class="comment">#查看从库状态</span></div><div class="line"><span class="string">show </span><span class="string">slave </span><span class="string">status\</span> G</div><div class="line"><span class="comment">#从库的检查参数</span></div><div class="line"><span class="string">Slave_IO_Running=</span><span class="string">Yes</span></div><div class="line"><span class="string">Slave_SQL_Running=</span><span class="string">Yes</span></div><div class="line"></div><div class="line"><span class="comment">#主库的检查参数</span></div><div class="line"><span class="string">show </span><span class="string">master </span><span class="string">status </span>\G</div><div class="line"></div><div class="line">+------------------+-----------+--------------+------------------+</div><div class="line">| <span class="string">File </span>            | <span class="string">Position </span> | <span class="string">Binlog_Do_DB </span>| <span class="string">Binlog_Ignore_DB </span>|</div><div class="line">+------------------+-----------+--------------+------------------+</div><div class="line">| <span class="string">mysql-bin.</span><span class="string">002600 </span>| <span class="string">454769337 </span>|              |                  |</div><div class="line">+------------------+-----------+--------------+------------------+</div><div class="line">1 <span class="string">row </span><span class="string">in </span><span class="string">set </span>(0.<span class="string">00 </span><span class="string">sec)</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="string">show </span><span class="string">processlist;</span></div><div class="line"></div><div class="line"><span class="string">Master </span><span class="string">has </span><span class="string">sent </span><span class="string">all </span><span class="string">binlog </span><span class="string">to </span><span class="string">slave;</span> <span class="string">waiting </span><span class="string">for </span><span class="string">binlog </span><span class="string">to </span><span class="string">be </span><span class="string">updated</span></div></pre></td></tr></table></figure></p>
<h4 id="MySQL主从切换"><a href="#MySQL主从切换" class="headerlink" title="MySQL主从切换"></a>MySQL主从切换</h4><p>切换前断开主库访问连接观察进程状态，无写操作后再停止从库IO_THREAD进行切换</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#查看主库状态</span></div><div class="line">show processlist;</div><div class="line"><span class="keyword">Master</span> <span class="title">has</span> sent all binlog to <span class="literal">slave</span>; waiting for binlog to be updated</div><div class="line">show <span class="keyword">master</span> <span class="title">status</span> \G</div><div class="line"></div><div class="line"><span class="comment">#从库停止 IO_THREAD 线程</span></div><div class="line"><span class="literal">stop</span> <span class="literal">slave</span> IO_THREAD;</div><div class="line">show processlist;</div><div class="line"><span class="literal">Slave</span> has <span class="keyword">read</span> all relay log; waiting for the <span class="literal">slave</span> I/O thread to update it</div><div class="line">show <span class="literal">slave</span> status \G</div><div class="line"></div><div class="line"><span class="comment">#从库切换为主库</span></div><div class="line"><span class="literal">stop</span> <span class="literal">slave</span>;</div><div class="line">reset <span class="literal">master</span>;</div><div class="line">reset <span class="literal">slave</span> all;</div><div class="line">show <span class="keyword">master</span> <span class="title">status</span> \G</div><div class="line"></div><div class="line"><span class="comment">#激活帐户</span></div><div class="line">SELECT DISTINCT CONCAT('User: ''',user,'''@''',host,''';') AS query FROM mysql.user;</div><div class="line">GRANT REPLICATION <span class="literal">SLAVE</span> ON *.* TO 'slave_passport'@'<span class="number">10.10</span>.<span class="number">16.51</span>' IDENTIFIED BY 'slave_passport';</div><div class="line">FLUSH PRIVILEGES;</div><div class="line"></div><div class="line"><span class="comment">#切换原有主库为从库</span></div><div class="line">reset <span class="literal">master</span>;</div><div class="line">reset <span class="literal">slave</span> all;</div><div class="line"></div><div class="line">CHANGE <span class="keyword">MASTER</span> <span class="title">TO</span></div><div class="line"><span class="attr">MASTER_HOST=</span>'<span class="number">10.10</span>.<span class="number">16.24</span>',</div><div class="line"><span class="attr">MASTER_USER=</span>'slave_passport',</div><div class="line"><span class="attr">MASTER_PASSWORD=</span>'slave_passport',</div><div class="line"><span class="attr">MASTER_PORT=</span><span class="number">3306</span>,</div><div class="line"><span class="attr">MASTER_LOG_FILE=</span>'mysql-bin.<span class="number">000001</span>',</div><div class="line"><span class="attr">MASTER_LOG_POS=</span><span class="number">804497686</span>;</div><div class="line"></div><div class="line"><span class="comment">#检查主库</span></div><div class="line">SHOW PROCESSLIST;</div><div class="line">show <span class="keyword">master</span> <span class="title">status</span> \G</div><div class="line"></div><div class="line"><span class="comment">#启动从库</span></div><div class="line">SHOW PROCESSLIST;</div><div class="line"><span class="literal">start</span> <span class="literal">slave</span>;</div><div class="line">show <span class="literal">slave</span> status \G</div></pre></td></tr></table></figure>
<h4 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">Slave_SQL_Running:</span><span class="literal">No</span></div></pre></td></tr></table></figure>
<p>一般是事务回滚造成的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">stop</span> <span class="keyword">slave</span>;</div><div class="line"><span class="keyword">set</span> <span class="keyword">GLOBAL</span> SQL_SLAVE_SKIP_COUNTER=<span class="number">1</span>;</div><div class="line"><span class="keyword">start</span> <span class="keyword">slave</span>;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://segmentfault.com/image?src=//i.v2ex.co/02ftb7pa.jpeg&amp;amp;objectId=1190000003063874&amp;amp;token=84a6c16fc60173037b58ca5da8
    
    </summary>
    
    
      <category term="mysql" scheme="http://yoursite.com/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql主从配置</title>
    <link href="http://yoursite.com/2017/03/23/17032301/"/>
    <id>http://yoursite.com/2017/03/23/17032301/</id>
    <published>2017-03-22T16:40:53.000Z</published>
    <updated>2017-03-23T10:13:03.967Z</updated>
    
    <content type="html"><![CDATA[<p>MySQL Replication 又叫做AB复制或者主从复制。它主要用于MySQL的时时备份或者读写分离。在配置之前先做一下准备工作，配置两台mysql服务器，或者在一台服务器上配置两个端口也可以。这里的的实验中就是在一台服务器上跑了两个mysql。</p>
<p>原理：MySQL的Replication是一个异步的复制过程，从一个MySQL实例(Master)复制到另一台MySQL实例上。在Master和Slave之间复制的整个过程主要由3个线程完成，其中两个线程（SQL线程和IO线程）在Slave端，另外一个线程(IO线程)在Master端。</p>
<p>要实现主从复制，首先要在Master端打开Binary Log功能。因为整个复制过程实际上就是Slave从Master上获取二进制日志，然后在自己身上完全按照产生的顺序一次执行日志中记录的各种操作的过程。</p>
<p>复制的具体过程如下：<br><img src="http://i.imgur.com/00V0oox.jpg" alt=""></p>
<ol>
<li>Slave的IO线程连上Master，并请求日志文件指定位置(或从开始的日志)之后的日志的内容。</li>
<li>Master接收到来自Slave的IO线程请求后，负责复制IO线程根据请求的信息读取指定日志之后的日志信息，返回给Slave端的IO线程。返回信息中除了日志所包含的信息，还包含了包括本次返回的信息在Master端的Binary Log文件的名称和位置。</li>
<li>Slave的IO线程接受到信息后，将日志内容一次写入Slave端的Relay Log文件(mysql-relay-bin.xxxx)的末端，并将读取到的Master端的bin-log的文件和位置记录到master-info文件中，以便在下一次读取时能够清楚地告诉Master，下次从bin-log哪个位置开始往后的日志内容。</li>
<li>Log中更新内容后，会马上解析该Log文件中的内容，还原成在Master端真实执行时的可执行的SQL语句，并执行这些SQK语句。实际上Master和Slave执行同样的语句。</li>
</ol>
<h4 id="1-配置mysql服务"><a href="#1-配置mysql服务" class="headerlink" title="1. 配置mysql服务"></a>1. 配置mysql服务</h4><p>MySql的安装和配置请看 <a href="http://note.youdao.com/noteshare?id=422b6e3979605208435c7b47862d072e&amp;sub=74A86154E4AC44F5B4B46218100AB0FE" target="_blank" rel="external">Mysql 安装</a><br>按照上面的步骤，你可以成功搭建好一个mysql，跑的是3306端口，下面我们搭建第二个mysql，指定的端口为：3307：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</div><div class="line">cp -r mysql mysql_slave</div><div class="line"><span class="built_in">cd</span> mysql_2</div><div class="line">./scripts/mysql_install_db --user=mysql --datadir=/data/mysql_slave</div></pre></td></tr></table></figure></p>
<p>最后一步是初始化数据库目录，如果出现两个“OK”并且生成/data/mysql2目录才正确，否则请仔细查看错误信息.<br>拷贝配置文件到mysql_2下，并修改相关项目:<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cp</span> /etc/my.<span class="keyword">cnf</span>  ./my.<span class="keyword">cnf</span></div><div class="line"><span class="keyword">vim</span> my.<span class="keyword">cnf</span></div></pre></td></tr></table></figure></p>
<p>把<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">port</span>          = <span class="number">3306</span></div><div class="line"><span class="attr">socket</span>        = /tmp/mysql.sock</div></pre></td></tr></table></figure></p>
<p>改为： 并增加一行<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">port</span>          = <span class="number">3307</span></div><div class="line"><span class="attr">socket</span>        = /tmp/mysql_slave.sock</div><div class="line"><span class="attr">datadir</span>         = /data/mysql_slave</div></pre></td></tr></table></figure></p>
<p>拷贝编辑启动脚本：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cp <span class="regexp">/etc/i</span>nit.d<span class="regexp">/mysqld /</span>etc<span class="regexp">/init.d/my</span>sqldslave</div><div class="line">vim <span class="regexp">/etc/i</span>nit.d<span class="regexp">/mysqldslave</span></div></pre></td></tr></table></figure></p>
<p>需要修改的部分，修改后为：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">basedir</span>=/usr/local/mysql_slave</div><div class="line"><span class="attr">datadir</span>=/data/mysql_slave</div><div class="line"><span class="attr">conf</span>=<span class="variable">$basedir</span>/my.cnf</div></pre></td></tr></table></figure>
<p>之后启动即可。</p>
<p>至此，在一台机器上已经启动了两个mysql：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">netstat -lnp |grep mysqld</div><div class="line">tcp       <span class="number"> 0 </span>    <span class="number"> 0 </span>0.0.0.0:3306                0.0.0.0:*                   LISTEN      7217/mysqld         </div><div class="line">tcp       <span class="number"> 0 </span>    <span class="number"> 0 </span>0.0.0.0:3307                0.0.0.0:*                   LISTEN      7469/mysqld         </div><div class="line">unix <span class="number"> 2 </span>     [ ACC ]     STREAM     LISTENING    <span class="number"> 42591 </span> 7217/mysqld         /tmp/mysql.sock</div><div class="line">unix <span class="number"> 2 </span>     [ ACC ]     STREAM     LISTENING    <span class="number"> 48423 </span> 7469/mysqld         /tmp/mysql_slave.sock</div></pre></td></tr></table></figure>
<h4 id="2-配置主从准备工作"><a href="#2-配置主从准备工作" class="headerlink" title="2. 配置主从准备工作"></a>2. 配置主从准备工作</h4><p>这里我们打算把3306端口的mysql作为主(master)，而把3307的mysql作为从(slave). 为了让实验更加像生产环境，所以在master上创建一个库db1，并且把mysql的库数据复制给它:<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -S /tmp/mysql.sock</div><div class="line"></div><div class="line">mysql&gt; create database db1;</div><div class="line">Query OK, <span class="number">1</span> <span class="built_in">row</span> affected (<span class="number">0.06</span> <span class="built_in">sec</span>)</div><div class="line"></div><div class="line">mysql&gt; <span class="built_in">quit</span></div><div class="line">Bye</div></pre></td></tr></table></figure></p>
<p>-S 后面指定mysql的socket文件路径，这也是登陆mysql的一种方法，因为在一台服务器上跑了两个mysql端口，所以，只能用 -S 这样的方法来区分。首先创建了db1库，然后把mysql库的数据复制给它:<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">mysqldump -uroot -S /tmp/mysql.sock mysql &gt; 123.sql</div><div class="line">mysql -uroot -S /tmp/mysql.sock db1 <span class="variable">&lt; 123.sql</span></div><div class="line"></div><div class="line">//进入mysql后可以看到：</div><div class="line"></div><div class="line">mysql&gt; use db1;</div><div class="line">Database changed</div><div class="line">mysql&gt; show tables;</div><div class="line">+---------------------------+</div><div class="line">|<span class="string"> Tables_in_db1             </span>|</div><div class="line">+---------------------------+</div><div class="line">|<span class="string"> columns_priv              </span>|</div><div class="line">|<span class="string"> db                        </span>|</div><div class="line">|<span class="string"> event                     </span>|</div><div class="line">|<span class="string"> func                      </span>|</div><div class="line">|<span class="string"> general_log               </span>|</div><div class="line">|<span class="string"> help_category             </span>|</div><div class="line">|<span class="string"> help_keyword              </span>|</div><div class="line">|<span class="string"> help_relation             </span>|</div><div class="line">|<span class="string"> help_topic                </span>|</div><div class="line">|<span class="string"> host                      </span>|</div><div class="line">|<span class="string"> ndb_binlog_index          </span>|</div><div class="line">|<span class="string"> plugin                    </span>|</div><div class="line">|<span class="string"> proc                      </span>|</div><div class="line">|<span class="string"> procs_priv                </span>|</div><div class="line">|<span class="string"> servers                   </span>|</div><div class="line">|<span class="string"> slow_log                  </span>|</div><div class="line">|<span class="string"> tables_priv               </span>|</div><div class="line">|<span class="string"> time_zone                 </span>|</div><div class="line">|<span class="string"> time_zone_leap_second     </span>|</div><div class="line">|<span class="string"> time_zone_name            </span>|</div><div class="line">|<span class="string"> time_zone_transition      </span>|</div><div class="line">|<span class="string"> time_zone_transition_type </span>|</div><div class="line">|<span class="string"> user                      </span>|</div><div class="line">+---------------------------+</div><div class="line">23 rows in set (0.00 sec)</div></pre></td></tr></table></figure></p>
<h4 id="3-配置主（master）"><a href="#3-配置主（master）" class="headerlink" title="3. 配置主（master）"></a>3. 配置主（master）</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vim</span> /etc/my.<span class="keyword">cnf</span></div></pre></td></tr></table></figure>
<p>在[mysqld]部分查看是否有以下内容，如果没有则添加:<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server-id</span>=<span class="number">1</span></div><div class="line"><span class="attr">log-bin</span>=keso</div></pre></td></tr></table></figure></p>
<p>除了这两行是必须的外，还有两个参数，你可以选择性（2选1）的使用:<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">binlog-do-db</span>=databasename1,databasename2 #用来指定需要同步的库</div><div class="line"><span class="attr">binlog-ignore-db</span>=databasename1,databasename2 #用来指定忽略不同步的库</div></pre></td></tr></table></figure></p>
<p>完成后重启mysqld服务。然后进入主mysql并授权给从一个用来同步数据的用户 repl</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">mysql&gt; grant replication slave on <span class="strong">*.*</span> to <span class="emphasis">'repl'</span>@<span class="emphasis">'127.0.0.1'</span> identified by <span class="emphasis">'111111'</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; flush privileges;</div><div class="line">Query OK, 0 rows affected (0.00 sec) #刷新MySQL的系统权限相关表</div><div class="line"></div><div class="line">mysql&gt; flush tables with read lock;</div><div class="line">Query OK, 0 rows affected (0.00 sec) #锁定数据库，此时不允许更改任何数据</div><div class="line"></div><div class="line"><span class="section"> show master status; #查看状态，这些数据是要记录的，一会要在slave端用到</span></div><div class="line">+-------------+----------+--------------+------------------+</div><div class="line"><span class="section">| File        | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span></div><div class="line">+-------------+----------+--------------+------------------+</div><div class="line"><span class="section">| keso.000001 |      331 |              |                  |</span></div><div class="line">+-------------+----------+--------------+------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<h4 id="4-配置从（slave）"><a href="#4-配置从（slave）" class="headerlink" title="4. 配置从（slave）"></a>4. 配置从（slave）</h4><p>先修改slave的配置文件my.cnf:<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim /usr/<span class="keyword">local</span>/mysql_slave/<span class="keyword">my</span>.cnf</div></pre></td></tr></table></figure></p>
<p>修改<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">server-<span class="built_in">id</span> = <span class="number">2</span> <span class="comment">#可以是出1意外的其他任何数字</span></div></pre></td></tr></table></figure></p>
<p>总之不能让这个id和master一样，否则会报错。另外在从上，你也可以选择性的增加如下两行，意义同主的那两个可选参数，如果在主上已经定义过了，那么在从上就不用再定义了。<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">replicate-do-db</span>=databasename1,databasename2</div><div class="line"><span class="attr">replicate-ignore-db</span>=databasename1,databasename2</div></pre></td></tr></table></figure></p>
<p>改完后，重启slave:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/etc/i</span>nit.d<span class="regexp">/mysqldslave restart</span></div></pre></td></tr></table></figure></p>
<p>拷贝master上的db1库的数据到slave上，因为master和slave都在一台服务器上，所以操作起来简单了很多，如果是不同的机器，可能就需要远程拷贝了，希望你注意这一点:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql -S /tmp/mysql_slave<span class="selector-class">.sock</span> -e <span class="string">"create database db1"</span></div><div class="line">mysql -S /tmp/mysql_slave<span class="selector-class">.sock</span> db1&lt;<span class="number">123</span>.sql</div></pre></td></tr></table></figure></p>
<p>登录从，并执行如下命令：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="string">mysql</span> <span class="bullet">-S</span> <span class="string">/tmp/mysql_slave.sock</span> </div><div class="line"></div><div class="line"><span class="string">mysql&gt;</span> <span class="string">slave</span> <span class="string">stop</span> <span class="string">;</span></div><div class="line"><span class="string">Query</span> <span class="string">OK,</span> <span class="number">0</span> <span class="string">rows</span> <span class="string">affected,</span> <span class="number">1</span> <span class="string">warning</span> <span class="string">(0.00</span> <span class="string">sec)</span></div><div class="line"></div><div class="line"><span class="string">mysql&gt;</span> <span class="string">change</span> <span class="string">master</span> <span class="string">to</span> <span class="string">master_host='127.0.0.1',</span> <span class="string">master_port=3306,master_user='repl',</span> <span class="string">master_password='111111',master_log_file='keso.000001',</span> <span class="string">master_log_pos=331;</span> </div><div class="line"><span class="string">Query</span> <span class="string">OK,</span> <span class="number">0</span> <span class="string">rows</span> <span class="string">affected</span> <span class="string">(0.00</span> <span class="string">sec)</span></div><div class="line"></div><div class="line"><span class="string">mysql&gt;</span> <span class="string">slave</span> <span class="string">start;</span></div><div class="line"><span class="string">Query</span> <span class="string">OK,</span> <span class="number">0</span> <span class="string">rows</span> <span class="string">affected</span> <span class="string">(0.03</span> <span class="string">sec)</span></div><div class="line"></div><div class="line"><span class="string">mysql&gt;</span> <span class="string">show</span> <span class="string">slave</span> <span class="string">status\G</span></div><div class="line"><span class="string">***************************</span> <span class="number">1.</span> <span class="string">row</span> <span class="string">***************************</span></div><div class="line"><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></div><div class="line"><span class="attr">                  Master_Host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></div><div class="line"><span class="attr">                  Master_User:</span> <span class="string">repl</span></div><div class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></div><div class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></div><div class="line"><span class="attr">              Master_Log_File:</span> <span class="string">keso.000001</span></div><div class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">331</span></div><div class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">KesoLinux-relay-bin.000002</span></div><div class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">246</span></div><div class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">keso.000001</span></div><div class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></div><div class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></div><div class="line"><span class="attr">              Replicate_Do_DB:</span> </div><div class="line"><span class="attr">          Replicate_Ignore_DB:</span> </div><div class="line"><span class="attr">           Replicate_Do_Table:</span> </div><div class="line"><span class="attr">       Replicate_Ignore_Table:</span> </div><div class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </div><div class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </div><div class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></div><div class="line"><span class="attr">                   Last_Error:</span> </div><div class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></div><div class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">331</span></div><div class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">405</span></div><div class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></div><div class="line"><span class="attr">               Until_Log_File:</span> </div><div class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></div><div class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></div><div class="line"><span class="attr">           Master_SSL_CA_File:</span> </div><div class="line"><span class="attr">           Master_SSL_CA_Path:</span> </div><div class="line"><span class="attr">              Master_SSL_Cert:</span> </div><div class="line"><span class="attr">            Master_SSL_Cipher:</span> </div><div class="line"><span class="attr">               Master_SSL_Key:</span> </div><div class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></div><div class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></div><div class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></div><div class="line"><span class="attr">                Last_IO_Error:</span> </div><div class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></div><div class="line"><span class="attr">               Last_SQL_Error:</span> </div><div class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></div></pre></td></tr></table></figure></p>
<p>确认Slave_IO_Running和Slave_SQL_Running 同时为yes时，才算正常。</p>
<h4 id="5-测试主从"><a href="#5-测试主从" class="headerlink" title="5. 测试主从"></a>5. 测试主从</h4><p>在master上执行如下命令:<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="section">select count(*) from db; </span></div><div class="line">+----------+</div><div class="line"><span class="section">| count(*) |</span></div><div class="line">+----------+</div><div class="line"><span class="section">|        2 |</span></div><div class="line">+----------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; truncate table db;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure></p>
<p>这样清空了db1.db表的数据，下面查看slave上的该表数据:<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="section">elect count(*) from db；</span></div><div class="line">+----------+</div><div class="line"><span class="section">| count(*) |</span></div><div class="line">+----------+</div><div class="line"><span class="section">|        0 |</span></div><div class="line">+----------+</div></pre></td></tr></table></figure></p>
<p>slave上的该表也被清空了。这样好像不太明显，不妨继续把db表删除试试:<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">db</span>；</div></pre></td></tr></table></figure></p>
<p>在slave上可以再使用select是可以看到：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">select count(*) from db"</div><div class="line"><span class="keyword">ERROR </span>1146 (42S02) at line 1: Table 'db1.db' doesn't exist</div></pre></td></tr></table></figure></p>
<p>主从配置起来很简单，但是这种机制也是非常脆弱的，一旦我们不小心在从上写了数据，那么主从也就被破坏了。另外如果重启master，务必要先把slave停掉，也就是说需要在slave上去执行 slave stop 命令，然后再去重启master的mysql服务，否则很有可能就会中断了。当然重启完后，还需要把slave给开启 slave start.</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;MySQL Replication 又叫做AB复制或者主从复制。它主要用于MySQL的时时备份或者读写分离。在配置之前先做一下准备工作，配置两台mysql服务器，或者在一台服务器上配置两个端口也可以。这里的的实验中就是在一台服务器上跑了两个mysql。&lt;/p&gt;
&lt;p&gt;原理：
    
    </summary>
    
    
      <category term="mysql" scheme="http://yoursite.com/tags/mysql/"/>
    
  </entry>
  
</feed>
